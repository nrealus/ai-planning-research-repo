
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../solver_state/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.8">
    
    
      
        <title>Solver main class - AI Planning Research Project</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.046329b4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra_style.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#src.solver.solver-attributes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="AI Planning Research Project" class="md-header__button md-logo" aria-label="AI Planning Research Project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AI Planning Research Project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Solver main class
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="AI Planning Research Project" class="md-nav__button md-logo" aria-label="AI Planning Research Project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    AI Planning Research Project
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aries-like Solver Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fundamentals
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../constraint_expressions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Constraint Expressions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" checked>
        
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Solver
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Solver
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../common/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Common
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../solver_state/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Solver State
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Solver main class
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Solver main class
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.solver.solver-attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.solver.solver-classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver" class="md-nav__link">
    Solver
  </a>
  
    <nav class="md-nav" aria-label="Solver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver-attributes" class="md-nav__link">
    Attributes
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.state" class="md-nav__link">
    state
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver-functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.choose_next_decision" class="md-nav__link">
    choose_next_decision()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.increment_one_decision_level" class="md-nav__link">
    increment_one_decision_level()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.backtrack_to_decision_level" class="md-nav__link">
    backtrack_to_decision_level()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.propagate" class="md-nav__link">
    propagate()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.explain_invalid_bound_update" class="md-nav__link">
    explain_invalid_bound_update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.refine_explanation" class="md-nav__link">
    refine_explanation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.get_decision_level_to_backtrack_to" class="md-nav__link">
    get_decision_level_to_backtrack_to()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.add_new_non_optional_variable" class="md-nav__link">
    add_new_non_optional_variable()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.add_new_optional_variable" class="md-nav__link">
    add_new_optional_variable()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.add_new_presence_variable" class="md-nav__link">
    add_new_presence_variable()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.add_constraint" class="md-nav__link">
    add_constraint()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.solver.solver-attributes" class="md-nav__link">
    Attributes
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.solver.solver-classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver" class="md-nav__link">
    Solver
  </a>
  
    <nav class="md-nav" aria-label="Solver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver-attributes" class="md-nav__link">
    Attributes
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.state" class="md-nav__link">
    state
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver-functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.choose_next_decision" class="md-nav__link">
    choose_next_decision()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.increment_one_decision_level" class="md-nav__link">
    increment_one_decision_level()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.backtrack_to_decision_level" class="md-nav__link">
    backtrack_to_decision_level()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.propagate" class="md-nav__link">
    propagate()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.explain_invalid_bound_update" class="md-nav__link">
    explain_invalid_bound_update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.refine_explanation" class="md-nav__link">
    refine_explanation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.get_decision_level_to_backtrack_to" class="md-nav__link">
    get_decision_level_to_backtrack_to()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.add_new_non_optional_variable" class="md-nav__link">
    add_new_non_optional_variable()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.add_new_optional_variable" class="md-nav__link">
    add_new_optional_variable()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.add_new_presence_variable" class="md-nav__link">
    add_new_presence_variable()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.solver.Solver.add_constraint" class="md-nav__link">
    add_constraint()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Solver main class</h1>

<div class="doc doc-object doc-module">




  <div class="doc doc-contents first">
  
      <p>TODO</p>

  

  <div class="doc doc-children">





<h3 id="src.solver.solver-attributes">Attributes</h3>
<h3 id="src.solver.solver-classes">Classes</h3>

<div class="doc doc-object doc-class">




<h4 id="src.solver.solver.Solver" class="doc doc-heading">
          <code>Solver</code>


</h4>


  <div class="doc doc-contents ">

  
      <p>The main solver class.</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/solver.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Solver</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main solver class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">:</span> <span class="n">SolverState</span> <span class="o">=</span> <span class="n">SolverState</span><span class="p">()</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># DECISION CHOICE</span>
    <span class="c1">#############################################################################</span>

    <span class="c1"># TODO</span>
    <span class="k">def</span> <span class="nf">choose_next_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decisions</span><span class="o">.</span><span class="n">AnyDecision</span><span class="p">:</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># DECISION LEVEL INCREMENTATION</span>
    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="nf">increment_one_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">reasoners</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Reasoner</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Increments the current decision level (by 1).</span>

<span class="sd">        Invokes all reasoners&#39; `on_solver_increment_decision_level` callbacks, which</span>
<span class="sd">        updates them internally to account for the decision level incrementation.</span>

<span class="sd">        Args:</span>
<span class="sd">            reasoners: The reasoners collaborating with the solver.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># assert self.curr_dec_lvl == 0 or len(self._events_trail[self.curr_dec_lvl]) &gt; 0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_dec_lvl</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_events_trail</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_events_trail</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="k">for</span> <span class="n">reasoner</span> <span class="ow">in</span> <span class="n">reasoners</span><span class="p">:</span>
            <span class="n">reasoner</span><span class="o">.</span><span class="n">on_solver_increment_one_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># BACKTRACKING</span>
    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="nf">_undo_and_return_latest_event_at_current_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Event</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reverts the last event (at the current decision level) by:</span>
<span class="sd">            - Popping it from the events trail</span>
<span class="sd">            - By updating the current and previous bound values, as well as</span>
<span class="sd">            the index of its corresponding event.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The event that was reverted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_events_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_bound_values</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">signed_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">previous_bound_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_bound_values_event_indices</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">signed_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">previous_index</span>

        <span class="k">return</span> <span class="n">ev</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">backtrack_to_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">target_decision_level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">reasoners</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Reasoner</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Backtracks to the target decision level by reverting all events at all</span>
<span class="sd">        decision levels strictly greater than the target one.</span>

<span class="sd">        Invokes the reasoners&#39; `on_solver_backtrack_one_level` callbacks, at</span>
<span class="sd">        each reverted decision level. This updates the reasoners internally to</span>
<span class="sd">        account for the backtracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_decision_level: The target decision level to backtrack to.</span>

<span class="sd">            reasoners: The reasoners collaborating with the solver.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the target decision level was strictly less than 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">target_decision_level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Target decision level must be &gt;= 0.&quot;</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span> <span class="o">&gt;</span> <span class="n">target_decision_level</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_undo_and_return_latest_event_at_current_decision_level</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_dec_lvl</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">reasoner</span> <span class="ow">in</span> <span class="n">reasoners</span><span class="p">:</span>
                <span class="n">reasoner</span><span class="o">.</span><span class="n">on_solver_backtrack_one_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># PROPAGATION</span>
    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">reasoners</span><span class="p">:</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Reasoner</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">,</span> <span class="n">Reasoner</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The propagation method of the solver.</span>

<span class="sd">        For all reasoners, propagates new events/changes. The propagation</span>
<span class="sd">        process stops either when no new bound update can be inferred (success),</span>
<span class="sd">        or when a contradiction is detected by one of the reasoners (failure).</span>

<span class="sd">        Args:</span>
<span class="sd">            reasoners: The reasoners collaborating with the solver.</span>

<span class="sd">        Returns:</span>
<span class="sd">            None if the propagation was successful, and a tuple if a conflict   \</span>
<span class="sd">            is encountered. The tuple is composed of information on the conflict\</span>
<span class="sd">            as well as the reasoner that encountered it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">num_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span>

            <span class="k">for</span> <span class="n">reasoner</span> <span class="ow">in</span> <span class="n">reasoners</span><span class="p">:</span>
                <span class="n">conflict_info</span> <span class="o">=</span> <span class="n">reasoner</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">conflict_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">conflict_info</span><span class="p">,</span> <span class="n">reasoner</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">num_events</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># CONFLICT ANALYSIS, EXPLANATION GENERATION</span>
    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="nf">_add_implying_literals_to_explanation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span>
        <span class="n">literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
        <span class="n">cause</span><span class="p">:</span> <span class="n">Causes</span><span class="o">.</span><span class="n">AnyCause</span><span class="p">,</span>
        <span class="n">explain_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">,</span> <span class="n">Solver</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a set of literals l_1, ..., l_n such that:</span>
<span class="sd">         - l_1 &amp; ... &amp; l_n =&gt; literal</span>
<span class="sd">         - each l_i is entailed at the current decision level.</span>
<span class="sd">        Places them in `explanation_literals`.</span>

<span class="sd">        Assumptions:</span>
<span class="sd">         - `literal` is not entailed in the current state</span>
<span class="sd">         - `cause` provides the explanation for asserting</span>
<span class="sd">            literal (and is not a decision)</span>

<span class="sd">        Args:</span>
<span class="sd">            explanation_literals: The list of literals making   \</span>
<span class="sd">                up the explanation. Modified by the method.</span>

<span class="sd">            literal: The literal whose implying literals we     \</span>
<span class="sd">                want to add to the explanation.</span>

<span class="sd">            cause: The cause for the event that lead to the     \</span>
<span class="sd">                contradiction that we&#39;re explaining.</span>

<span class="sd">            explain_function: The external function that may participate    \</span>
<span class="sd">                in building the explanation (basically the `explain`        \</span>
<span class="sd">                function of `Reasoner`)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># In this function, the literal shouldn&#39;t be true yet,</span>
        <span class="c1"># but it should be immediately implied.</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">literal</span><span class="p">)</span>

        <span class="k">match</span> <span class="n">cause</span><span class="p">:</span>

            <span class="k">case</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">():</span>
                <span class="c1"># Ask the reasoner for an explanation clause (l_1 &amp; ... &amp; l_n) =&gt; literal</span>
                <span class="n">explain_function</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">,</span> <span class="n">literal</span><span class="p">,</span> <span class="n">cause</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

            <span class="k">case</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ImplicationPropagation</span><span class="p">():</span>
                <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">literal</span><span class="p">)</span>

            <span class="k">case</span> <span class="n">Causes</span><span class="o">.</span><span class="n">EmptyDomain</span><span class="p">():</span>
                <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">literal</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>

                <span class="k">match</span> <span class="n">cause</span><span class="o">.</span><span class="n">cause</span><span class="p">:</span>

                    <span class="k">case</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">():</span>
                        <span class="c1"># Ask the reasoner for an explanation clause (l_1 &amp; ... &amp; l_n) =&gt; cause.literal</span>
                        <span class="n">explain_function</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">,</span> <span class="n">cause</span><span class="o">.</span><span class="n">literal</span><span class="p">,</span> <span class="n">cause</span><span class="o">.</span><span class="n">cause</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

                    <span class="k">case</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ImplicationPropagation</span><span class="p">():</span>
                        <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">cause</span><span class="o">.</span><span class="n">literal</span><span class="p">)</span>

                    <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="kc">False</span>

            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">explain_invalid_bound_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">invalid_bound_update_info</span><span class="p">:</span> <span class="n">InvalidBoundUpdateInfo</span><span class="p">,</span>
        <span class="n">explain_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">,</span> <span class="n">Solver</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConflictAnalysisResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an invalid bound update of a literal &#39;l&#39;,</span>
<span class="sd">        returns an asserting clause &#39;l_1&#39; &amp; ... &amp; &#39;l_n&#39; =&gt; not &#39;l_dec&#39; where:</span>
<span class="sd">         - the literals &#39;l_i&#39; are entailed at the previous decision level (of the current state)</span>
<span class="sd">         - the literal &#39;l_dec&#39; is the decisions that was taken at the current decision level</span>

<span class="sd">        The update of &#39;l&#39; must not directly originate from a decision,</span>
<span class="sd">        as it is necessarily the case that &#39;not l&#39; holds in the current</span>
<span class="sd">        state. It is thus considered a logic error to enforce an obviously</span>
<span class="sd">        wrong decision.</span>

<span class="sd">        Args:</span>
<span class="sd">            invalid_bound_update_info: The information about the conflict to explain.</span>

<span class="sd">            explain_function: The external function that may participate in building the explanation    \</span>
<span class="sd">                (basically the `explain` function of `Reasoner`)</span>

<span class="sd">        Returns:</span>
<span class="sd">            The results of conflict analysis.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Remember that an update is invalid iff its negation holds AND</span>
        <span class="c1"># the affected variable is present.</span>

        <span class="c1"># The base of the explanation is (&#39;not l&#39; v &#39;l&#39;)</span>
        <span class="n">explanation_starting_literals</span> <span class="o">=</span> <span class="p">[</span><span class="n">invalid_bound_update_info</span><span class="o">.</span><span class="n">literal</span><span class="o">.</span><span class="n">negated</span><span class="p">]</span>

        <span class="c1"># However &#39;l&#39; does not hold in the current state and it needs</span>
        <span class="c1"># to be replaced, with a set of literals &#39;l_1&#39; v ... v &#39;l_n&#39;,</span>
        <span class="c1"># such that &#39;l_1&#39; v ... v &#39;l_n&#39; =&gt; &#39;l&#39;. As such, the explanation</span>
        <span class="c1"># becomes &#39;not l&#39; v &#39;l_1&#39; v ... v &#39;l_n&#39;, and all its disjuncts</span>
        <span class="c1"># (&#39;not l&#39; and all &#39;l_i&#39;) hold in the current state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_implying_literals_to_explanation</span><span class="p">(</span><span class="n">explanation_starting_literals</span><span class="p">,</span>
                                                   <span class="n">invalid_bound_update_info</span><span class="o">.</span><span class="n">literal</span><span class="p">,</span>
                                                   <span class="n">invalid_bound_update_info</span><span class="o">.</span><span class="n">cause</span><span class="p">,</span>
                                                   <span class="n">explain_function</span><span class="p">)</span>

        <span class="c1"># The explanation clause &#39;not l&#39; v &#39;l_1&#39; v ... v &#39;l_n&#39; must now be </span>
        <span class="c1"># transformed into 1st Unique Implication Point form.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">refine_explanation</span><span class="p">(</span><span class="n">explanation_starting_literals</span><span class="p">,</span>
                                       <span class="n">explain_function</span><span class="p">)</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">refine_explanation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span>
        <span class="n">explain_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">,</span> <span class="n">Solver</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConflictAnalysisResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refines an explanation into an asserting clause.</span>

<span class="sd">        Args:</span>
<span class="sd">            explanation_literals: The list of literals making up the explanation.   \</span>
<span class="sd">                Modified by the method.</span>

<span class="sd">            explain_function: The external function that may participate in building the explanation    \</span>
<span class="sd">                (basically the `explain` function of `Reasoner`)</span>

<span class="sd">        Returns:</span>
<span class="sd">            The results of conflict analysis.</span>

<span class="sd">        Note:</span>
<span class="sd">            A partial backtrack (within the current decision level) will occur</span>
<span class="sd">            in this function. This is necessary to provide explainers (reasoners)</span>
<span class="sd">            with the exact state in which their decisions were made.</span>

<span class="sd">            However there is no need to &quot;synchronize&quot;/update the reasoners&#39; earliest</span>
<span class="sd">            unprocessed event index because of this partial backtracking. Indeed,</span>
<span class="sd">            right after this explanation is made/refined as part of conflict analysis,</span>
<span class="sd">            we will backtrack to an earlier decision level anyway. And during with</span>
<span class="sd">            that backtracking, the earliest unprocessed event index of each reasoner</span>
<span class="sd">            will be reset to 0 (at that decision level). As such, the partial backtracking</span>
<span class="sd">            that happens in this method doesn&#39;t cause any problem for reasoners.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Literals falsified at the current decision level,</span>
        <span class="c1"># we need to proceed until there is a single one left (1UIP).</span>
        <span class="c1"># The int is MINUS the index of the event (in the events trail)</span>
        <span class="c1"># where the literal was implied. It acts as the priority value</span>
        <span class="c1"># of the maxheap. But since the Python heapq is a minheap</span>
        <span class="c1"># and we want a maxheap, we need to invert the priority values...</span>

        <span class="n">prio_queue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">],</span> <span class="n">Lit</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heapify</span><span class="p">(</span><span class="n">prio_queue</span><span class="p">)</span>

        <span class="c1"># Literals that are beyond the current decision and</span>
        <span class="c1"># will be part of the final asserting clause.</span>
        <span class="n">asserting_clause_literals</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">resolved_literals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">lit</span> <span class="ow">in</span> <span class="n">explanation_literals</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">lit</span><span class="p">):</span>

                    <span class="n">first_entailing_ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">first_event_entailing</span><span class="p">(</span><span class="n">lit</span><span class="p">)</span>

                    <span class="c1"># If lit is implied at decision level 0, then it</span>
                    <span class="c1"># is always true. So we can discard it.</span>
                    <span class="k">if</span> <span class="n">first_entailing_ev</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">first_entailing_ev</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">ev_i_dl</span><span class="p">,</span> <span class="n">ev_i</span> <span class="o">=</span> <span class="n">first_entailing_ev</span><span class="o">.</span><span class="n">index</span>

                    <span class="c1"># If lit is implied at the current decision</span>
                    <span class="c1"># level, then add it to the queue.</span>
                    <span class="c1">#</span>
                    <span class="c1"># But if lit is implied at a decision level</span>
                    <span class="c1"># before the current one, then its negation</span>
                    <span class="c1"># will appear in the final clause (1UIP).</span>

                    <span class="k">if</span> <span class="n">ev_i_dl</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">:</span>
                        <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">prio_queue</span><span class="p">,</span> <span class="p">((</span><span class="o">-</span><span class="n">ev_i_dl</span><span class="p">,</span> <span class="o">-</span><span class="n">ev_i</span><span class="p">),</span> <span class="n">lit</span><span class="p">))</span>

                    <span class="k">elif</span> <span class="n">ev_i_dl</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">:</span>
                        <span class="n">asserting_clause_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="kc">False</span>

                <span class="c1"># If lit is is not entailed, it must have been added in</span>
                <span class="c1"># an eager propagation. Even if it was not necessary for</span>
                <span class="c1"># this propagation to occur, it must be part of the clause</span>
                <span class="c1"># for correctness.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">asserting_clause_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>

            <span class="c1"># If the queue is empty, it means that all literals in the clause</span>
            <span class="c1"># will be at decision levels earlier than the current decision level.</span>
            <span class="c1"># This can happen if we are at the top decision level, or if we</span>
            <span class="c1"># had a lazy propagator that didn&#39;t immediately detect the </span>
            <span class="c1"># inconsistency # NOTE: need to be better understand this.</span>
            <span class="c1">#</span>
            <span class="c1"># Corollary: if dl is 0, the derived clause must be empty.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prio_queue</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ConflictAnalysisResult</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">asserting_clause_literals</span><span class="p">),</span>
                                              <span class="n">resolved_literals</span><span class="p">)</span>

            <span class="c1"># At this point, we haven&#39;t reached the 1st UIP yet.</span>

            <span class="c1"># Select the latest falsified literal from the queue.</span>
            <span class="n">_prio_queue_head</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">prio_queue</span><span class="p">)</span>
            <span class="p">((</span><span class="n">ev_i_dl</span><span class="p">,</span> <span class="n">ev_i</span><span class="p">),</span> <span class="n">lit</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                      <span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># However, the queue might contain more than onen reference</span>
            <span class="c1"># to the same event. Because of the priority of the queue</span>
            <span class="c1"># (event indices), they are necessarily contiguous.</span>
            <span class="k">while</span> <span class="n">prio_queue</span><span class="p">:</span>
                <span class="n">_prio_queue_head</span> <span class="o">=</span> <span class="n">prio_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># peek</span>
                <span class="p">((</span><span class="n">next_dl</span><span class="p">,</span> <span class="n">next_ev_i</span><span class="p">),</span> <span class="n">next_lit</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                                    <span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="c1"># If the event is the same, pop it from the queue</span>
                <span class="c1"># and keep the most general one of them as &#39;lit&#39;.</span>
                <span class="c1"># (i.e. the one with the weaker bound value).</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">next_dl</span><span class="p">,</span> <span class="n">next_ev_i</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ev_i_dl</span><span class="p">,</span> <span class="n">ev_i</span><span class="p">):</span>
                    <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">prio_queue</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">lit</span><span class="o">.</span><span class="n">bound_value</span><span class="o">.</span><span class="n">is_stronger_than</span><span class="p">(</span><span class="n">next_lit</span><span class="o">.</span><span class="n">bound_value</span><span class="p">):</span>
                        <span class="n">lit</span> <span class="o">=</span> <span class="n">next_lit</span>
                <span class="c1"># If the event isn&#39;t the same, none of the remaining</span>
                <span class="c1"># ones will be either, because of the priority of the queue.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="c1"># If the queue is empty, we have reached the 1UIP.</span>
            <span class="c1"># The contents of asserting_clause_literals now corresponds</span>
            <span class="c1"># to a conjunction of literals that imply &#39;not lit&#39;.</span>
            <span class="c1"># Thus, to finish building the asserting clause, we just</span>
            <span class="c1"># need to add &#39;not lit&#39; to asserting_clause_literals.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prio_queue</span><span class="p">:</span>
                <span class="n">asserting_clause_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ConflictAnalysisResult</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">asserting_clause_literals</span><span class="p">),</span>
                                              <span class="n">resolved_literals</span><span class="p">)</span>

            <span class="c1"># Now, we need to until the latest falsifying event. This</span>
            <span class="c1"># will undo some of the changes, but we will remain in the</span>
            <span class="c1"># same decision level (see function description for the</span>
            <span class="c1"># reason behind this partial backtracking). Indeed, the event</span>
            <span class="c1"># cannot be a decision, because otherwise it would have been</span>
            <span class="c1"># detected as a UIP earlier.</span>

            <span class="n">cause</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Causes</span><span class="o">.</span><span class="n">AnyCause</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="n">ev_i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span><span class="p">:</span>
                <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_and_return_latest_event_at_current_decision_level</span><span class="p">()</span>
                <span class="n">cause</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">cause</span>

            <span class="k">assert</span> <span class="n">cause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">signed_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resolved_literals</span>
                <span class="ow">or</span> <span class="n">lit</span><span class="o">.</span><span class="n">bound_value</span><span class="o">.</span><span class="n">is_stronger_than</span><span class="p">(</span><span class="n">resolved_literals</span><span class="p">[</span><span class="n">lit</span><span class="o">.</span><span class="n">signed_var</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="n">resolved_literals</span><span class="p">[</span><span class="n">lit</span><span class="o">.</span><span class="n">signed_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">bound_value</span>                

            <span class="c1"># Add a set of literals whose conjunction implies lit to explanation_literals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_implying_literals_to_explanation</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">,</span>
                                                       <span class="n">lit</span><span class="p">,</span>
                                                       <span class="n">cause</span><span class="p">,</span>
                                                       <span class="n">explain_function</span><span class="p">)</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">get_decision_level_to_backtrack_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">asserting_clause_literals</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Lit</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Lit</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            A tuple consisting of the appropriate backtracking level for the \</span>
<span class="sd">                clause formed by the given clause literals, the literal that \</span>
<span class="sd">                is asserted at that level, and whether the clause is         \</span>
<span class="sd">                conflicting at the top decision level (which would prove     \</span>
<span class="sd">                unsatisfiability).</span>

<span class="sd">        Note:</span>
<span class="sd">            Normally, in the 1UIP backtracking scheme (1st Unique Implication Point),</span>
<span class="sd">            the decision level to backtrack to should be the largest one (i.e. &quot;closest&quot;</span>
<span class="sd">            to the conflict) at which the clause is unit. However, the explanation of</span>
<span class="sd">            eager propagation of optionals might generate explanations where some literals</span>
<span class="sd">            are not violated. These are ignored when determining the backtrack level.</span>

<span class="sd">            If there is more than one violated literal at that level, then no literal is</span>
<span class="sd">            asserted and the determined backtrack level is further decreased by 1. This might</span>
<span class="sd">            occur with clause sharing.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">max_dl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">next_max_dl</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">asserted_literal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Lit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">literal</span> <span class="ow">in</span> <span class="n">asserting_clause_literals</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">literal</span><span class="o">.</span><span class="n">negated</span><span class="o">.</span><span class="n">signed_var</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">is_stronger_than</span><span class="p">(</span><span class="n">literal</span><span class="o">.</span><span class="n">negated</span><span class="o">.</span><span class="n">bound_value</span><span class="p">)</span>
            <span class="p">):</span>

                <span class="n">first_entailing_ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">first_event_entailing</span><span class="p">(</span><span class="n">literal</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">first_entailing_ev</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">first_entailing_ev</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">dl</span> <span class="o">=</span> <span class="n">first_entailing_ev</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">dl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dl</span> <span class="o">&gt;</span> <span class="n">max_dl</span><span class="p">:</span>
                        <span class="n">next_max_dl</span> <span class="o">=</span> <span class="n">max_dl</span>
                        <span class="n">max_dl</span> <span class="o">=</span> <span class="n">dl</span>
                        <span class="n">asserted_literal</span> <span class="o">=</span> <span class="n">literal</span>
                    <span class="k">elif</span> <span class="n">dl</span> <span class="o">&gt;</span> <span class="n">next_max_dl</span><span class="p">:</span>
                        <span class="n">next_max_dl</span> <span class="o">=</span> <span class="n">dl</span>

        <span class="k">if</span> <span class="n">max_dl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">max_dl</span> <span class="o">==</span> <span class="n">next_max_dl</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_dl</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">next_max_dl</span><span class="p">,</span> <span class="n">asserted_literal</span><span class="p">)</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># VARIABLE ADDITION</span>
    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="nf">add_new_non_optional_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">initial_domain</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">controllable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new non-optional variable to the solver and returns it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_add_new_variable</span><span class="p">(</span><span class="n">initial_domain</span><span class="p">,</span> <span class="n">controllable</span><span class="p">,</span> <span class="n">TRUE_LIT</span><span class="p">)</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">add_new_optional_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">initial_domain</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">controllable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">presence_literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new optional variable to the solver and returns it.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_add_new_variable</span><span class="p">(</span><span class="n">initial_domain</span><span class="p">,</span> <span class="n">controllable</span><span class="p">,</span> <span class="n">presence_literal</span><span class="p">)</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">add_new_presence_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">scope_literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new presence variable, defined in the scope corresponding to</span>
<span class="sd">        the given scope literal, and returns it.</span>

<span class="sd">        A presence variable is simply a non-optional (boolean) variable</span>
<span class="sd">        which is used to define presence literals.</span>

<span class="sd">        A presence literal, is simply a literal on (the truth value of) a presence</span>
<span class="sd">        variable. They are encoded as [presence_variable &gt;= 1].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_new_non_optional_variable</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">lit</span> <span class="o">=</span> <span class="n">Lit</span><span class="o">.</span><span class="n">geq</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_register_new_scope</span><span class="p">((</span><span class="n">lit</span><span class="p">,),</span> <span class="n">lit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_register_implication_between_literals_on_non_optional_vars</span><span class="p">(</span><span class="n">lit</span><span class="p">,</span> <span class="n">scope_literal</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">var</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># CONSTRAINT ADDITION</span>
    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="nf">add_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">constr_expr</span><span class="p">:</span> <span class="n">ConstrExpr</span><span class="p">,</span>
        <span class="n">scope_as_conjunction</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Lit</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ElemConstrExpr</span><span class="p">,</span> <span class="n">Lit</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a constraint defined by the given high-level expression,</span>
<span class="sd">        in a scope defined by a conjunction of literals.</span>

<span class="sd">        In other words, we register the fact that the constraint will have to</span>
<span class="sd">        hold / be true / be satisfied iff all of the given literals are entailed.</span>

<span class="sd">        Internally, the high-level constraint expression is preprocessed into a</span>
<span class="sd">        low-level, &quot;elementary&quot; form. This elementary form could be defined with</span>
<span class="sd">        new literals, resulting from &quot;intermediary&quot; reification during the preprocessing.</span>

<span class="sd">        Then, this elementary form constraint is reified to an optional literal</span>
<span class="sd">        that is true iff the expression is valid/well-defined, and absent otherwise.</span>

<span class="sd">        Args:</span>
<span class="sd">            constr_expr: The high-level constraint expression defining the constraint to add.</span>
<span class="sd">            scope_as_conjunction: The literals whose conjunction defines the scope  \</span>
<span class="sd">                in which the constraint will have to hold.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A reified constraint, formed by the elementary form expression as well \</span>
<span class="sd">                as that optional literal (sometimes called the reification literal).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">elem_constr_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_constr_expr_into_elem_form</span><span class="p">(</span><span class="n">constr_expr</span><span class="p">)</span>

        <span class="n">scope_tautology_lit</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_get_or_make_tautology_of_scope</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_get_or_make_new_scope_lit_from_conjunction</span><span class="p">(</span><span class="n">scope_as_conjunction</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_add_elem_constraint</span><span class="p">(</span><span class="n">elem_constr_expr</span><span class="p">,</span> <span class="n">scope_tautology_lit</span><span class="p">)</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">_preprocess_constr_expr_into_elem_form</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">constr_expr</span><span class="p">:</span> <span class="n">ConstrExpr</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElemConstrExpr</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocesses a high-level constraint expression by decomposing it</span>
<span class="sd">        into a low-level elementary constraint expression.</span>

<span class="sd">        For equality and disequality constraints, it can be formed of</span>
<span class="sd">        new literals resulting from an &quot;intermediary&quot; reification.</span>

<span class="sd">        For example, an equality constraint expression is interpeted as two &quot;leq&quot;</span>
<span class="sd">        elementary constraint expressions, each of which corresponds to either</span>
<span class="sd">        single literal, or a &quot;max difference&quot; elementary constraint expression. </span>
<span class="sd">        Both of these elementary constraint expressions are then reified resulting</span>
<span class="sd">        in two reification literals. Finally, an &quot;AND&quot; elementary constraint</span>
<span class="sd">        expression combining these two reification literals is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">get_or_make_reification_of_elem_constr_expr</span><span class="p">(</span>
            <span class="n">elem_constr_expr</span><span class="p">:</span> <span class="n">ElemConstrExpr</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Lit</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">elem_constr_expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_reifications</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_reifications</span><span class="p">[</span><span class="n">elem_constr_expr</span><span class="p">]</span>

            <span class="n">scope_lit</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_get_or_make_new_scope_lit_from_conjunction</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_get_scope_as_conjunction</span><span class="p">(</span><span class="n">elem_constr_expr</span><span class="p">))</span>

            <span class="n">reif_lit</span> <span class="o">=</span> <span class="n">Lit</span><span class="o">.</span><span class="n">geq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_add_new_variable</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">scope_lit</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_reifications</span><span class="p">[</span><span class="n">elem_constr_expr</span><span class="p">]</span> <span class="o">=</span> <span class="n">reif_lit</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_reifications</span><span class="p">[</span><span class="n">elem_constr_expr</span><span class="o">.</span><span class="n">negated</span><span class="p">]</span> <span class="o">=</span> <span class="n">reif_lit</span><span class="o">.</span><span class="n">negated</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">elem_constr_expr</span><span class="p">,</span> <span class="n">reif_lit</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">reif_lit</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">preprocess_eq_int_atoms</span><span class="p">(</span>
            <span class="n">var_left</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span>
            <span class="n">offset_left</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
            <span class="n">var_right</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span>
            <span class="n">offset_right</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElemConstrExpr</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">var_left</span> <span class="o">==</span> <span class="n">var_right</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_lit</span><span class="p">(</span><span class="n">TRUE_LIT</span><span class="p">)</span>

            <span class="n">leq12_elem_form</span> <span class="o">=</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_int_atoms_leq</span><span class="p">(</span><span class="n">var_left</span><span class="p">,</span> <span class="n">offset_left</span><span class="p">,</span>
                                                                <span class="n">var_right</span><span class="p">,</span> <span class="n">offset_right</span><span class="p">)</span>
            <span class="n">leq21_elem_form</span> <span class="o">=</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_int_atoms_leq</span><span class="p">(</span><span class="n">var_right</span><span class="p">,</span> <span class="n">offset_right</span><span class="p">,</span>
                                                                <span class="n">var_left</span><span class="p">,</span> <span class="n">offset_left</span><span class="p">)</span>
            <span class="n">leq12_reif_lit</span> <span class="o">=</span> <span class="n">get_or_make_reification_of_elem_constr_expr</span><span class="p">(</span><span class="n">leq12_elem_form</span><span class="p">)</span>
            <span class="n">leq21_reif_lit</span> <span class="o">=</span> <span class="n">get_or_make_reification_of_elem_constr_expr</span><span class="p">(</span><span class="n">leq21_elem_form</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_lits_simplify_and</span><span class="p">((</span><span class="n">leq12_reif_lit</span><span class="p">,</span> <span class="n">leq21_reif_lit</span><span class="p">))</span>  <span class="c1"># FIXME: or of negs ?</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">preprocess_eq_bool_vars</span><span class="p">(</span>
            <span class="n">var1</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span>
            <span class="n">var2</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ElemConstrExpr</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">var1</span> <span class="o">==</span> <span class="n">var2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_lit</span><span class="p">(</span><span class="n">TRUE_LIT</span><span class="p">)</span>

            <span class="n">lit1</span> <span class="o">=</span> <span class="n">Lit</span><span class="o">.</span><span class="n">geq</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">lit2</span> <span class="o">=</span> <span class="n">Lit</span><span class="o">.</span><span class="n">geq</span><span class="p">(</span><span class="n">var2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">imply12_elem_form</span> <span class="o">=</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_lits_simplify_or</span><span class="p">((</span><span class="n">lit1</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span> <span class="n">lit2</span><span class="p">))</span>
            <span class="n">imply21_elem_form</span> <span class="o">=</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_lits_simplify_or</span><span class="p">((</span><span class="n">lit2</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span> <span class="n">lit1</span><span class="p">))</span>

            <span class="n">imply12_reif_lit</span> <span class="o">=</span> <span class="n">get_or_make_reification_of_elem_constr_expr</span><span class="p">(</span><span class="n">imply12_elem_form</span><span class="p">)</span>
            <span class="n">imply21_reif_lit</span> <span class="o">=</span> <span class="n">get_or_make_reification_of_elem_constr_expr</span><span class="p">(</span><span class="n">imply21_elem_form</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_lits_simplify_and</span><span class="p">((</span><span class="n">imply12_reif_lit</span><span class="p">,</span> <span class="n">imply21_reif_lit</span><span class="p">))</span>  <span class="c1"># FIXME: or of negs ?</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">match</span> <span class="n">constr_expr</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>

            <span class="k">case</span> <span class="p">((</span><span class="n">Var</span><span class="p">()</span> <span class="k">as</span> <span class="n">var_left</span><span class="p">,</span> <span class="nb">int</span><span class="p">()</span> <span class="k">as</span> <span class="n">offset_left</span><span class="p">),</span> 
                <span class="p">(</span><span class="n">Var</span><span class="p">()</span> <span class="k">as</span> <span class="n">var_right</span><span class="p">,</span> <span class="nb">int</span><span class="p">()</span> <span class="k">as</span> <span class="n">offset_right</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">match</span> <span class="n">constr_expr</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>

                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">LEQ</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_int_atoms_leq</span><span class="p">(</span><span class="n">var_left</span><span class="p">,</span> <span class="n">offset_left</span><span class="p">,</span>
                                                                 <span class="n">var_right</span><span class="p">,</span> <span class="n">offset_right</span><span class="p">)</span>
                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">LT</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_int_atoms_leq</span><span class="p">(</span><span class="n">var_left</span><span class="p">,</span> <span class="n">offset_left</span><span class="p">,</span>
                                                                 <span class="n">var_right</span><span class="p">,</span> <span class="n">offset_right</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">GEQ</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_int_atoms_leq</span><span class="p">(</span><span class="n">var_right</span><span class="p">,</span> <span class="n">offset_right</span><span class="p">,</span>
                                                                 <span class="n">var_left</span><span class="p">,</span> <span class="n">offset_left</span><span class="p">)</span>
                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">GT</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_int_atoms_leq</span><span class="p">(</span><span class="n">var_right</span><span class="p">,</span> <span class="n">offset_right</span><span class="p">,</span>
                                                                 <span class="n">var_left</span><span class="p">,</span> <span class="n">offset_left</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">EQ</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">preprocess_eq_int_atoms</span><span class="p">(</span><span class="n">var_left</span><span class="p">,</span> <span class="n">offset_left</span><span class="p">,</span>
                                                       <span class="n">var_right</span><span class="p">,</span> <span class="n">offset_right</span><span class="p">)</span>
                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">NEQ</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">preprocess_eq_int_atoms</span><span class="p">(</span><span class="n">var_left</span><span class="p">,</span> <span class="n">offset_left</span><span class="p">,</span>
                                                       <span class="n">var_right</span><span class="p">,</span> <span class="n">offset_right</span><span class="p">)</span><span class="o">.</span><span class="n">negated</span>
                    <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Incompatible constraint type and &quot;</span><span class="p">,</span>
                                          <span class="s2">&quot;terms: for pairs of integer atoms &quot;</span><span class="p">,</span>
                                          <span class="s2">&quot;(variable + offset), only LEQ, LT, &quot;</span><span class="p">,</span>
                                          <span class="s2">&quot;GEQ, GT, EQ and NEQ constraints are defined.&quot;</span><span class="p">))</span>

            <span class="k">case</span> <span class="n">Var</span><span class="p">()</span> <span class="k">as</span> <span class="n">var1</span><span class="p">,</span> <span class="n">Var</span><span class="p">()</span> <span class="k">as</span> <span class="n">var2</span><span class="p">:</span>

                <span class="k">match</span> <span class="n">constr_expr</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>

                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">EQ</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">preprocess_eq_bool_vars</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">)</span>

                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">NEQ</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">preprocess_eq_bool_vars</span><span class="p">(</span><span class="n">var1</span><span class="p">,</span> <span class="n">var2</span><span class="p">)</span><span class="o">.</span><span class="n">negated</span>

                    <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Incompatible constraint type and &quot;</span><span class="p">,</span>
                                          <span class="s2">&quot;terms: for pairs of boolean variables, &quot;</span><span class="p">,</span>
                                          <span class="s2">&quot;only EQ, and NEQ constraints are defined.&quot;</span><span class="p">))</span>

            <span class="k">case</span><span class="w"> </span><span class="p">[</span><span class="n">Lit</span><span class="p">(),</span> <span class="o">*</span><span class="k">_</span><span class="p">]</span> <span class="k">as</span> <span class="n">lits</span><span class="p">:</span> 

                <span class="k">match</span> <span class="n">constr_expr</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>

                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">OR</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_lits_simplify_or</span><span class="p">(</span><span class="n">lits</span><span class="p">)</span>

                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">AND</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_lits_simplify_and</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">negated</span> <span class="k">for</span> <span class="n">lit</span> <span class="ow">in</span> <span class="n">lits</span><span class="p">))</span>

                    <span class="k">case</span> <span class="n">ConstrExpr</span><span class="o">.</span><span class="n">Kind</span><span class="o">.</span><span class="n">IMPLY</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">lit_from</span><span class="p">,</span> <span class="n">lit_to</span> <span class="o">=</span> <span class="n">lits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lits</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">return</span> <span class="n">ElemConstrExpr</span><span class="o">.</span><span class="n">from_lits_simplify_or</span><span class="p">((</span><span class="n">lit_from</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span> <span class="n">lit_to</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Incorrect number of terms: &quot;</span><span class="p">,</span>
                                              <span class="s2">&quot;IMPLY constraints require&quot;</span><span class="p">,</span>
                                              <span class="s2">&quot;exactly two literals.&quot;</span><span class="p">))</span>
                    <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">((</span><span class="s2">&quot;Incompatible constraint type and &quot;</span><span class="p">,</span>
                                          <span class="s2">&quot;terms: OR, AND, and IMPLY constraints &quot;</span><span class="p">,</span>
                                          <span class="s2">&quot;require a sequence of literals.&quot;</span><span class="p">))</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Constraint expression could not be interpreted.&quot;&quot;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h5 id="src.solver.solver.Solver-attributes">Attributes</h5>

<div class="doc doc-object doc-attribute">




<h6 id="src.solver.solver.Solver.state" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">state</span><span class="p">:</span> <span class="n">SolverState</span> <span class="o">=</span> <span class="n">SolverState</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">
  </div>

</div>

<h5 id="src.solver.solver.Solver-functions">Functions</h5>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

</h6>


  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">:</span> <span class="n">SolverState</span> <span class="o">=</span> <span class="n">SolverState</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.choose_next_decision" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">choose_next_decision</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Decisions</span><span class="o">.</span><span class="n">AnyDecision</span></code>

</h6>


  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">choose_next_decision</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Decisions</span><span class="o">.</span><span class="n">AnyDecision</span><span class="p">:</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.increment_one_decision_level" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">increment_one_decision_level</span><span class="p">(</span><span class="n">reasoners</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Reasoner</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Increments the current decision level (by 1).</p>
<p>Invokes all reasoners' <code>on_solver_increment_decision_level</code> callbacks, which
updates them internally to account for the decision level incrementation.</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>reasoners</b>
            (<code><span title="typing.Tuple">Tuple</span>[<span title="src.solver.reasoners.reasoner.Reasoner">Reasoner</span>, ...]</code>)
        –
        <div class="doc-md-description">
          <p>The reasoners collaborating with the solver.</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">increment_one_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">reasoners</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Reasoner</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Increments the current decision level (by 1).</span>

<span class="sd">    Invokes all reasoners&#39; `on_solver_increment_decision_level` callbacks, which</span>
<span class="sd">    updates them internally to account for the decision level incrementation.</span>

<span class="sd">    Args:</span>
<span class="sd">        reasoners: The reasoners collaborating with the solver.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># assert self.curr_dec_lvl == 0 or len(self._events_trail[self.curr_dec_lvl]) &gt; 0</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_dec_lvl</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_events_trail</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_events_trail</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">reasoner</span> <span class="ow">in</span> <span class="n">reasoners</span><span class="p">:</span>
        <span class="n">reasoner</span><span class="o">.</span><span class="n">on_solver_increment_one_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.backtrack_to_decision_level" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">backtrack_to_decision_level</span><span class="p">(</span><span class="n">target_decision_level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reasoners</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Reasoner</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Backtracks to the target decision level by reverting all events at all
decision levels strictly greater than the target one.</p>
<p>Invokes the reasoners' <code>on_solver_backtrack_one_level</code> callbacks, at
each reverted decision level. This updates the reasoners internally to
account for the backtracking.</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>target_decision_level</b>
            (<code>int</code>)
        –
        <div class="doc-md-description">
          <p>The target decision level to backtrack to.</p>
        </div>
      </li>
      <li class="field-body">
        <b>reasoners</b>
            (<code><span title="typing.Tuple">Tuple</span>[<span title="src.solver.reasoners.reasoner.Reasoner">Reasoner</span>, ...]</code>)
        –
        <div class="doc-md-description">
          <p>The reasoners collaborating with the solver.</p>
        </div>
      </li>
  </ul>



  <p>Raises:</p>
  <ul>
      <li class="field-body">
            <code>ValueError</code>
          –
        <div class="doc-md-description">
          <p>If the target decision level was strictly less than 0.</p>
        </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">backtrack_to_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">target_decision_level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">reasoners</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Reasoner</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backtracks to the target decision level by reverting all events at all</span>
<span class="sd">    decision levels strictly greater than the target one.</span>

<span class="sd">    Invokes the reasoners&#39; `on_solver_backtrack_one_level` callbacks, at</span>
<span class="sd">    each reverted decision level. This updates the reasoners internally to</span>
<span class="sd">    account for the backtracking.</span>

<span class="sd">    Args:</span>
<span class="sd">        target_decision_level: The target decision level to backtrack to.</span>

<span class="sd">        reasoners: The reasoners collaborating with the solver.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the target decision level was strictly less than 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">target_decision_level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Target decision level must be &gt;= 0.&quot;</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span> <span class="o">&gt;</span> <span class="n">target_decision_level</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_undo_and_return_latest_event_at_current_decision_level</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_dec_lvl</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">reasoner</span> <span class="ow">in</span> <span class="n">reasoners</span><span class="p">:</span>
            <span class="n">reasoner</span><span class="o">.</span><span class="n">on_solver_backtrack_one_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.propagate" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagate</span><span class="p">(</span><span class="n">reasoners</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Reasoner</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">,</span> <span class="n">Reasoner</span><span class="p">]]</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>The propagation method of the solver.</p>
<p>For all reasoners, propagates new events/changes. The propagation
process stops either when no new bound update can be inferred (success),
or when a contradiction is detected by one of the reasoners (failure).</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>reasoners</b>
            (<code><span title="typing.Tuple">Tuple</span>[<span title="src.solver.reasoners.reasoner.Reasoner">Reasoner</span>, ...]</code>)
        –
        <div class="doc-md-description">
          <p>The reasoners collaborating with the solver.</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code><span title="typing.Optional">Optional</span>[<span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="src.solver.common.InvalidBoundUpdateInfo" href="../common/#src.solver.common.InvalidBoundUpdateInfo">InvalidBoundUpdateInfo</a> | <a class="autorefs autorefs-internal" title="src.solver.common.ReasonerBaseExplanation" href="../common/#src.solver.common.ReasonerBaseExplanation">ReasonerBaseExplanation</a>, <span title="src.solver.reasoners.reasoner.Reasoner">Reasoner</span>]]</code>
        –
        <div class="doc-md-description">
          <p>None if the propagation was successful, and a tuple if a conflict               is encountered. The tuple is composed of information on the conflict            as well as the reasoner that encountered it.</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">reasoners</span><span class="p">:</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Reasoner</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">,</span> <span class="n">Reasoner</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The propagation method of the solver.</span>

<span class="sd">    For all reasoners, propagates new events/changes. The propagation</span>
<span class="sd">    process stops either when no new bound update can be inferred (success),</span>
<span class="sd">    or when a contradiction is detected by one of the reasoners (failure).</span>

<span class="sd">    Args:</span>
<span class="sd">        reasoners: The reasoners collaborating with the solver.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None if the propagation was successful, and a tuple if a conflict   \</span>
<span class="sd">        is encountered. The tuple is composed of information on the conflict\</span>
<span class="sd">        as well as the reasoner that encountered it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">num_events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span>

        <span class="k">for</span> <span class="n">reasoner</span> <span class="ow">in</span> <span class="n">reasoners</span><span class="p">:</span>
            <span class="n">conflict_info</span> <span class="o">=</span> <span class="n">reasoner</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">conflict_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">conflict_info</span><span class="p">,</span> <span class="n">reasoner</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">num_events</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.explain_invalid_bound_update" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">explain_invalid_bound_update</span><span class="p">(</span><span class="n">invalid_bound_update_info</span><span class="p">:</span> <span class="n">InvalidBoundUpdateInfo</span><span class="p">,</span> <span class="n">explain_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">,</span> <span class="n">Solver</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ConflictAnalysisResult</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Given an invalid bound update of a literal 'l',
returns an asserting clause 'l_1' &amp; ... &amp; 'l_n' =&gt; not 'l_dec' where:
 - the literals 'l_i' are entailed at the previous decision level (of the current state)
 - the literal 'l_dec' is the decisions that was taken at the current decision level</p>
<p>The update of 'l' must not directly originate from a decision,
as it is necessarily the case that 'not l' holds in the current
state. It is thus considered a logic error to enforce an obviously
wrong decision.</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>invalid_bound_update_info</b>
            (<code><a class="autorefs autorefs-internal" title="src.solver.common.InvalidBoundUpdateInfo" href="../common/#src.solver.common.InvalidBoundUpdateInfo">InvalidBoundUpdateInfo</a></code>)
        –
        <div class="doc-md-description">
          <p>The information about the conflict to explain.</p>
        </div>
      </li>
      <li class="field-body">
        <b>explain_function</b>
            (<code><span title="typing.Callable">Callable</span>[[<span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="src.fundamentals.Lit" href="../fundamentals/#src.fundamentals.Lit">Lit</a>], <a class="autorefs autorefs-internal" title="src.fundamentals.Lit" href="../fundamentals/#src.fundamentals.Lit">Lit</a>, <a class="autorefs autorefs-internal" title="src.solver.common.Causes.ReasonerInference" href="../common/#src.solver.common.Causes.ReasonerInference">ReasonerInference</a>, <a class="autorefs autorefs-internal" title="src.solver.solver.Solver" href="#src.solver.solver.Solver">Solver</a>], None]</code>)
        –
        <div class="doc-md-description">
          <p>The external function that may participate in building the explanation                    (basically the <code>explain</code> function of <code>Reasoner</code>)</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code><a class="autorefs autorefs-internal" title="src.solver.common.ConflictAnalysisResult" href="../common/#src.solver.common.ConflictAnalysisResult">ConflictAnalysisResult</a></code>
        –
        <div class="doc-md-description">
          <p>The results of conflict analysis.</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">explain_invalid_bound_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">invalid_bound_update_info</span><span class="p">:</span> <span class="n">InvalidBoundUpdateInfo</span><span class="p">,</span>
    <span class="n">explain_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">,</span> <span class="n">Solver</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConflictAnalysisResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an invalid bound update of a literal &#39;l&#39;,</span>
<span class="sd">    returns an asserting clause &#39;l_1&#39; &amp; ... &amp; &#39;l_n&#39; =&gt; not &#39;l_dec&#39; where:</span>
<span class="sd">     - the literals &#39;l_i&#39; are entailed at the previous decision level (of the current state)</span>
<span class="sd">     - the literal &#39;l_dec&#39; is the decisions that was taken at the current decision level</span>

<span class="sd">    The update of &#39;l&#39; must not directly originate from a decision,</span>
<span class="sd">    as it is necessarily the case that &#39;not l&#39; holds in the current</span>
<span class="sd">    state. It is thus considered a logic error to enforce an obviously</span>
<span class="sd">    wrong decision.</span>

<span class="sd">    Args:</span>
<span class="sd">        invalid_bound_update_info: The information about the conflict to explain.</span>

<span class="sd">        explain_function: The external function that may participate in building the explanation    \</span>
<span class="sd">            (basically the `explain` function of `Reasoner`)</span>

<span class="sd">    Returns:</span>
<span class="sd">        The results of conflict analysis.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Remember that an update is invalid iff its negation holds AND</span>
    <span class="c1"># the affected variable is present.</span>

    <span class="c1"># The base of the explanation is (&#39;not l&#39; v &#39;l&#39;)</span>
    <span class="n">explanation_starting_literals</span> <span class="o">=</span> <span class="p">[</span><span class="n">invalid_bound_update_info</span><span class="o">.</span><span class="n">literal</span><span class="o">.</span><span class="n">negated</span><span class="p">]</span>

    <span class="c1"># However &#39;l&#39; does not hold in the current state and it needs</span>
    <span class="c1"># to be replaced, with a set of literals &#39;l_1&#39; v ... v &#39;l_n&#39;,</span>
    <span class="c1"># such that &#39;l_1&#39; v ... v &#39;l_n&#39; =&gt; &#39;l&#39;. As such, the explanation</span>
    <span class="c1"># becomes &#39;not l&#39; v &#39;l_1&#39; v ... v &#39;l_n&#39;, and all its disjuncts</span>
    <span class="c1"># (&#39;not l&#39; and all &#39;l_i&#39;) hold in the current state.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_add_implying_literals_to_explanation</span><span class="p">(</span><span class="n">explanation_starting_literals</span><span class="p">,</span>
                                               <span class="n">invalid_bound_update_info</span><span class="o">.</span><span class="n">literal</span><span class="p">,</span>
                                               <span class="n">invalid_bound_update_info</span><span class="o">.</span><span class="n">cause</span><span class="p">,</span>
                                               <span class="n">explain_function</span><span class="p">)</span>

    <span class="c1"># The explanation clause &#39;not l&#39; v &#39;l_1&#39; v ... v &#39;l_n&#39; must now be </span>
    <span class="c1"># transformed into 1st Unique Implication Point form.</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">refine_explanation</span><span class="p">(</span><span class="n">explanation_starting_literals</span><span class="p">,</span>
                                   <span class="n">explain_function</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.refine_explanation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">refine_explanation</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">explain_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">,</span> <span class="n">Solver</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ConflictAnalysisResult</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Refines an explanation into an asserting clause.</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>explanation_literals</b>
            (<code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="src.fundamentals.Lit" href="../fundamentals/#src.fundamentals.Lit">Lit</a>]</code>)
        –
        <div class="doc-md-description">
          <p>The list of literals making up the explanation.                   Modified by the method.</p>
        </div>
      </li>
      <li class="field-body">
        <b>explain_function</b>
            (<code><span title="typing.Callable">Callable</span>[[<span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="src.fundamentals.Lit" href="../fundamentals/#src.fundamentals.Lit">Lit</a>], <a class="autorefs autorefs-internal" title="src.fundamentals.Lit" href="../fundamentals/#src.fundamentals.Lit">Lit</a>, <a class="autorefs autorefs-internal" title="src.solver.common.Causes.ReasonerInference" href="../common/#src.solver.common.Causes.ReasonerInference">ReasonerInference</a>, <a class="autorefs autorefs-internal" title="src.solver.solver.Solver" href="#src.solver.solver.Solver">Solver</a>], None]</code>)
        –
        <div class="doc-md-description">
          <p>The external function that may participate in building the explanation                    (basically the <code>explain</code> function of <code>Reasoner</code>)</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code><a class="autorefs autorefs-internal" title="src.solver.common.ConflictAnalysisResult" href="../common/#src.solver.common.ConflictAnalysisResult">ConflictAnalysisResult</a></code>
        –
        <div class="doc-md-description">
          <p>The results of conflict analysis.</p>
      </div>
      </li>
  </ul>

<details class="note" open>
  <summary>Note</summary>
  <p>A partial backtrack (within the current decision level) will occur
in this function. This is necessary to provide explainers (reasoners)
with the exact state in which their decisions were made.</p>
<p>However there is no need to "synchronize"/update the reasoners' earliest
unprocessed event index because of this partial backtracking. Indeed,
right after this explanation is made/refined as part of conflict analysis,
we will backtrack to an earlier decision level anyway. And during with
that backtracking, the earliest unprocessed event index of each reasoner
will be reset to 0 (at that decision level). As such, the partial backtracking
that happens in this method doesn't cause any problem for reasoners.</p>
</details>
          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">refine_explanation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span>
    <span class="n">explain_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">,</span> <span class="n">Solver</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ConflictAnalysisResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Refines an explanation into an asserting clause.</span>

<span class="sd">    Args:</span>
<span class="sd">        explanation_literals: The list of literals making up the explanation.   \</span>
<span class="sd">            Modified by the method.</span>

<span class="sd">        explain_function: The external function that may participate in building the explanation    \</span>
<span class="sd">            (basically the `explain` function of `Reasoner`)</span>

<span class="sd">    Returns:</span>
<span class="sd">        The results of conflict analysis.</span>

<span class="sd">    Note:</span>
<span class="sd">        A partial backtrack (within the current decision level) will occur</span>
<span class="sd">        in this function. This is necessary to provide explainers (reasoners)</span>
<span class="sd">        with the exact state in which their decisions were made.</span>

<span class="sd">        However there is no need to &quot;synchronize&quot;/update the reasoners&#39; earliest</span>
<span class="sd">        unprocessed event index because of this partial backtracking. Indeed,</span>
<span class="sd">        right after this explanation is made/refined as part of conflict analysis,</span>
<span class="sd">        we will backtrack to an earlier decision level anyway. And during with</span>
<span class="sd">        that backtracking, the earliest unprocessed event index of each reasoner</span>
<span class="sd">        will be reset to 0 (at that decision level). As such, the partial backtracking</span>
<span class="sd">        that happens in this method doesn&#39;t cause any problem for reasoners.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Literals falsified at the current decision level,</span>
    <span class="c1"># we need to proceed until there is a single one left (1UIP).</span>
    <span class="c1"># The int is MINUS the index of the event (in the events trail)</span>
    <span class="c1"># where the literal was implied. It acts as the priority value</span>
    <span class="c1"># of the maxheap. But since the Python heapq is a minheap</span>
    <span class="c1"># and we want a maxheap, we need to invert the priority values...</span>

    <span class="n">prio_queue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">],</span> <span class="n">Lit</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">heapq</span><span class="o">.</span><span class="n">heapify</span><span class="p">(</span><span class="n">prio_queue</span><span class="p">)</span>

    <span class="c1"># Literals that are beyond the current decision and</span>
    <span class="c1"># will be part of the final asserting clause.</span>
    <span class="n">asserting_clause_literals</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">resolved_literals</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">lit</span> <span class="ow">in</span> <span class="n">explanation_literals</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">lit</span><span class="p">):</span>

                <span class="n">first_entailing_ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">first_event_entailing</span><span class="p">(</span><span class="n">lit</span><span class="p">)</span>

                <span class="c1"># If lit is implied at decision level 0, then it</span>
                <span class="c1"># is always true. So we can discard it.</span>
                <span class="k">if</span> <span class="n">first_entailing_ev</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">first_entailing_ev</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">ev_i_dl</span><span class="p">,</span> <span class="n">ev_i</span> <span class="o">=</span> <span class="n">first_entailing_ev</span><span class="o">.</span><span class="n">index</span>

                <span class="c1"># If lit is implied at the current decision</span>
                <span class="c1"># level, then add it to the queue.</span>
                <span class="c1">#</span>
                <span class="c1"># But if lit is implied at a decision level</span>
                <span class="c1"># before the current one, then its negation</span>
                <span class="c1"># will appear in the final clause (1UIP).</span>

                <span class="k">if</span> <span class="n">ev_i_dl</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">:</span>
                    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">prio_queue</span><span class="p">,</span> <span class="p">((</span><span class="o">-</span><span class="n">ev_i_dl</span><span class="p">,</span> <span class="o">-</span><span class="n">ev_i</span><span class="p">),</span> <span class="n">lit</span><span class="p">))</span>

                <span class="k">elif</span> <span class="n">ev_i_dl</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">:</span>
                    <span class="n">asserting_clause_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="kc">False</span>

            <span class="c1"># If lit is is not entailed, it must have been added in</span>
            <span class="c1"># an eager propagation. Even if it was not necessary for</span>
            <span class="c1"># this propagation to occur, it must be part of the clause</span>
            <span class="c1"># for correctness.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">asserting_clause_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>

        <span class="c1"># If the queue is empty, it means that all literals in the clause</span>
        <span class="c1"># will be at decision levels earlier than the current decision level.</span>
        <span class="c1"># This can happen if we are at the top decision level, or if we</span>
        <span class="c1"># had a lazy propagator that didn&#39;t immediately detect the </span>
        <span class="c1"># inconsistency # NOTE: need to be better understand this.</span>
        <span class="c1">#</span>
        <span class="c1"># Corollary: if dl is 0, the derived clause must be empty.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prio_queue</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ConflictAnalysisResult</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">asserting_clause_literals</span><span class="p">),</span>
                                          <span class="n">resolved_literals</span><span class="p">)</span>

        <span class="c1"># At this point, we haven&#39;t reached the 1st UIP yet.</span>

        <span class="c1"># Select the latest falsified literal from the queue.</span>
        <span class="n">_prio_queue_head</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">prio_queue</span><span class="p">)</span>
        <span class="p">((</span><span class="n">ev_i_dl</span><span class="p">,</span> <span class="n">ev_i</span><span class="p">),</span> <span class="n">lit</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                  <span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># However, the queue might contain more than onen reference</span>
        <span class="c1"># to the same event. Because of the priority of the queue</span>
        <span class="c1"># (event indices), they are necessarily contiguous.</span>
        <span class="k">while</span> <span class="n">prio_queue</span><span class="p">:</span>
            <span class="n">_prio_queue_head</span> <span class="o">=</span> <span class="n">prio_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    <span class="c1"># peek</span>
            <span class="p">((</span><span class="n">next_dl</span><span class="p">,</span> <span class="n">next_ev_i</span><span class="p">),</span> <span class="n">next_lit</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                                <span class="n">_prio_queue_head</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># If the event is the same, pop it from the queue</span>
            <span class="c1"># and keep the most general one of them as &#39;lit&#39;.</span>
            <span class="c1"># (i.e. the one with the weaker bound value).</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">next_dl</span><span class="p">,</span> <span class="n">next_ev_i</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">ev_i_dl</span><span class="p">,</span> <span class="n">ev_i</span><span class="p">):</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">prio_queue</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lit</span><span class="o">.</span><span class="n">bound_value</span><span class="o">.</span><span class="n">is_stronger_than</span><span class="p">(</span><span class="n">next_lit</span><span class="o">.</span><span class="n">bound_value</span><span class="p">):</span>
                    <span class="n">lit</span> <span class="o">=</span> <span class="n">next_lit</span>
            <span class="c1"># If the event isn&#39;t the same, none of the remaining</span>
            <span class="c1"># ones will be either, because of the priority of the queue.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># If the queue is empty, we have reached the 1UIP.</span>
        <span class="c1"># The contents of asserting_clause_literals now corresponds</span>
        <span class="c1"># to a conjunction of literals that imply &#39;not lit&#39;.</span>
        <span class="c1"># Thus, to finish building the asserting clause, we just</span>
        <span class="c1"># need to add &#39;not lit&#39; to asserting_clause_literals.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prio_queue</span><span class="p">:</span>
            <span class="n">asserting_clause_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ConflictAnalysisResult</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">asserting_clause_literals</span><span class="p">),</span>
                                          <span class="n">resolved_literals</span><span class="p">)</span>

        <span class="c1"># Now, we need to until the latest falsifying event. This</span>
        <span class="c1"># will undo some of the changes, but we will remain in the</span>
        <span class="c1"># same decision level (see function description for the</span>
        <span class="c1"># reason behind this partial backtracking). Indeed, the event</span>
        <span class="c1"># cannot be a decision, because otherwise it would have been</span>
        <span class="c1"># detected as a UIP earlier.</span>

        <span class="n">cause</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Causes</span><span class="o">.</span><span class="n">AnyCause</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">ev_i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span><span class="p">:</span>
            <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_undo_and_return_latest_event_at_current_decision_level</span><span class="p">()</span>
            <span class="n">cause</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">cause</span>

        <span class="k">assert</span> <span class="n">cause</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">signed_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resolved_literals</span>
            <span class="ow">or</span> <span class="n">lit</span><span class="o">.</span><span class="n">bound_value</span><span class="o">.</span><span class="n">is_stronger_than</span><span class="p">(</span><span class="n">resolved_literals</span><span class="p">[</span><span class="n">lit</span><span class="o">.</span><span class="n">signed_var</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="n">resolved_literals</span><span class="p">[</span><span class="n">lit</span><span class="o">.</span><span class="n">signed_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">lit</span><span class="o">.</span><span class="n">bound_value</span>                

        <span class="c1"># Add a set of literals whose conjunction implies lit to explanation_literals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_implying_literals_to_explanation</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">,</span>
                                                   <span class="n">lit</span><span class="p">,</span>
                                                   <span class="n">cause</span><span class="p">,</span>
                                                   <span class="n">explain_function</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.get_decision_level_to_backtrack_to" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_decision_level_to_backtrack_to</span><span class="p">(</span><span class="n">asserting_clause_literals</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Lit</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Lit</span><span class="p">]]</span></code>

</h6>


  <div class="doc doc-contents ">
  



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code><span title="typing.Tuple">Tuple</span>[bool, int, <span title="typing.Optional">Optional</span>[<a class="autorefs autorefs-internal" title="src.fundamentals.Lit" href="../fundamentals/#src.fundamentals.Lit">Lit</a>]]</code>
        –
        <div class="doc-md-description">
          <p>A tuple consisting of the appropriate backtracking level for the                 clause formed by the given clause literals, the literal that                 is asserted at that level, and whether the clause is                         conflicting at the top decision level (which would prove                     unsatisfiability).</p>
      </div>
      </li>
  </ul>

<details class="note" open>
  <summary>Note</summary>
  <p>Normally, in the 1UIP backtracking scheme (1st Unique Implication Point),
the decision level to backtrack to should be the largest one (i.e. "closest"
to the conflict) at which the clause is unit. However, the explanation of
eager propagation of optionals might generate explanations where some literals
are not violated. These are ignored when determining the backtrack level.</p>
<p>If there is more than one violated literal at that level, then no literal is
asserted and the determined backtrack level is further decreased by 1. This might
occur with clause sharing.</p>
</details>
          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_decision_level_to_backtrack_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">asserting_clause_literals</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Lit</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Lit</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns:</span>
<span class="sd">        A tuple consisting of the appropriate backtracking level for the \</span>
<span class="sd">            clause formed by the given clause literals, the literal that \</span>
<span class="sd">            is asserted at that level, and whether the clause is         \</span>
<span class="sd">            conflicting at the top decision level (which would prove     \</span>
<span class="sd">            unsatisfiability).</span>

<span class="sd">    Note:</span>
<span class="sd">        Normally, in the 1UIP backtracking scheme (1st Unique Implication Point),</span>
<span class="sd">        the decision level to backtrack to should be the largest one (i.e. &quot;closest&quot;</span>
<span class="sd">        to the conflict) at which the clause is unit. However, the explanation of</span>
<span class="sd">        eager propagation of optionals might generate explanations where some literals</span>
<span class="sd">        are not violated. These are ignored when determining the backtrack level.</span>

<span class="sd">        If there is more than one violated literal at that level, then no literal is</span>
<span class="sd">        asserted and the determined backtrack level is further decreased by 1. This might</span>
<span class="sd">        occur with clause sharing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">max_dl</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">next_max_dl</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">asserted_literal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Lit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">literal</span> <span class="ow">in</span> <span class="n">asserting_clause_literals</span><span class="p">:</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">literal</span><span class="o">.</span><span class="n">negated</span><span class="o">.</span><span class="n">signed_var</span><span class="p">)</span>
                <span class="o">.</span><span class="n">is_stronger_than</span><span class="p">(</span><span class="n">literal</span><span class="o">.</span><span class="n">negated</span><span class="o">.</span><span class="n">bound_value</span><span class="p">)</span>
        <span class="p">):</span>

            <span class="n">first_entailing_ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">first_event_entailing</span><span class="p">(</span><span class="n">literal</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">first_entailing_ev</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">first_entailing_ev</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">dl</span> <span class="o">=</span> <span class="n">first_entailing_ev</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dl</span> <span class="o">&gt;</span> <span class="n">max_dl</span><span class="p">:</span>
                    <span class="n">next_max_dl</span> <span class="o">=</span> <span class="n">max_dl</span>
                    <span class="n">max_dl</span> <span class="o">=</span> <span class="n">dl</span>
                    <span class="n">asserted_literal</span> <span class="o">=</span> <span class="n">literal</span>
                <span class="k">elif</span> <span class="n">dl</span> <span class="o">&gt;</span> <span class="n">next_max_dl</span><span class="p">:</span>
                    <span class="n">next_max_dl</span> <span class="o">=</span> <span class="n">dl</span>

    <span class="k">if</span> <span class="n">max_dl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">max_dl</span> <span class="o">==</span> <span class="n">next_max_dl</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_dl</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">next_max_dl</span><span class="p">,</span> <span class="n">asserted_literal</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.add_new_non_optional_variable" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_new_non_optional_variable</span><span class="p">(</span><span class="n">initial_domain</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">controllable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Adds a new non-optional variable to the solver and returns it.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_new_non_optional_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">initial_domain</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">controllable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new non-optional variable to the solver and returns it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_add_new_variable</span><span class="p">(</span><span class="n">initial_domain</span><span class="p">,</span> <span class="n">controllable</span><span class="p">,</span> <span class="n">TRUE_LIT</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.add_new_optional_variable" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_new_optional_variable</span><span class="p">(</span><span class="n">initial_domain</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">controllable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">presence_literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Adds a new optional variable to the solver and returns it.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_new_optional_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">initial_domain</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">controllable</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">presence_literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new optional variable to the solver and returns it.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_add_new_variable</span><span class="p">(</span><span class="n">initial_domain</span><span class="p">,</span> <span class="n">controllable</span><span class="p">,</span> <span class="n">presence_literal</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.add_new_presence_variable" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_new_presence_variable</span><span class="p">(</span><span class="n">scope_literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Adds a new presence variable, defined in the scope corresponding to
the given scope literal, and returns it.</p>
<p>A presence variable is simply a non-optional (boolean) variable
which is used to define presence literals.</p>
<p>A presence literal, is simply a literal on (the truth value of) a presence
variable. They are encoded as [presence_variable &gt;= 1].</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_new_presence_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">scope_literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Var</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new presence variable, defined in the scope corresponding to</span>
<span class="sd">    the given scope literal, and returns it.</span>

<span class="sd">    A presence variable is simply a non-optional (boolean) variable</span>
<span class="sd">    which is used to define presence literals.</span>

<span class="sd">    A presence literal, is simply a literal on (the truth value of) a presence</span>
<span class="sd">    variable. They are encoded as [presence_variable &gt;= 1].</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_new_non_optional_variable</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">lit</span> <span class="o">=</span> <span class="n">Lit</span><span class="o">.</span><span class="n">geq</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_register_new_scope</span><span class="p">((</span><span class="n">lit</span><span class="p">,),</span> <span class="n">lit</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_register_implication_between_literals_on_non_optional_vars</span><span class="p">(</span><span class="n">lit</span><span class="p">,</span> <span class="n">scope_literal</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">var</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.solver.Solver.add_constraint" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_constraint</span><span class="p">(</span><span class="n">constr_expr</span><span class="p">:</span> <span class="n">ConstrExpr</span><span class="p">,</span> <span class="n">scope_as_conjunction</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Lit</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ElemConstrExpr</span><span class="p">,</span> <span class="n">Lit</span><span class="p">]</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Adds a constraint defined by the given high-level expression,
in a scope defined by a conjunction of literals.</p>
<p>In other words, we register the fact that the constraint will have to
hold / be true / be satisfied iff all of the given literals are entailed.</p>
<p>Internally, the high-level constraint expression is preprocessed into a
low-level, "elementary" form. This elementary form could be defined with
new literals, resulting from "intermediary" reification during the preprocessing.</p>
<p>Then, this elementary form constraint is reified to an optional literal
that is true iff the expression is valid/well-defined, and absent otherwise.</p>



  <p>Parameters:</p>
  <ul>
      <li class="field-body">
        <b>constr_expr</b>
            (<code><a class="autorefs autorefs-internal" title="src.constraint_expressions.ConstrExpr" href="../constraint_expressions/#src.constraint_expressions.ConstrExpr">ConstrExpr</a></code>)
        –
        <div class="doc-md-description">
          <p>The high-level constraint expression defining the constraint to add.</p>
        </div>
      </li>
      <li class="field-body">
        <b>scope_as_conjunction</b>
            (<code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="src.fundamentals.Lit" href="../fundamentals/#src.fundamentals.Lit">Lit</a>, ...]</code>)
        –
        <div class="doc-md-description">
          <p>The literals whose conjunction defines the scope                  in which the constraint will have to hold.</p>
        </div>
      </li>
  </ul>



  <p>Returns:</p>
  <ul>
      <li class="field-body">
            <code><span title="typing.Tuple">Tuple</span>[<a class="autorefs autorefs-internal" title="src.constraint_expressions.ElemConstrExpr" href="../constraint_expressions/#src.constraint_expressions.ElemConstrExpr">ElemConstrExpr</a>, <a class="autorefs autorefs-internal" title="src.fundamentals.Lit" href="../fundamentals/#src.fundamentals.Lit">Lit</a>]</code>
        –
        <div class="doc-md-description">
          <p>A reified constraint, formed by the elementary form expression as well                 as that optional literal (sometimes called the reification literal).</p>
      </div>
      </li>
  </ul>

          <details class="quote">
            <summary>Source code in <code>src/solver/solver.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">constr_expr</span><span class="p">:</span> <span class="n">ConstrExpr</span><span class="p">,</span>
    <span class="n">scope_as_conjunction</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Lit</span><span class="p">,</span><span class="o">...</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ElemConstrExpr</span><span class="p">,</span> <span class="n">Lit</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a constraint defined by the given high-level expression,</span>
<span class="sd">    in a scope defined by a conjunction of literals.</span>

<span class="sd">    In other words, we register the fact that the constraint will have to</span>
<span class="sd">    hold / be true / be satisfied iff all of the given literals are entailed.</span>

<span class="sd">    Internally, the high-level constraint expression is preprocessed into a</span>
<span class="sd">    low-level, &quot;elementary&quot; form. This elementary form could be defined with</span>
<span class="sd">    new literals, resulting from &quot;intermediary&quot; reification during the preprocessing.</span>

<span class="sd">    Then, this elementary form constraint is reified to an optional literal</span>
<span class="sd">    that is true iff the expression is valid/well-defined, and absent otherwise.</span>

<span class="sd">    Args:</span>
<span class="sd">        constr_expr: The high-level constraint expression defining the constraint to add.</span>
<span class="sd">        scope_as_conjunction: The literals whose conjunction defines the scope  \</span>
<span class="sd">            in which the constraint will have to hold.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A reified constraint, formed by the elementary form expression as well \</span>
<span class="sd">            as that optional literal (sometimes called the reification literal).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">elem_constr_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocess_constr_expr_into_elem_form</span><span class="p">(</span><span class="n">constr_expr</span><span class="p">)</span>

    <span class="n">scope_tautology_lit</span> <span class="o">=</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_get_or_make_tautology_of_scope</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_get_or_make_new_scope_lit_from_conjunction</span><span class="p">(</span><span class="n">scope_as_conjunction</span><span class="p">))</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_add_elem_constraint</span><span class="p">(</span><span class="n">elem_constr_expr</span><span class="p">,</span> <span class="n">scope_tautology_lit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
    
  </body>
</html>