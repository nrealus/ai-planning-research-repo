
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../sat_reasoner/">
      
      
        <link rel="next" href="../brancher/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.2.8">
    
    
      
        <title>Difference Logic Reasoner - AI Planning Research Project</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.046329b4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../stylesheets/extra_style.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#src.solver.reasoners.diff_reasoner-attributes" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="AI Planning Research Project" class="md-header__button md-logo" aria-label="AI Planning Research Project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AI Planning Research Project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Difference Logic Reasoner
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="AI Planning Research Project" class="md-nav__button md-logo" aria-label="AI Planning Research Project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    AI Planning Research Project
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Aries-like Solver Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../cdcl_example/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example CDCL search
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../fundamentals/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Fundamentals
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../constraint_expressions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Constraint Expressions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
        
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Solver
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            Solver
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../common/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Common
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../solver_state/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Solver State
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../solver/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Solver Main Class
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_4" checked>
        
          <label class="md-nav__link" for="__nav_3_3_4" id="__nav_3_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Reasoners
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3_4">
            <span class="md-nav__icon md-icon"></span>
            Reasoners
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../reasoner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reasoner
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../sat_reasoner/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SAT Reasoner
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Difference Logic Reasoner
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Difference Logic Reasoner
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner-attributes" class="md-nav__link">
    Attributes
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.MAX_INT" class="md-nav__link">
    MAX_INT
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner-classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner" class="md-nav__link">
    DiffReasoner
  </a>
  
    <nav class="md-nav" aria-label="DiffReasoner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner-attributes" class="md-nav__link">
    Attributes
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.propagators_database" class="md-nav__link">
    propagators_database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.propagators_active" class="md-nav__link">
    propagators_active
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.propagators_pending_for_activation" class="md-nav__link">
    propagators_pending_for_activation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.pending_bounds_to_update" class="md-nav__link">
    pending_bounds_to_update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.internal_pending_bounds_to_update_queue" class="md-nav__link">
    internal_pending_bounds_to_update_queue
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.propagation_metadata_trail" class="md-nav__link">
    propagation_metadata_trail
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.theory_propagation_causes" class="md-nav__link">
    theory_propagation_causes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.next_unprocessed_solver_event_index" class="md-nav__link">
    next_unprocessed_solver_event_index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.state" class="md-nav__link">
    state
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner-classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroup" class="md-nav__link">
    PropaGroup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroupId" class="md-nav__link">
    PropaGroupId
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.Enabler" class="md-nav__link">
    Enabler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase" class="md-nav__link">
    PropaDatabase
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses" class="md-nav__link">
    TheoryPropCauses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses" class="md-nav__link">
    InferenceCauses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState" class="md-nav__link">
    DijkstraState
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner-functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.add_reified_difference_constraint" class="md-nav__link">
    add_reified_difference_constraint()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.on_solver_increment_one_decision_level" class="md-nav__link">
    on_solver_increment_one_decision_level()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.on_solver_backtrack_one_decision_level" class="md-nav__link">
    on_solver_backtrack_one_decision_level()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.propagate" class="md-nav__link">
    propagate()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.run_propagation_loop" class="md-nav__link">
    run_propagation_loop()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.theory_propagate_bound" class="md-nav__link">
    theory_propagate_bound()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.theory_propagate_edge" class="md-nav__link">
    theory_propagate_edge()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.explain" class="md-nav__link">
    explain()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.explain_bound_propagation" class="md-nav__link">
    explain_bound_propagation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.explain_theory_propagation" class="md-nav__link">
    explain_theory_propagation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.get_theory_propagation_path" class="md-nav__link">
    get_theory_propagation_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.will_get_theory_propagation_path_succeed" class="md-nav__link">
    will_get_theory_propagation_path_succeed()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.run_dijkstra" class="md-nav__link">
    run_dijkstra()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.distances_from" class="md-nav__link">
    distances_from()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_5" >
        
          <label class="md-nav__link" for="__nav_3_3_5" id="__nav_3_3_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Branchers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_5">
            <span class="md-nav__icon md-icon"></span>
            Branchers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../brancher/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Brancher
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner-attributes" class="md-nav__link">
    Attributes
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.MAX_INT" class="md-nav__link">
    MAX_INT
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner-classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner" class="md-nav__link">
    DiffReasoner
  </a>
  
    <nav class="md-nav" aria-label="DiffReasoner">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner-attributes" class="md-nav__link">
    Attributes
  </a>
  
    <nav class="md-nav" aria-label="Attributes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.propagators_database" class="md-nav__link">
    propagators_database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.propagators_active" class="md-nav__link">
    propagators_active
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.propagators_pending_for_activation" class="md-nav__link">
    propagators_pending_for_activation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.pending_bounds_to_update" class="md-nav__link">
    pending_bounds_to_update
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.internal_pending_bounds_to_update_queue" class="md-nav__link">
    internal_pending_bounds_to_update_queue
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.propagation_metadata_trail" class="md-nav__link">
    propagation_metadata_trail
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.theory_propagation_causes" class="md-nav__link">
    theory_propagation_causes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.next_unprocessed_solver_event_index" class="md-nav__link">
    next_unprocessed_solver_event_index
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.state" class="md-nav__link">
    state
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner-classes" class="md-nav__link">
    Classes
  </a>
  
    <nav class="md-nav" aria-label="Classes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroup" class="md-nav__link">
    PropaGroup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroupId" class="md-nav__link">
    PropaGroupId
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.Enabler" class="md-nav__link">
    Enabler
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase" class="md-nav__link">
    PropaDatabase
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses" class="md-nav__link">
    TheoryPropCauses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses" class="md-nav__link">
    InferenceCauses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState" class="md-nav__link">
    DijkstraState
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner-functions" class="md-nav__link">
    Functions
  </a>
  
    <nav class="md-nav" aria-label="Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.__init__" class="md-nav__link">
    __init__()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.add_reified_difference_constraint" class="md-nav__link">
    add_reified_difference_constraint()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.on_solver_increment_one_decision_level" class="md-nav__link">
    on_solver_increment_one_decision_level()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.on_solver_backtrack_one_decision_level" class="md-nav__link">
    on_solver_backtrack_one_decision_level()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.propagate" class="md-nav__link">
    propagate()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.run_propagation_loop" class="md-nav__link">
    run_propagation_loop()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.theory_propagate_bound" class="md-nav__link">
    theory_propagate_bound()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.theory_propagate_edge" class="md-nav__link">
    theory_propagate_edge()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.explain" class="md-nav__link">
    explain()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.explain_bound_propagation" class="md-nav__link">
    explain_bound_propagation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.explain_theory_propagation" class="md-nav__link">
    explain_theory_propagation()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.get_theory_propagation_path" class="md-nav__link">
    get_theory_propagation_path()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.will_get_theory_propagation_path_succeed" class="md-nav__link">
    will_get_theory_propagation_path_succeed()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.run_dijkstra" class="md-nav__link">
    run_dijkstra()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#src.solver.reasoners.diff_reasoner.DiffReasoner.distances_from" class="md-nav__link">
    distances_from()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<div class="doc doc-object doc-module">




  <div class="doc doc-contents first">
  
      <p>This module defines the "Difference logic reasoner"
(aka "diff reasoner", aka "stn reasoner") of the solver.</p>
<p>This reasoner is dedicated to handling reified difference constraints of
the form <code>X + Y &lt; c</code> (where <code>X</code> and <code>Y</code> are variables, and <code>c</code> is a constant).</p>

  

  <div class="doc doc-children">





<h3 id="src.solver.reasoners.diff_reasoner-attributes">Attributes</h3>

<div class="doc doc-object doc-attribute">




<h4 id="src.solver.reasoners.diff_reasoner.MAX_INT" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">MAX_INT</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">64</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h4>


  <div class="doc doc-contents ">
  </div>

</div>
<h3 id="src.solver.reasoners.diff_reasoner-classes">Classes</h3>

<div class="doc doc-object doc-class">




<h4 id="src.solver.reasoners.diff_reasoner.DiffReasoner" class="doc doc-heading">
          <code>DiffReasoner</code>


</h4>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><a class="autorefs autorefs-internal" title="src.solver.reasoners.reasoner.Reasoner" href="../reasoner/#src.solver.reasoners.reasoner.Reasoner">Reasoner</a></code></p>

  
      

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  30</span>
<span class="normal">  31</span>
<span class="normal">  32</span>
<span class="normal">  33</span>
<span class="normal">  34</span>
<span class="normal">  35</span>
<span class="normal">  36</span>
<span class="normal">  37</span>
<span class="normal">  38</span>
<span class="normal">  39</span>
<span class="normal">  40</span>
<span class="normal">  41</span>
<span class="normal">  42</span>
<span class="normal">  43</span>
<span class="normal">  44</span>
<span class="normal">  45</span>
<span class="normal">  46</span>
<span class="normal">  47</span>
<span class="normal">  48</span>
<span class="normal">  49</span>
<span class="normal">  50</span>
<span class="normal">  51</span>
<span class="normal">  52</span>
<span class="normal">  53</span>
<span class="normal">  54</span>
<span class="normal">  55</span>
<span class="normal">  56</span>
<span class="normal">  57</span>
<span class="normal">  58</span>
<span class="normal">  59</span>
<span class="normal">  60</span>
<span class="normal">  61</span>
<span class="normal">  62</span>
<span class="normal">  63</span>
<span class="normal">  64</span>
<span class="normal">  65</span>
<span class="normal">  66</span>
<span class="normal">  67</span>
<span class="normal">  68</span>
<span class="normal">  69</span>
<span class="normal">  70</span>
<span class="normal">  71</span>
<span class="normal">  72</span>
<span class="normal">  73</span>
<span class="normal">  74</span>
<span class="normal">  75</span>
<span class="normal">  76</span>
<span class="normal">  77</span>
<span class="normal">  78</span>
<span class="normal">  79</span>
<span class="normal">  80</span>
<span class="normal">  81</span>
<span class="normal">  82</span>
<span class="normal">  83</span>
<span class="normal">  84</span>
<span class="normal">  85</span>
<span class="normal">  86</span>
<span class="normal">  87</span>
<span class="normal">  88</span>
<span class="normal">  89</span>
<span class="normal">  90</span>
<span class="normal">  91</span>
<span class="normal">  92</span>
<span class="normal">  93</span>
<span class="normal">  94</span>
<span class="normal">  95</span>
<span class="normal">  96</span>
<span class="normal">  97</span>
<span class="normal">  98</span>
<span class="normal">  99</span>
<span class="normal"> 100</span>
<span class="normal"> 101</span>
<span class="normal"> 102</span>
<span class="normal"> 103</span>
<span class="normal"> 104</span>
<span class="normal"> 105</span>
<span class="normal"> 106</span>
<span class="normal"> 107</span>
<span class="normal"> 108</span>
<span class="normal"> 109</span>
<span class="normal"> 110</span>
<span class="normal"> 111</span>
<span class="normal"> 112</span>
<span class="normal"> 113</span>
<span class="normal"> 114</span>
<span class="normal"> 115</span>
<span class="normal"> 116</span>
<span class="normal"> 117</span>
<span class="normal"> 118</span>
<span class="normal"> 119</span>
<span class="normal"> 120</span>
<span class="normal"> 121</span>
<span class="normal"> 122</span>
<span class="normal"> 123</span>
<span class="normal"> 124</span>
<span class="normal"> 125</span>
<span class="normal"> 126</span>
<span class="normal"> 127</span>
<span class="normal"> 128</span>
<span class="normal"> 129</span>
<span class="normal"> 130</span>
<span class="normal"> 131</span>
<span class="normal"> 132</span>
<span class="normal"> 133</span>
<span class="normal"> 134</span>
<span class="normal"> 135</span>
<span class="normal"> 136</span>
<span class="normal"> 137</span>
<span class="normal"> 138</span>
<span class="normal"> 139</span>
<span class="normal"> 140</span>
<span class="normal"> 141</span>
<span class="normal"> 142</span>
<span class="normal"> 143</span>
<span class="normal"> 144</span>
<span class="normal"> 145</span>
<span class="normal"> 146</span>
<span class="normal"> 147</span>
<span class="normal"> 148</span>
<span class="normal"> 149</span>
<span class="normal"> 150</span>
<span class="normal"> 151</span>
<span class="normal"> 152</span>
<span class="normal"> 153</span>
<span class="normal"> 154</span>
<span class="normal"> 155</span>
<span class="normal"> 156</span>
<span class="normal"> 157</span>
<span class="normal"> 158</span>
<span class="normal"> 159</span>
<span class="normal"> 160</span>
<span class="normal"> 161</span>
<span class="normal"> 162</span>
<span class="normal"> 163</span>
<span class="normal"> 164</span>
<span class="normal"> 165</span>
<span class="normal"> 166</span>
<span class="normal"> 167</span>
<span class="normal"> 168</span>
<span class="normal"> 169</span>
<span class="normal"> 170</span>
<span class="normal"> 171</span>
<span class="normal"> 172</span>
<span class="normal"> 173</span>
<span class="normal"> 174</span>
<span class="normal"> 175</span>
<span class="normal"> 176</span>
<span class="normal"> 177</span>
<span class="normal"> 178</span>
<span class="normal"> 179</span>
<span class="normal"> 180</span>
<span class="normal"> 181</span>
<span class="normal"> 182</span>
<span class="normal"> 183</span>
<span class="normal"> 184</span>
<span class="normal"> 185</span>
<span class="normal"> 186</span>
<span class="normal"> 187</span>
<span class="normal"> 188</span>
<span class="normal"> 189</span>
<span class="normal"> 190</span>
<span class="normal"> 191</span>
<span class="normal"> 192</span>
<span class="normal"> 193</span>
<span class="normal"> 194</span>
<span class="normal"> 195</span>
<span class="normal"> 196</span>
<span class="normal"> 197</span>
<span class="normal"> 198</span>
<span class="normal"> 199</span>
<span class="normal"> 200</span>
<span class="normal"> 201</span>
<span class="normal"> 202</span>
<span class="normal"> 203</span>
<span class="normal"> 204</span>
<span class="normal"> 205</span>
<span class="normal"> 206</span>
<span class="normal"> 207</span>
<span class="normal"> 208</span>
<span class="normal"> 209</span>
<span class="normal"> 210</span>
<span class="normal"> 211</span>
<span class="normal"> 212</span>
<span class="normal"> 213</span>
<span class="normal"> 214</span>
<span class="normal"> 215</span>
<span class="normal"> 216</span>
<span class="normal"> 217</span>
<span class="normal"> 218</span>
<span class="normal"> 219</span>
<span class="normal"> 220</span>
<span class="normal"> 221</span>
<span class="normal"> 222</span>
<span class="normal"> 223</span>
<span class="normal"> 224</span>
<span class="normal"> 225</span>
<span class="normal"> 226</span>
<span class="normal"> 227</span>
<span class="normal"> 228</span>
<span class="normal"> 229</span>
<span class="normal"> 230</span>
<span class="normal"> 231</span>
<span class="normal"> 232</span>
<span class="normal"> 233</span>
<span class="normal"> 234</span>
<span class="normal"> 235</span>
<span class="normal"> 236</span>
<span class="normal"> 237</span>
<span class="normal"> 238</span>
<span class="normal"> 239</span>
<span class="normal"> 240</span>
<span class="normal"> 241</span>
<span class="normal"> 242</span>
<span class="normal"> 243</span>
<span class="normal"> 244</span>
<span class="normal"> 245</span>
<span class="normal"> 246</span>
<span class="normal"> 247</span>
<span class="normal"> 248</span>
<span class="normal"> 249</span>
<span class="normal"> 250</span>
<span class="normal"> 251</span>
<span class="normal"> 252</span>
<span class="normal"> 253</span>
<span class="normal"> 254</span>
<span class="normal"> 255</span>
<span class="normal"> 256</span>
<span class="normal"> 257</span>
<span class="normal"> 258</span>
<span class="normal"> 259</span>
<span class="normal"> 260</span>
<span class="normal"> 261</span>
<span class="normal"> 262</span>
<span class="normal"> 263</span>
<span class="normal"> 264</span>
<span class="normal"> 265</span>
<span class="normal"> 266</span>
<span class="normal"> 267</span>
<span class="normal"> 268</span>
<span class="normal"> 269</span>
<span class="normal"> 270</span>
<span class="normal"> 271</span>
<span class="normal"> 272</span>
<span class="normal"> 273</span>
<span class="normal"> 274</span>
<span class="normal"> 275</span>
<span class="normal"> 276</span>
<span class="normal"> 277</span>
<span class="normal"> 278</span>
<span class="normal"> 279</span>
<span class="normal"> 280</span>
<span class="normal"> 281</span>
<span class="normal"> 282</span>
<span class="normal"> 283</span>
<span class="normal"> 284</span>
<span class="normal"> 285</span>
<span class="normal"> 286</span>
<span class="normal"> 287</span>
<span class="normal"> 288</span>
<span class="normal"> 289</span>
<span class="normal"> 290</span>
<span class="normal"> 291</span>
<span class="normal"> 292</span>
<span class="normal"> 293</span>
<span class="normal"> 294</span>
<span class="normal"> 295</span>
<span class="normal"> 296</span>
<span class="normal"> 297</span>
<span class="normal"> 298</span>
<span class="normal"> 299</span>
<span class="normal"> 300</span>
<span class="normal"> 301</span>
<span class="normal"> 302</span>
<span class="normal"> 303</span>
<span class="normal"> 304</span>
<span class="normal"> 305</span>
<span class="normal"> 306</span>
<span class="normal"> 307</span>
<span class="normal"> 308</span>
<span class="normal"> 309</span>
<span class="normal"> 310</span>
<span class="normal"> 311</span>
<span class="normal"> 312</span>
<span class="normal"> 313</span>
<span class="normal"> 314</span>
<span class="normal"> 315</span>
<span class="normal"> 316</span>
<span class="normal"> 317</span>
<span class="normal"> 318</span>
<span class="normal"> 319</span>
<span class="normal"> 320</span>
<span class="normal"> 321</span>
<span class="normal"> 322</span>
<span class="normal"> 323</span>
<span class="normal"> 324</span>
<span class="normal"> 325</span>
<span class="normal"> 326</span>
<span class="normal"> 327</span>
<span class="normal"> 328</span>
<span class="normal"> 329</span>
<span class="normal"> 330</span>
<span class="normal"> 331</span>
<span class="normal"> 332</span>
<span class="normal"> 333</span>
<span class="normal"> 334</span>
<span class="normal"> 335</span>
<span class="normal"> 336</span>
<span class="normal"> 337</span>
<span class="normal"> 338</span>
<span class="normal"> 339</span>
<span class="normal"> 340</span>
<span class="normal"> 341</span>
<span class="normal"> 342</span>
<span class="normal"> 343</span>
<span class="normal"> 344</span>
<span class="normal"> 345</span>
<span class="normal"> 346</span>
<span class="normal"> 347</span>
<span class="normal"> 348</span>
<span class="normal"> 349</span>
<span class="normal"> 350</span>
<span class="normal"> 351</span>
<span class="normal"> 352</span>
<span class="normal"> 353</span>
<span class="normal"> 354</span>
<span class="normal"> 355</span>
<span class="normal"> 356</span>
<span class="normal"> 357</span>
<span class="normal"> 358</span>
<span class="normal"> 359</span>
<span class="normal"> 360</span>
<span class="normal"> 361</span>
<span class="normal"> 362</span>
<span class="normal"> 363</span>
<span class="normal"> 364</span>
<span class="normal"> 365</span>
<span class="normal"> 366</span>
<span class="normal"> 367</span>
<span class="normal"> 368</span>
<span class="normal"> 369</span>
<span class="normal"> 370</span>
<span class="normal"> 371</span>
<span class="normal"> 372</span>
<span class="normal"> 373</span>
<span class="normal"> 374</span>
<span class="normal"> 375</span>
<span class="normal"> 376</span>
<span class="normal"> 377</span>
<span class="normal"> 378</span>
<span class="normal"> 379</span>
<span class="normal"> 380</span>
<span class="normal"> 381</span>
<span class="normal"> 382</span>
<span class="normal"> 383</span>
<span class="normal"> 384</span>
<span class="normal"> 385</span>
<span class="normal"> 386</span>
<span class="normal"> 387</span>
<span class="normal"> 388</span>
<span class="normal"> 389</span>
<span class="normal"> 390</span>
<span class="normal"> 391</span>
<span class="normal"> 392</span>
<span class="normal"> 393</span>
<span class="normal"> 394</span>
<span class="normal"> 395</span>
<span class="normal"> 396</span>
<span class="normal"> 397</span>
<span class="normal"> 398</span>
<span class="normal"> 399</span>
<span class="normal"> 400</span>
<span class="normal"> 401</span>
<span class="normal"> 402</span>
<span class="normal"> 403</span>
<span class="normal"> 404</span>
<span class="normal"> 405</span>
<span class="normal"> 406</span>
<span class="normal"> 407</span>
<span class="normal"> 408</span>
<span class="normal"> 409</span>
<span class="normal"> 410</span>
<span class="normal"> 411</span>
<span class="normal"> 412</span>
<span class="normal"> 413</span>
<span class="normal"> 414</span>
<span class="normal"> 415</span>
<span class="normal"> 416</span>
<span class="normal"> 417</span>
<span class="normal"> 418</span>
<span class="normal"> 419</span>
<span class="normal"> 420</span>
<span class="normal"> 421</span>
<span class="normal"> 422</span>
<span class="normal"> 423</span>
<span class="normal"> 424</span>
<span class="normal"> 425</span>
<span class="normal"> 426</span>
<span class="normal"> 427</span>
<span class="normal"> 428</span>
<span class="normal"> 429</span>
<span class="normal"> 430</span>
<span class="normal"> 431</span>
<span class="normal"> 432</span>
<span class="normal"> 433</span>
<span class="normal"> 434</span>
<span class="normal"> 435</span>
<span class="normal"> 436</span>
<span class="normal"> 437</span>
<span class="normal"> 438</span>
<span class="normal"> 439</span>
<span class="normal"> 440</span>
<span class="normal"> 441</span>
<span class="normal"> 442</span>
<span class="normal"> 443</span>
<span class="normal"> 444</span>
<span class="normal"> 445</span>
<span class="normal"> 446</span>
<span class="normal"> 447</span>
<span class="normal"> 448</span>
<span class="normal"> 449</span>
<span class="normal"> 450</span>
<span class="normal"> 451</span>
<span class="normal"> 452</span>
<span class="normal"> 453</span>
<span class="normal"> 454</span>
<span class="normal"> 455</span>
<span class="normal"> 456</span>
<span class="normal"> 457</span>
<span class="normal"> 458</span>
<span class="normal"> 459</span>
<span class="normal"> 460</span>
<span class="normal"> 461</span>
<span class="normal"> 462</span>
<span class="normal"> 463</span>
<span class="normal"> 464</span>
<span class="normal"> 465</span>
<span class="normal"> 466</span>
<span class="normal"> 467</span>
<span class="normal"> 468</span>
<span class="normal"> 469</span>
<span class="normal"> 470</span>
<span class="normal"> 471</span>
<span class="normal"> 472</span>
<span class="normal"> 473</span>
<span class="normal"> 474</span>
<span class="normal"> 475</span>
<span class="normal"> 476</span>
<span class="normal"> 477</span>
<span class="normal"> 478</span>
<span class="normal"> 479</span>
<span class="normal"> 480</span>
<span class="normal"> 481</span>
<span class="normal"> 482</span>
<span class="normal"> 483</span>
<span class="normal"> 484</span>
<span class="normal"> 485</span>
<span class="normal"> 486</span>
<span class="normal"> 487</span>
<span class="normal"> 488</span>
<span class="normal"> 489</span>
<span class="normal"> 490</span>
<span class="normal"> 491</span>
<span class="normal"> 492</span>
<span class="normal"> 493</span>
<span class="normal"> 494</span>
<span class="normal"> 495</span>
<span class="normal"> 496</span>
<span class="normal"> 497</span>
<span class="normal"> 498</span>
<span class="normal"> 499</span>
<span class="normal"> 500</span>
<span class="normal"> 501</span>
<span class="normal"> 502</span>
<span class="normal"> 503</span>
<span class="normal"> 504</span>
<span class="normal"> 505</span>
<span class="normal"> 506</span>
<span class="normal"> 507</span>
<span class="normal"> 508</span>
<span class="normal"> 509</span>
<span class="normal"> 510</span>
<span class="normal"> 511</span>
<span class="normal"> 512</span>
<span class="normal"> 513</span>
<span class="normal"> 514</span>
<span class="normal"> 515</span>
<span class="normal"> 516</span>
<span class="normal"> 517</span>
<span class="normal"> 518</span>
<span class="normal"> 519</span>
<span class="normal"> 520</span>
<span class="normal"> 521</span>
<span class="normal"> 522</span>
<span class="normal"> 523</span>
<span class="normal"> 524</span>
<span class="normal"> 525</span>
<span class="normal"> 526</span>
<span class="normal"> 527</span>
<span class="normal"> 528</span>
<span class="normal"> 529</span>
<span class="normal"> 530</span>
<span class="normal"> 531</span>
<span class="normal"> 532</span>
<span class="normal"> 533</span>
<span class="normal"> 534</span>
<span class="normal"> 535</span>
<span class="normal"> 536</span>
<span class="normal"> 537</span>
<span class="normal"> 538</span>
<span class="normal"> 539</span>
<span class="normal"> 540</span>
<span class="normal"> 541</span>
<span class="normal"> 542</span>
<span class="normal"> 543</span>
<span class="normal"> 544</span>
<span class="normal"> 545</span>
<span class="normal"> 546</span>
<span class="normal"> 547</span>
<span class="normal"> 548</span>
<span class="normal"> 549</span>
<span class="normal"> 550</span>
<span class="normal"> 551</span>
<span class="normal"> 552</span>
<span class="normal"> 553</span>
<span class="normal"> 554</span>
<span class="normal"> 555</span>
<span class="normal"> 556</span>
<span class="normal"> 557</span>
<span class="normal"> 558</span>
<span class="normal"> 559</span>
<span class="normal"> 560</span>
<span class="normal"> 561</span>
<span class="normal"> 562</span>
<span class="normal"> 563</span>
<span class="normal"> 564</span>
<span class="normal"> 565</span>
<span class="normal"> 566</span>
<span class="normal"> 567</span>
<span class="normal"> 568</span>
<span class="normal"> 569</span>
<span class="normal"> 570</span>
<span class="normal"> 571</span>
<span class="normal"> 572</span>
<span class="normal"> 573</span>
<span class="normal"> 574</span>
<span class="normal"> 575</span>
<span class="normal"> 576</span>
<span class="normal"> 577</span>
<span class="normal"> 578</span>
<span class="normal"> 579</span>
<span class="normal"> 580</span>
<span class="normal"> 581</span>
<span class="normal"> 582</span>
<span class="normal"> 583</span>
<span class="normal"> 584</span>
<span class="normal"> 585</span>
<span class="normal"> 586</span>
<span class="normal"> 587</span>
<span class="normal"> 588</span>
<span class="normal"> 589</span>
<span class="normal"> 590</span>
<span class="normal"> 591</span>
<span class="normal"> 592</span>
<span class="normal"> 593</span>
<span class="normal"> 594</span>
<span class="normal"> 595</span>
<span class="normal"> 596</span>
<span class="normal"> 597</span>
<span class="normal"> 598</span>
<span class="normal"> 599</span>
<span class="normal"> 600</span>
<span class="normal"> 601</span>
<span class="normal"> 602</span>
<span class="normal"> 603</span>
<span class="normal"> 604</span>
<span class="normal"> 605</span>
<span class="normal"> 606</span>
<span class="normal"> 607</span>
<span class="normal"> 608</span>
<span class="normal"> 609</span>
<span class="normal"> 610</span>
<span class="normal"> 611</span>
<span class="normal"> 612</span>
<span class="normal"> 613</span>
<span class="normal"> 614</span>
<span class="normal"> 615</span>
<span class="normal"> 616</span>
<span class="normal"> 617</span>
<span class="normal"> 618</span>
<span class="normal"> 619</span>
<span class="normal"> 620</span>
<span class="normal"> 621</span>
<span class="normal"> 622</span>
<span class="normal"> 623</span>
<span class="normal"> 624</span>
<span class="normal"> 625</span>
<span class="normal"> 626</span>
<span class="normal"> 627</span>
<span class="normal"> 628</span>
<span class="normal"> 629</span>
<span class="normal"> 630</span>
<span class="normal"> 631</span>
<span class="normal"> 632</span>
<span class="normal"> 633</span>
<span class="normal"> 634</span>
<span class="normal"> 635</span>
<span class="normal"> 636</span>
<span class="normal"> 637</span>
<span class="normal"> 638</span>
<span class="normal"> 639</span>
<span class="normal"> 640</span>
<span class="normal"> 641</span>
<span class="normal"> 642</span>
<span class="normal"> 643</span>
<span class="normal"> 644</span>
<span class="normal"> 645</span>
<span class="normal"> 646</span>
<span class="normal"> 647</span>
<span class="normal"> 648</span>
<span class="normal"> 649</span>
<span class="normal"> 650</span>
<span class="normal"> 651</span>
<span class="normal"> 652</span>
<span class="normal"> 653</span>
<span class="normal"> 654</span>
<span class="normal"> 655</span>
<span class="normal"> 656</span>
<span class="normal"> 657</span>
<span class="normal"> 658</span>
<span class="normal"> 659</span>
<span class="normal"> 660</span>
<span class="normal"> 661</span>
<span class="normal"> 662</span>
<span class="normal"> 663</span>
<span class="normal"> 664</span>
<span class="normal"> 665</span>
<span class="normal"> 666</span>
<span class="normal"> 667</span>
<span class="normal"> 668</span>
<span class="normal"> 669</span>
<span class="normal"> 670</span>
<span class="normal"> 671</span>
<span class="normal"> 672</span>
<span class="normal"> 673</span>
<span class="normal"> 674</span>
<span class="normal"> 675</span>
<span class="normal"> 676</span>
<span class="normal"> 677</span>
<span class="normal"> 678</span>
<span class="normal"> 679</span>
<span class="normal"> 680</span>
<span class="normal"> 681</span>
<span class="normal"> 682</span>
<span class="normal"> 683</span>
<span class="normal"> 684</span>
<span class="normal"> 685</span>
<span class="normal"> 686</span>
<span class="normal"> 687</span>
<span class="normal"> 688</span>
<span class="normal"> 689</span>
<span class="normal"> 690</span>
<span class="normal"> 691</span>
<span class="normal"> 692</span>
<span class="normal"> 693</span>
<span class="normal"> 694</span>
<span class="normal"> 695</span>
<span class="normal"> 696</span>
<span class="normal"> 697</span>
<span class="normal"> 698</span>
<span class="normal"> 699</span>
<span class="normal"> 700</span>
<span class="normal"> 701</span>
<span class="normal"> 702</span>
<span class="normal"> 703</span>
<span class="normal"> 704</span>
<span class="normal"> 705</span>
<span class="normal"> 706</span>
<span class="normal"> 707</span>
<span class="normal"> 708</span>
<span class="normal"> 709</span>
<span class="normal"> 710</span>
<span class="normal"> 711</span>
<span class="normal"> 712</span>
<span class="normal"> 713</span>
<span class="normal"> 714</span>
<span class="normal"> 715</span>
<span class="normal"> 716</span>
<span class="normal"> 717</span>
<span class="normal"> 718</span>
<span class="normal"> 719</span>
<span class="normal"> 720</span>
<span class="normal"> 721</span>
<span class="normal"> 722</span>
<span class="normal"> 723</span>
<span class="normal"> 724</span>
<span class="normal"> 725</span>
<span class="normal"> 726</span>
<span class="normal"> 727</span>
<span class="normal"> 728</span>
<span class="normal"> 729</span>
<span class="normal"> 730</span>
<span class="normal"> 731</span>
<span class="normal"> 732</span>
<span class="normal"> 733</span>
<span class="normal"> 734</span>
<span class="normal"> 735</span>
<span class="normal"> 736</span>
<span class="normal"> 737</span>
<span class="normal"> 738</span>
<span class="normal"> 739</span>
<span class="normal"> 740</span>
<span class="normal"> 741</span>
<span class="normal"> 742</span>
<span class="normal"> 743</span>
<span class="normal"> 744</span>
<span class="normal"> 745</span>
<span class="normal"> 746</span>
<span class="normal"> 747</span>
<span class="normal"> 748</span>
<span class="normal"> 749</span>
<span class="normal"> 750</span>
<span class="normal"> 751</span>
<span class="normal"> 752</span>
<span class="normal"> 753</span>
<span class="normal"> 754</span>
<span class="normal"> 755</span>
<span class="normal"> 756</span>
<span class="normal"> 757</span>
<span class="normal"> 758</span>
<span class="normal"> 759</span>
<span class="normal"> 760</span>
<span class="normal"> 761</span>
<span class="normal"> 762</span>
<span class="normal"> 763</span>
<span class="normal"> 764</span>
<span class="normal"> 765</span>
<span class="normal"> 766</span>
<span class="normal"> 767</span>
<span class="normal"> 768</span>
<span class="normal"> 769</span>
<span class="normal"> 770</span>
<span class="normal"> 771</span>
<span class="normal"> 772</span>
<span class="normal"> 773</span>
<span class="normal"> 774</span>
<span class="normal"> 775</span>
<span class="normal"> 776</span>
<span class="normal"> 777</span>
<span class="normal"> 778</span>
<span class="normal"> 779</span>
<span class="normal"> 780</span>
<span class="normal"> 781</span>
<span class="normal"> 782</span>
<span class="normal"> 783</span>
<span class="normal"> 784</span>
<span class="normal"> 785</span>
<span class="normal"> 786</span>
<span class="normal"> 787</span>
<span class="normal"> 788</span>
<span class="normal"> 789</span>
<span class="normal"> 790</span>
<span class="normal"> 791</span>
<span class="normal"> 792</span>
<span class="normal"> 793</span>
<span class="normal"> 794</span>
<span class="normal"> 795</span>
<span class="normal"> 796</span>
<span class="normal"> 797</span>
<span class="normal"> 798</span>
<span class="normal"> 799</span>
<span class="normal"> 800</span>
<span class="normal"> 801</span>
<span class="normal"> 802</span>
<span class="normal"> 803</span>
<span class="normal"> 804</span>
<span class="normal"> 805</span>
<span class="normal"> 806</span>
<span class="normal"> 807</span>
<span class="normal"> 808</span>
<span class="normal"> 809</span>
<span class="normal"> 810</span>
<span class="normal"> 811</span>
<span class="normal"> 812</span>
<span class="normal"> 813</span>
<span class="normal"> 814</span>
<span class="normal"> 815</span>
<span class="normal"> 816</span>
<span class="normal"> 817</span>
<span class="normal"> 818</span>
<span class="normal"> 819</span>
<span class="normal"> 820</span>
<span class="normal"> 821</span>
<span class="normal"> 822</span>
<span class="normal"> 823</span>
<span class="normal"> 824</span>
<span class="normal"> 825</span>
<span class="normal"> 826</span>
<span class="normal"> 827</span>
<span class="normal"> 828</span>
<span class="normal"> 829</span>
<span class="normal"> 830</span>
<span class="normal"> 831</span>
<span class="normal"> 832</span>
<span class="normal"> 833</span>
<span class="normal"> 834</span>
<span class="normal"> 835</span>
<span class="normal"> 836</span>
<span class="normal"> 837</span>
<span class="normal"> 838</span>
<span class="normal"> 839</span>
<span class="normal"> 840</span>
<span class="normal"> 841</span>
<span class="normal"> 842</span>
<span class="normal"> 843</span>
<span class="normal"> 844</span>
<span class="normal"> 845</span>
<span class="normal"> 846</span>
<span class="normal"> 847</span>
<span class="normal"> 848</span>
<span class="normal"> 849</span>
<span class="normal"> 850</span>
<span class="normal"> 851</span>
<span class="normal"> 852</span>
<span class="normal"> 853</span>
<span class="normal"> 854</span>
<span class="normal"> 855</span>
<span class="normal"> 856</span>
<span class="normal"> 857</span>
<span class="normal"> 858</span>
<span class="normal"> 859</span>
<span class="normal"> 860</span>
<span class="normal"> 861</span>
<span class="normal"> 862</span>
<span class="normal"> 863</span>
<span class="normal"> 864</span>
<span class="normal"> 865</span>
<span class="normal"> 866</span>
<span class="normal"> 867</span>
<span class="normal"> 868</span>
<span class="normal"> 869</span>
<span class="normal"> 870</span>
<span class="normal"> 871</span>
<span class="normal"> 872</span>
<span class="normal"> 873</span>
<span class="normal"> 874</span>
<span class="normal"> 875</span>
<span class="normal"> 876</span>
<span class="normal"> 877</span>
<span class="normal"> 878</span>
<span class="normal"> 879</span>
<span class="normal"> 880</span>
<span class="normal"> 881</span>
<span class="normal"> 882</span>
<span class="normal"> 883</span>
<span class="normal"> 884</span>
<span class="normal"> 885</span>
<span class="normal"> 886</span>
<span class="normal"> 887</span>
<span class="normal"> 888</span>
<span class="normal"> 889</span>
<span class="normal"> 890</span>
<span class="normal"> 891</span>
<span class="normal"> 892</span>
<span class="normal"> 893</span>
<span class="normal"> 894</span>
<span class="normal"> 895</span>
<span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span>
<span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span>
<span class="normal">1291</span>
<span class="normal">1292</span>
<span class="normal">1293</span>
<span class="normal">1294</span>
<span class="normal">1295</span>
<span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span>
<span class="normal">1332</span>
<span class="normal">1333</span>
<span class="normal">1334</span>
<span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span>
<span class="normal">1358</span>
<span class="normal">1359</span>
<span class="normal">1360</span>
<span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span>
<span class="normal">1389</span>
<span class="normal">1390</span>
<span class="normal">1391</span>
<span class="normal">1392</span>
<span class="normal">1393</span>
<span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span>
<span class="normal">1452</span>
<span class="normal">1453</span>
<span class="normal">1454</span>
<span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span>
<span class="normal">1501</span>
<span class="normal">1502</span>
<span class="normal">1503</span>
<span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span>
<span class="normal">1566</span>
<span class="normal">1567</span>
<span class="normal">1568</span>
<span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DiffReasoner</span><span class="p">(</span><span class="n">Reasoner</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># CONSTRAINT / PROPAGATOR GROUP (&amp; ITS ID), ENABLERS, PROPAGATORS DATABASE</span>
    <span class="c1">#############################################################################</span>

    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">PropaGroup</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents a group of (elementary) propagators, that only differ by their</span>
<span class="sd">        enabling conditions (i.e. `potential_enablers`).</span>

<span class="sd">        A (elementary) propagator represents the fact that an update on its</span>
<span class="sd">        `source` bound should be reflected on its `target` bound when some</span>
<span class="sd">        conditions (the enabling conditions) hold.</span>

<span class="sd">        FIXME: As such, by abuse of language/notation, a propagator can be seen as</span>
<span class="sd">        an encoding for a (directed) edge of an STN / difference constraint between two variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Source signed variable of the propagator.&quot;&quot;&quot;</span>

        <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Target signed variable of the propagator.&quot;&quot;&quot;</span>

        <span class="n">weight</span><span class="p">:</span> <span class="n">BoundVal</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Weight of the propagator.&quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">enabler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]</span> <span class="c1">#FIXME rename to current_enabler ?</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The enabler of the propagators of the group.</span>

<span class="sd">        It is non-None when the group / its propagators are active</span>
<span class="sd">        (i.e. participate in propagation).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">potential_enablers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A set of potential enablers for (all) the propagators of the group.</span>

<span class="sd">        The group / all the propagators it represents become enabled once</span>
<span class="sd">        one of these enablers&#39; active and valid literals become True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">class</span> <span class="nc">PropaGroupId</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">class</span> <span class="nc">Enabler</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents the conditions for a propagator to be enabled, which is for</span>
<span class="sd">        literals `active` and `valid` to both be true.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">active</span><span class="p">:</span> <span class="n">Lit</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When this literal is present (i.e. its variable is present), then it is</span>
<span class="sd">        true iff the propagators (enabled by this enabler) are active.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">valid</span><span class="p">:</span> <span class="n">Lit</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This literal is true iff the propagators (enabled by this enabler) are</span>
<span class="sd">        within its validity scope (i.e. when it is known to be sound to propagate</span>
<span class="sd">        a change from the propagator&#39;s source to the propagator&#39;s target)</span>

<span class="sd">        In the simplest cast, `valid = presence(active)` (since by construction</span>
<span class="sd">        `presence(active)` is true iff both the source and the target of the</span>
<span class="sd">        propagator are present).</span>

<span class="sd">        `valid` may be a more specific literal, but it always satisfies that</span>
<span class="sd">        `presence(active) =&gt; valid`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="nd">@dataclass</span>
<span class="c1">#    class ConstraintsDatabase():</span>
    <span class="k">class</span> <span class="nc">PropaDatabase</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Holds all active and inactive difference constraints / edges.</span>

<span class="sd">        This includes propagators corresponding to the negation of inserted difference constraints / edges</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_propagator_group_id_counter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
        <span class="n">propagators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroup</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stores all propagators (both active and inactive) as groups or &quot;bundles&quot; of</span>
<span class="sd">        propagators sharing their source, target, and weight.</span>

<span class="sd">        Each difference constraint / edge (i.e. v2-v1 &lt;= d, i.e. v1 --d-&gt; v2)</span>
<span class="sd">        in the STN) added is converted into 4 propagators, which correspond to:</span>
<span class="sd">        - the forward (source -&gt; target) view of the &quot;canonical&quot; (i.e. &quot;normal&quot;) edge</span>
<span class="sd">        - the backward (target -&gt; source) view of the &quot;canonical&quot; (i.e. &quot;normal&quot;) edge</span>
<span class="sd">        - the forward (source -&gt; target) view of the &quot;negated&quot; (i.e. negation of canonical) edge</span>
<span class="sd">        - the backward (target -&gt; source) view of the &quot;negated&quot; (i.e. negation of canonical) edge</span>

<span class="sd">        Make no mistake, at no point will those 4 propagators be part of the same group !</span>
<span class="sd">        None of them have the same source, target, and weight !</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">propagators_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ordered view of `propagators` (their IDs).&quot;&quot;&quot;</span>

        <span class="n">propagators_source_and_target</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Associates (source, target) signed variable pairs to (IDs of)</span>
<span class="sd">        propagators defined between them.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">intermittent_propagators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">Lit</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stores propagators whose activity depends on the current state</span>
<span class="sd">        (i.e. which may or may not be active, depending on the current state).</span>

<span class="sd">        Encoding as a dictionary:</span>
<span class="sd">        - The key corresponds to the source of a propagator</span>
<span class="sd">        - The value for that key / propagator source is a list of (target, weight, presence),</span>
<span class="sd">        for each encoded propagator.</span>

<span class="sd">        Here, &quot;presence&quot; corresponds to a literal that is true iff the</span>
<span class="sd">        edge / propagator must be present.</span>
<span class="sd">        REVIEW: same thing as &quot;valid&quot; or not ?</span>
<span class="sd">        Note that handling of optional variables might allow an edge to</span>
<span class="sd">        propagate even if it is not known to be present yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">watchlists</span><span class="p">:</span> <span class="n">SetGuardedByLiterals</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">SetGuardedByLiterals</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Associates literals to propagators (with an enabler) that should be activated</span>
<span class="sd">        when they become true.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">propagator_groups_events_trail</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:[[]])</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Holds the trail of &quot;propagator groups events&quot;, i.e. updates on propagator groups:</span>
<span class="sd">        - A None element designates the addition of a new propagator group.</span>
<span class="sd">        - A (PropagatorGroupId, Enabler) tuple designates the addition of</span>
<span class="sd">        the specified enabler to the set of potential enablers of the</span>
<span class="sd">        propagator group with the specified id.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">next_new_constraint_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># THEORY PROPAGATION CAUSES, INFERENCE CAUSES</span>
    <span class="c1">#############################################################################</span>

    <span class="k">class</span> <span class="nc">TheoryPropCauses</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A container / &quot;namespace&quot; for structures describing the kinds of causes</span>
<span class="sd">        for an active shortest path to trigger theory propagation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">class</span> <span class="nc">Path</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Represents a theory propagation cause corresponding to the activation</span>
<span class="sd">            of the propagators represented by `triggering_propagator_group_id`.</span>

<span class="sd">            (In other words, the activation/&quot;appearance&quot; of a new shortest path between</span>
<span class="sd">            `source` and `target`, going through the edge represented by the</span>
<span class="sd">            propagators corresponding to `triggering_propagator_group_id`)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span>
            <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span>
            <span class="n">triggering_propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">class</span> <span class="nc">Bounds</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Represents a theory propagation cause corresponding to the incompability</span>
<span class="sd">            of the `source_lit` and `target_lit` literals with an &quot;edge&quot; (propagator group).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">source_lit</span><span class="p">:</span> <span class="n">Lit</span>
            <span class="n">target_lit</span><span class="p">:</span> <span class="n">Lit</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">AnyCause</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span>
                         <span class="n">Bounds</span><span class="p">]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Any theory propagation cause.&quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">class</span> <span class="nc">InferenceCauses</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span> <span class="c1"># FIXME: rename to InferenceKinds ?</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A container / &quot;namespace&quot; for structures describing the causes that can</span>
<span class="sd">        trigger an inference (i.e. bound value update, calling `set_bound_value`</span>
<span class="sd">        in the main solver) made during propagation in this reasoner.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">class</span> <span class="nc">EdgeProp</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Represents a inference cause corresponding to an edge propagation</span>
<span class="sd">            (of the given edge / propagator group)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">class</span> <span class="nc">TheoryProp</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Represents a inference cause corresponding to a theory propagation.</span>
<span class="sd">            That theory propagation&#39;s own cause was registered at the</span>
<span class="sd">            given index in `theory_propagation_causes`.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">theory_propagation_cause_index</span><span class="p">:</span> <span class="nb">int</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">AnyCause</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">EdgeProp</span><span class="p">,</span>
                         <span class="n">TheoryProp</span><span class="p">]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Any cause for an inference (made by this reasoner).&quot;&quot;&quot;</span>

    <span class="c1">#############################################################################</span>
    <span class="c1">#  DIJKSTRA STATE</span>
    <span class="c1">#############################################################################</span>

    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">DijkstraState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A data structure that contains the mutable data that is updated during</span>
<span class="sd">        a Dijkstra algorithm. It is intended to be reusable across multiple runs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">latest</span><span class="p">:</span> <span class="n">BoundVal</span> <span class="o">=</span> <span class="n">BoundVal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The latest distance that was extract from the queue. As a property of the</span>
<span class="sd">        Dijkstra algorithm, if a distance in the `distances` table is less than or</span>
<span class="sd">        equal to this value, then it will not change for the rest of the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">distances</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Associates each vertex to its distance. If the node is not an origin, it</span>
<span class="sd">        also indicates the latest edge on the shortest path to this node.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">queue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Elements of the queue that have not been extracted yet.</span>
<span class="sd">        Note that a single node might appear several times in the queue,</span>
<span class="sd">        in which case only the one with the smallest distance is relevant.</span>

<span class="sd">        Represented with Python&#39;s heapq, which is a min-heap.</span>

<span class="sd">        The SignedVar corresponds to a node and the BoundVal corresponds</span>
<span class="sd">        to the reduced distance from the origin to this node. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">=</span> <span class="n">BoundVal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
            <span class="n">dist</span><span class="p">:</span> <span class="n">BoundVal</span><span class="p">,</span>
            <span class="n">incoming_edge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Add a node to the queue, indicating the distance from the origin and</span>
<span class="sd">            the latest edge on the path from the origin to this node.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">previous_dist</span> <span class="o">=</span> <span class="n">MAX_INT</span>  <span class="c1"># FIXME: should be max int</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">previous_dist</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">previous_dist</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">incoming_edge</span><span class="p">)</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">dequeue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Remove the next element in the queue.</span>
<span class="sd">            Nodes are removed by increasing distance to the origin.</span>
<span class="sd">            Each node can only be extracted once.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>

            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">&lt;=</span> <span class="n">dist</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dist</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">=</span> <span class="n">dist</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">dist</span><span class="p">:</span>
                <span class="c1"># Node with the best distance from origin</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># A node with a better distance was previousl extracted,</span>
                <span class="c1"># ignore this one as it cannot contribute to a shortest path</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns the distance from the origin to this node,</span>
<span class="sd">            or None if the node was not reached by Dijkstra&#39;s algorithm</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">reached_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns an iterator over all nodes (and their distances</span>
<span class="sd">            from the origin) that were reached by the algorithm.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="p">,(</span><span class="n">d</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">predecessor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns the predecessor edge from the origin to this</span>
<span class="sd">            node or None if it is an origin.</span>

<span class="sd">            Will raise an error if the node has no associated distance</span>
<span class="sd">            (i.e. was not reached by the algorithm)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">is_final</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns true if the node has a distance that is guaranteed not to</span>
<span class="sd">            change in subsequent iterations.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest</span>

    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="n">SolverState</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">:</span> <span class="n">SolverState</span> <span class="o">=</span> <span class="n">state</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaDatabase</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaDatabase</span><span class="p">()</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[[]]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trail of propagation events metadata. Outer list index: decision level.</span>
<span class="sd">        Inner list content corresponds to either:</span>
<span class="sd">            - Activation of a propagator group (DiffReasoner.PropagatorGroupId - ID</span>
<span class="sd">            of that propagator group).</span>
<span class="sd">            - Triggering of theory propagation and registration of its cause (None).</span>
<span class="sd">              The corresponding TheoryPropagationCauses.AnyCause is appended to a</span>
<span class="sd">              list (`theory_propagation_causes`).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">AnyCause</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List / history of theory propagation causes. A theory propagation cause is</span>
<span class="sd">        added to this list when a None object is added to the trail of propagation </span>
<span class="sd">        events metadata (`propagation_metadata_trail`).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">next_unprocessed_solver_event_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
<span class="c1">#</span>
<span class="c1">#        self.num_propagations: int = 0</span>
<span class="c1">#</span>
<span class="c1">#        self.num_distance_updates: int = 0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SolverState</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># (REIFIED) DIFFERENCE CONSTRAINT ADDITION</span>
    <span class="c1">#############################################################################</span>

    <span class="c1"># def add_reified_stn_edge(self,</span>
    <span class="k">def</span> <span class="nf">add_reified_difference_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">reification_literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span>
        <span class="n">weight</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new difference constraint (`target - source &lt;= weight`), i.e. STN</span>
<span class="sd">        edge (source --weight--&gt; target), which was already reified into `reification_literal`.</span>

<span class="sd">        This is done by following these steps:</span>

<span class="sd">        1. Decompose the difference constraint into 4 propagators, which will be</span>
<span class="sd">        &quot;active&quot; iff `reification_literal` is true, and &quot;valid&quot; iff the variable</span>
<span class="sd">        of their target signed variable is present. (see `Enabler`).</span>

<span class="sd">        And then for each of these 4 propagators:</span>

<span class="sd">        2. Integrate the new propagator to the propagator database (recall that </span>
<span class="sd">        a propagator group &quot;bundles&quot; propagators which only differ by enabling conditions)).</span>
<span class="sd">        For each new propagator, this is done by either:</span>

<span class="sd">            - Merging / adding the new propagator into an existing group</span>
<span class="sd">            of propagators, by adding its enabler to their `potential_enablers`.</span>

<span class="sd">            - Tightening an already active existing group of propagators</span>
<span class="sd">            (superseded by the new propagator), by setting their weight to</span>
<span class="sd">            the new propagator&#39;s weight.</span>

<span class="sd">            - Ignoring the new propagator, if it is redundant with an</span>
<span class="sd">            existing one (i.e. if its weight is weaker than an existing</span>
<span class="sd">            propagator&#39;s with the same enabling conditions).</span>

<span class="sd">            - Creating a new propagator group with the new propagator&#39;s enabler,</span>
<span class="sd">            if there are no existing propagators with the same source and target.</span>

<span class="sd">        NOTE that merging, tightening, or ignoring is only done when the solver</span>
<span class="sd">        is at the top decision level. Beyond the top decision level, we always choose </span>
<span class="sd">        to create a new propagator group, because it would be too complicated to</span>
<span class="sd">        undo/backtrack the reorganization of a propagator group.</span>

<span class="sd">        3. Postprocess the integration of the new propagator. The two possibilities are the following:</span>

<span class="sd">            - Either set the propagators of the group (to which the new propagator was added)</span>
<span class="sd">            as pending for activation, if the enabling conditions of the new propagator</span>
<span class="sd">            are satisfied (`active` and `valid` literals of its enabler are true).</span>

<span class="sd">            - Or set watch on the enabling conditions of the new propagator (the `active`</span>
<span class="sd">            and `valid` literals of its enabler), if they aren&#39;t known to be true yet, so</span>
<span class="sd">            that we&#39;re notified when one of them becomes true. (If both of them are true,</span>
<span class="sd">            the propagator group will be staged as pending for activation).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">integrate_propagator_to_database</span><span class="p">(</span>
            <span class="n">src</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
            <span class="n">tgt</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
            <span class="n">wgt</span><span class="p">:</span> <span class="n">BoundVal</span><span class="p">,</span> 
            <span class="n">eblr</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Integrates a new propagator (defined by the arguments) to the propagator database.</span>
<span class="sd">            See step 2 (function documentation).</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># Only optimize organisation of propagator groups at the top decision level,</span>
            <span class="c1"># because if done at a decision level beyond, it would to complex to undo/backtrack</span>
            <span class="c1"># the changes made to the groups.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">),</span> <span class="p">[])</span>

                <span class="c1"># Search for a propagator group compatible with this propagator (same source and target)</span>
                <span class="k">for</span> <span class="n">existing_group_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)]:</span>
                    <span class="n">existing_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">existing_group_id</span><span class="p">]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">existing_group</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">src</span>
                            <span class="ow">and</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="c1"># If there is a compatible propagator group:</span>

                    <span class="c1"># If the group has the same weight as the propagator, either merge the</span>
                    <span class="c1"># propagator into the group by adding its enabler to it, if it isn&#39;t redundant,</span>
                    <span class="c1"># or ignore it and do nothing if it is.</span>
                    <span class="k">if</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="n">wgt</span><span class="p">:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">eblr</span> <span class="ow">in</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">:</span>
                            <span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eblr</span><span class="p">)</span>
                            <span class="k">return</span> <span class="p">(</span><span class="n">existing_group_id</span><span class="p">,</span> <span class="s2">&quot;merging&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="p">(</span><span class="n">existing_group_id</span><span class="p">,</span> <span class="s2">&quot;ignoring&quot;</span><span class="p">)</span>


                    <span class="c1"># If the propagator&#39;s weight is strictly stronger than that of</span>
                    <span class="c1"># the group and they have the same one enabler, then just tighten</span>
                    <span class="c1"># the group by changing its weight to that of the propagator.</span>
                    <span class="k">elif</span> <span class="n">wgt</span><span class="o">.</span><span class="n">is_stronger_than</span><span class="p">(</span><span class="n">existing_group</span><span class="o">.</span><span class="n">weight</span><span class="o">-</span><span class="n">BoundVal</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="ow">and</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">eblr</span>
                        <span class="p">):</span>
                            <span class="k">continue</span>

                        <span class="k">if</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="p">:</span>
                            <span class="c1"># note that since we consider the case where there&#39;s only one potential enabler,</span>
                            <span class="c1"># there can only be 1 intermittent propagator.</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="p">[</span><span class="n">src</span><span class="p">])):</span>

                                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                                    <span class="o">==</span> <span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
                                <span class="p">):</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">wgt</span><span class="p">,</span> <span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
                                    <span class="k">break</span>

                        <span class="n">existing_group</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">wgt</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">existing_group_id</span><span class="p">,</span> <span class="s2">&quot;tightening&quot;</span><span class="p">)</span>

                    <span class="c1"># If the propagator&#39;s weight is weaker than that of the group and they have the same one enabler,</span>
                    <span class="c1"># ignore the propagator and do nothing, because it is redundant.</span>
                    <span class="k">elif</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">is_stronger_than</span><span class="p">(</span><span class="n">BoundVal</span><span class="p">(</span><span class="n">wgt</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                            <span class="ow">and</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">eblr</span>
                        <span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">existing_group_id</span><span class="p">,</span> <span class="s2">&quot;ignoring&quot;</span><span class="p">)</span>

            <span class="c1"># If the propagator couldn&#39;t be unified / integrated with an existing</span>
            <span class="c1"># propagator group, then just create a new propagator group for it.</span>

            <span class="n">created_group_id</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">_propagator_group_id_counter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">_propagator_group_id_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">created_group_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroup</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">wgt</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">eblr</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">created_group_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span> \
                <span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">),</span> <span class="p">[])</span>                         \
                <span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">created_group_id</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">created_group_id</span><span class="p">,</span> <span class="s2">&quot;creating&quot;</span><span class="p">)</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">postprocess_propagator_integration_into_database</span><span class="p">(</span>
            <span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span>
            <span class="n">propagator_integrated_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">eblr</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Postprocesses the integration to the propagators database of a new propagator.</span>
<span class="sd">            See step 3 (function documentation).</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="c1"># NOTE: The case of propagator_integrated_by == &quot;ignoring&quot; is dealt in the main function.</span>

            <span class="c1"># If propagator was created into a new group or was merged into an existing one,</span>
            <span class="c1"># there are different possibilities, depending on whether it is currently enabled</span>
            <span class="c1"># or not.FIXME: Note that we should make sure that when backtracking beyond the</span>
            <span class="c1"># current decision level, we should deactivate the edge</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">propagator_integrated_by</span> <span class="o">==</span> <span class="s2">&quot;creating&quot;</span> 
                <span class="ow">or</span> <span class="n">propagator_integrated_by</span> <span class="o">==</span> <span class="s2">&quot;merging&quot;</span>
            <span class="p">):</span>
                <span class="c1"># If the propagator can never be active/present, do nothing.</span>
                <span class="n">edge_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">edge_valid</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">return</span>

                <span class="c1"># If the propagator is always active in the current (and following) decision</span>
                <span class="c1"># levels, enqueue it for activation.</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">eblr</span><span class="p">))</span>

                <span class="c1"># If the propagator isn&#39;t known to be active or inactive yet, </span>
                <span class="c1"># record the fact that:</span>
                <span class="c1"># - If the enabling conditions hold (`enabler.valid` and `enabler.active` are true),</span>
                <span class="c1">#   then the propagator should be enabled</span>
                <span class="c1"># - If the propagator is inconsistent, then the `enabler.active` should be made false</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># Set a watch on both `enabler.active` and `enabler.valid` literals</span>
                    <span class="c1"># (when one of them becomes true, we will still have to check that the</span>
                    <span class="c1"># other one becomes true as well)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">watchlists</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">eblr</span><span class="p">),</span> <span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">watchlists</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">eblr</span><span class="p">),</span> <span class="n">eblr</span><span class="o">.</span><span class="n">valid</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
                            <span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span> \
                        <span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">eblr</span><span class="p">))</span>

            <span class="c1"># If an existing group was tightened (as a result of</span>
            <span class="c1"># a new propagator&#39;s integration into the database), then:</span>
            <span class="c1"># - If the group wasn&#39;t already active, we don&#39;t need to do anything.</span>
            <span class="c1"># - If the group was already active, we need to force its propagation</span>
            <span class="c1">#   (which we do by &quot;pretending&quot; it was previously inactive and then</span>
            <span class="c1">#   enqueuing it for activation)</span>
            <span class="k">elif</span> <span class="n">propagator_integrated_by</span> <span class="o">==</span> <span class="s2">&quot;tightening&quot;</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span><span class="o">.</span><span class="n">enabler</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">eblr</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="c1"># Step 1: (see function documentation)</span>

        <span class="c1"># The validity scope of the reification literal is known to be the</span>
        <span class="c1"># conjunctive scope of the source and target variables of the edge / constraint.</span>
        <span class="c1"># </span>
        <span class="c1"># As such, the edge is valid / well-defined iff its reification literal is</span>
        <span class="c1"># present (iff the source and target variables of the edge are both present)</span>
        <span class="n">edge_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">reification_literal</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_implication_true</span><span class="p">(</span><span class="n">edge_valid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_implication_true</span><span class="p">(</span><span class="n">edge_valid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

        <span class="c1"># The edge will be decomposed into 4 propagators:</span>
        <span class="c1"># 2 &quot;canonical&quot;, and 2 &quot;negated&quot; (or &quot;inverted&quot;: swapped source and target for them).</span>
        <span class="c1"># </span>
        <span class="c1"># A &quot;canonical&quot; (source-to-target) propagator is valid</span>
        <span class="c1"># when `presence(target) =&gt; edge_valid`. This is because modifying</span>
        <span class="c1"># the target&#39;s domain is only meaningful if the edge is present.</span>
        <span class="c1"># Analogously, a &quot;negated&quot; (target-to-source) propagator is valid</span>
        <span class="c1"># when `presence(source) =&gt; edge_valid`.</span>
        <span class="c1">#</span>
        <span class="c1"># As such, we need to determine a literal that is true iff a</span>
        <span class="c1"># &quot;canonical&quot; (source-to-target) propagator is valid, as well as</span>
        <span class="c1"># a literal that is true iff a &quot;negated&quot; (target-to-source) propagator is valid.</span>

        <span class="c1"># &quot;Canonical&quot; propagator case.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_implication_true</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="n">edge_valid</span><span class="p">):</span>
            <span class="c1"># If it is statically known that `presence(target) =&gt; edge_valid`,</span>
            <span class="c1"># the propagator is always valid</span>
            <span class="n">source_to_target_propagator_valid</span> <span class="o">=</span> <span class="n">TRUE_LIT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Given that `presence(source) &amp; presence(target) &lt;=&gt; edge_valid`, we can infer</span>
            <span class="c1"># that the propagator becomes valid (i.e. `presence(target) =&gt; edge_valid` holds)</span>
            <span class="c1"># when `presence(source)` becomes true</span>
            <span class="n">source_to_target_propagator_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

        <span class="c1"># &quot;Negated&quot; propagator case (analogous).</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_implication_true</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="n">edge_valid</span><span class="p">):</span>
            <span class="n">target_to_source_propagator_valid</span> <span class="o">=</span> <span class="n">TRUE_LIT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_to_source_propagator_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="n">propagators</span> <span class="o">=</span> <span class="p">[</span>

            <span class="c1"># &quot;canonical&quot; (i.e. &quot;normal&quot;) edge: active &lt;=&gt; source ---(weight)---&gt; target</span>
            <span class="p">(</span><span class="n">SignedVar</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">SignedVar</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">BoundVal</span><span class="p">(</span><span class="n">weight</span><span class="p">),</span>
            <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">(</span><span class="n">reification_literal</span><span class="p">,</span> <span class="n">source_to_target_propagator_valid</span><span class="p">)),</span>

            <span class="p">(</span><span class="n">SignedVar</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">SignedVar</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">BoundVal</span><span class="p">(</span><span class="n">weight</span><span class="p">),</span>
            <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">(</span><span class="n">reification_literal</span><span class="p">,</span> <span class="n">target_to_source_propagator_valid</span><span class="p">)),</span>

            <span class="c1"># &quot;negated&quot; (i.e. &quot;inverted&quot;) edge: !active &lt;=&gt; source &lt;----(-weight-1)--- target</span>
            <span class="p">(</span><span class="n">SignedVar</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">SignedVar</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
            <span class="n">BoundVal</span><span class="p">(</span><span class="o">-</span><span class="n">weight</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">(</span><span class="n">reification_literal</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span> <span class="n">target_to_source_propagator_valid</span><span class="p">)),</span>

            <span class="p">(</span><span class="n">SignedVar</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">SignedVar</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="n">BoundVal</span><span class="p">(</span><span class="o">-</span><span class="n">weight</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">(</span><span class="n">reification_literal</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span> <span class="n">source_to_target_propagator_valid</span><span class="p">)),</span>

        <span class="p">]</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">propagators</span><span class="p">:</span>

            <span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">integration_kind</span><span class="p">)</span> <span class="o">=</span> <span class="n">integrate_propagator_to_database</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">integration_kind</span> <span class="o">==</span> <span class="s2">&quot;ignoring&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">group_id</span><span class="p">]</span><span class="o">.</span><span class="n">enabler</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">continue</span>

            <span class="n">postprocess_propagator_integration_into_database</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">integration_kind</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># MAIN SOLVER DECISION LEVEL INCREASE &amp; DECREASE CALLBACKS</span>
    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="nf">on_solver_increment_one_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">next_unprocessed_solver_event_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">on_solver_backtrack_one_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_dec_lvl</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">ev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">[</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">next_unprocessed_solver_event_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>

            <span class="k">if</span> <span class="n">ev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">propagator_group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">propagator_group_id</span><span class="p">)</span>

                <span class="n">pg_src</span> <span class="o">=</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span>
                <span class="n">pg_tgt</span> <span class="o">=</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">target</span>

                <span class="k">if</span> <span class="p">((</span><span class="n">pg_src</span><span class="p">,</span> <span class="n">pg_tgt</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span>
                    <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span><span class="p">[(</span><span class="n">pg_src</span><span class="p">,</span> <span class="n">pg_tgt</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span><span class="p">[(</span><span class="n">pg_src</span><span class="p">,</span> <span class="n">pg_tgt</span><span class="p">)]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="c1"># NOTE: no need to reset/update self.constraints_database.next_new_constraint_index !</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="p">(</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">enabler</span><span class="p">)</span> <span class="o">=</span> <span class="n">ev</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">watchlists</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">enabler</span><span class="p">),</span> <span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">watchlists</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">enabler</span><span class="p">),</span> <span class="n">enabler</span><span class="o">.</span><span class="n">valid</span><span class="p">)</span>
                <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="p">[</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1">#############################################################################</span>
    <span class="c1">#  PROPAGATION</span>
    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_propagate</span><span class="p">((</span><span class="s2">&quot;bounds&quot;</span><span class="p">,))</span>
        <span class="c1"># return self._propagate(solver, (&quot;bounds&quot;, &quot;edges&quot;))</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">_propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">theory_propagation_levels</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;bounds&quot;</span><span class="p">,),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Propagates all edges / propagator groups that have been marked as</span>
<span class="sd">        active since the last propagation.</span>

<span class="sd">        (1) First, processes each newly added inactive(*) edge / propagator</span>
<span class="sd">        group once, to check if it can be added to the solver based on the literals</span>
<span class="sd">        of its extremities (i.e. minimal and maximal possible values for the edge).</span>
<span class="sd">        If not make its enablers false. This step is equivalent to &quot;bound theory propagation&quot;,</span>
<span class="sd">        but needs to be done independenty because we do not have events for</span>
<span class="sd">        the initial domain bound values of variables.</span>

<span class="sd">            (*) A newly added edge / propagator group can be active</span>
<span class="sd">            (see `add_reified_difference_constraint`), in which case</span>
<span class="sd">            it is added to pending propagator activations.</span>

<span class="sd">        (2):</span>
<span class="sd">        (2.1) Then, propagate all literals changes.</span>

<span class="sd">        (2.2) And then process / loop through the edges / propagator groups pending for activation</span>
<span class="sd">        (including those that were enqueued at step 2.1). This is done by:</span>

<span class="sd">            - Checking if the edge / propagator group is a self loop:</span>

<span class="sd">                - A positive self loop is ignored (move on to next edge / propagator)</span>

<span class="sd">                - A negative self loop is a contradiction, for a which a ReasonerExplanation</span>
<span class="sd">                is returned (to build an explanation later)</span>

<span class="sd">            - If not a self-loop, mark the edge / propagator group as active and propagate it with</span>
<span class="sd">            the Cesta96 algorithm (which runs an incremental Bellman-Ford algorithm over active</span>
<span class="sd">            edges / propagator groups).</span>
<span class="sd">            The assumptions needed to do this (i.e. the edge / propagator group must be newly </span>
<span class="sd">            inserted and the constraint network / STN must be consistent) are indeed satisfied.</span>

<span class="sd">        Finally, doing step (2.1) before (2.2) is necessary because cycle detection on the</span>
<span class="sd">        insertion of a new edge / propagator group requires a consistent constraint</span>
<span class="sd">        network (STN) and no interference of external bound updates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Step (1) (see function documentation).</span>
        <span class="k">if</span> <span class="s2">&quot;bounds&quot;</span> <span class="ow">in</span> <span class="n">theory_propagation_levels</span><span class="p">:</span>

            <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">next_new_constraint_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_list</span><span class="p">)):</span>

                <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_list</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">next_new_constraint_index</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">next_new_constraint_index</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">target_new_lb</span> <span class="o">=</span> <span class="n">BoundVal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="o">+</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">target_current_ub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">opposite</span><span class="p">)</span>

                <span class="c1"># If the lower bound implied by the propagator for the target is greater</span>
                <span class="c1"># than its current upper bound, then the edge is impossible / is a contradiction.</span>
                <span class="c1"># Add a theory propagation cause to allow explanation, and make all potential</span>
                <span class="c1"># enablers of the edge / propagator group false.</span>
                <span class="k">if</span> <span class="n">target_new_lb</span> <span class="o">+</span> <span class="n">target_current_ub</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Bounds</span><span class="p">(</span>
                            <span class="n">Lit</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">)),</span> 
                            <span class="n">Lit</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">target_current_ub</span><span class="p">)))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

                    <span class="n">inference_info</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">TheoryProp</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">cause</span> <span class="o">=</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">inference_info</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">enabler</span> <span class="ow">in</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">:</span>

                        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_literal</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span> <span class="n">cause</span><span class="p">)</span>

                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">InvalidBoundUpdateInfo</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">res</span>

        <span class="c1"># Step (2) (see function documentation).</span>
        <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_unprocessed_solver_event_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span>
               <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span>
        <span class="p">):</span>

            <span class="c1"># Step (2.1) (see function documentation).</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_unprocessed_solver_event_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span><span class="p">:</span>

                <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_events_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">next_unprocessed_solver_event_index</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_unprocessed_solver_event_index</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># If a watched literal was newly entailed, check if makes enabling conditions of an edge / propagator</span>
                <span class="c1"># group true. If so, enqueue such edges / propagator groups to pending active propagators.</span>
                <span class="k">for</span> <span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">enabler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">watchlists</span><span class="o">.</span><span class="n">elements_guarded_by</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">signed_var</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">new_bound_value</span><span class="p">)):</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">enabler</span><span class="p">))</span>

                <span class="k">if</span> <span class="s2">&quot;bounds&quot;</span> <span class="ow">in</span> <span class="n">theory_propagation_levels</span><span class="p">:</span>

                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagate_bound</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">signed_var</span><span class="p">,</span> <span class="n">ev</span><span class="o">.</span><span class="n">new_bound_value</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">res</span>

                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">cause</span><span class="p">,</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">ev</span><span class="o">.</span><span class="n">cause</span><span class="o">.</span><span class="n">reasoner_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">cause</span><span class="o">.</span><span class="n">inference_info</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">EdgeProp</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="c1"># We generated this event ourselves by edge propagation, we can safely</span>
                    <span class="c1"># ignore it as it would been handled immediately    </span>
                    <span class="k">continue</span>

                <span class="c1"># Propagate bound change</span>
                <span class="k">if</span> <span class="n">ev</span><span class="o">.</span><span class="n">signed_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">signed_var</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_propagation_loop</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">signed_var</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">res</span>

            <span class="c1"># Step (2.2) (see function documentation).</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="p">:</span>

                <span class="p">(</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">enabler</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span> <span class="o">=</span> <span class="n">enabler</span>

                <span class="c1"># If we are in a self loop, we handle it separately here,</span>
                <span class="c1"># since it is trivial and not supported by the propagation loop.</span>
                <span class="k">if</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">weight</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>    <span class="c1"># positive self-loop: useless / can be ignored</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">ReasonerBaseExplanation</span><span class="p">((</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span>
                                                                                       <span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">)))</span>

                <span class="c1"># The edge / propagator group is not a self loop:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                                                                        <span class="n">propagator_group</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
                                                                                        <span class="n">propagator_group_id</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">propagator_group_id</span><span class="p">)</span>

                <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
                <span class="c1"># Propagate new edge: implementation of the Cesta96 algorithm.</span>
                <span class="c1"># Propagates a **newly inserted** edge / propagator group</span>
                <span class="c1"># into a **consistent** constraint network / STN.</span>
                <span class="c1"># Does not support self loops (handled above).</span>

                <span class="n">tgt_bound_val</span> <span class="o">=</span> <span class="n">BoundVal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="o">+</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
                <span class="n">inference_info</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">EdgeProp</span><span class="p">(</span><span class="n">propagator_group_id</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_bound_value</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                                 <span class="n">tgt_bound_val</span><span class="p">,</span>
                                                 <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">inference_info</span><span class="p">))</span>
                <span class="k">match</span> <span class="n">res</span><span class="p">:</span>

                    <span class="k">case</span> <span class="n">InvalidBoundUpdateInfo</span><span class="p">():</span>
                        <span class="k">return</span> <span class="n">res</span>

                    <span class="n">case</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_propagation_loop</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">res</span>

                <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

                <span class="k">if</span> <span class="s2">&quot;edges&quot;</span> <span class="ow">in</span> <span class="n">theory_propagation_levels</span><span class="p">:</span>

                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagate_edge</span><span class="p">(</span><span class="n">propagator_group_id</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">res</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">run_propagation_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">original</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">cycle_on_update</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: ...Incremental Bellman-Ford...</span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="c1">#        self.num_propagations += 1</span>

        <span class="k">for</span> <span class="n">vb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">extract_cycle</span><span class="p">(</span>
            <span class="n">vb</span><span class="p">:</span> <span class="n">SignedVar</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Lit</span><span class="p">,</span><span class="o">...</span><span class="p">]:</span>

            <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">vb</span>
            <span class="n">cycle_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>

                <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">first_event_entailing</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">ev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">assert</span> <span class="n">ev</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span>

<span class="c1">#                if not (isinstance(ev.cause, SolverCauses.ReasonerInference)</span>
<span class="c1">#                    and isinstance(ev.cause.inference_info, DiffReasoner.InferenceCauses.EdgePropagation)</span>
<span class="c1">#                ):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">cause</span><span class="p">,</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">cause</span><span class="o">.</span><span class="n">inference_info</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">EdgeProp</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">assert</span> <span class="kc">False</span>

                <span class="n">edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">cause</span><span class="o">.</span><span class="n">inference_info</span><span class="o">.</span><span class="n">propagator_group_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">enabler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="kc">False</span>
                <span class="n">curr</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">source</span>
                <span class="n">cycle_length</span> <span class="o">+=</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span>

                <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
                <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">curr</span> <span class="o">==</span> <span class="n">vb</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">)</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">source_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

            <span class="c1"># If the bound was already updated, ignore and move on to next</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Remove immediately even if we are not done with the update yet.</span>
            <span class="c1"># This allows to keep the `internal_pending_bounds_to_update_queue`</span>
            <span class="c1"># and `pending_bounds_to_update` in sync: if an element is</span>
            <span class="c1"># in `pending_bounds_to_update`, then it is also in `internal_pending_bounds_to_update_queue`.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">[</span><span class="n">source</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="n">source</span> <span class="o">!=</span> <span class="n">target</span>

                <span class="n">candidate</span> <span class="o">=</span> <span class="n">BoundVal</span><span class="p">(</span><span class="n">source_bound</span> <span class="o">+</span> <span class="n">weight</span><span class="p">)</span>
                <span class="n">inference_info</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">EdgeProp</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>

                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_bound_value</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
                                                 <span class="n">candidate</span><span class="p">,</span>
                                                 <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">inference_info</span><span class="p">))</span>

                <span class="k">match</span> <span class="n">res</span><span class="p">:</span>

                    <span class="k">case</span> <span class="n">InvalidBoundUpdateInfo</span><span class="p">():</span>
                        <span class="k">return</span> <span class="n">res</span>

                    <span class="n">case</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1">#                    self.num_distance_updates += 1</span>
                        <span class="k">if</span> <span class="n">cycle_on_update</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">==</span> <span class="n">original</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">ReasonerBaseExplanation</span><span class="p">(</span><span class="n">extract_cycle</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">theory_propagate_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the theory propagation that follows from the addition of a new bound on a variable.</span>

<span class="sd">        A bound on X indicates a shortest path O -&gt; X in an STN (where 0 is a virtual timepoint that</span>
<span class="sd">        represents the time origin in the STN). For any timepoint Y we also know the length of the</span>
<span class="sd">        shortest path Y -&gt; 0 (value of the symmetric bound / bound of the opposite signed variable).</span>
<span class="sd">        Thus, we check that for each potential edge X -&gt; Y that it would not create a negative</span>
<span class="sd">        cycle 0 -&gt; X -&gt; Y -&gt; O. If that&#39;s the case, we disable this X -&gt; Y edge by setting its</span>
<span class="sd">        enabler (or rather its `active` literal) to false.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">potential_out_edges</span><span class="p">(</span>
            <span class="n">src</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">Lit</span><span class="p">]]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">dist_to_origin</span><span class="p">(</span>
            <span class="n">lit</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoundVal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">lit</span><span class="o">.</span><span class="n">bound_value</span> <span class="c1">#REVIEW</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">literal</span><span class="o">.</span><span class="n">signed_var</span>
        <span class="n">dist_o_x</span> <span class="o">=</span> <span class="n">dist_to_origin</span><span class="p">(</span><span class="n">literal</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">out_target</span><span class="p">,</span> <span class="n">out_weight</span><span class="p">,</span> <span class="n">out_presence</span> <span class="ow">in</span> <span class="n">potential_out_edges</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">out_presence</span><span class="o">.</span><span class="n">negated</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">y</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">out_target</span><span class="p">,</span> <span class="n">out_weight</span>
            <span class="n">y_neg_lit</span> <span class="o">=</span> <span class="n">Lit</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">opposite</span><span class="p">))</span>
            <span class="n">dist_y_o</span> <span class="o">=</span> <span class="n">dist_to_origin</span><span class="p">(</span><span class="n">y_neg_lit</span><span class="p">)</span>

            <span class="n">cycle_length</span> <span class="o">=</span> <span class="n">dist_o_x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">dist_y_o</span>

            <span class="k">if</span> <span class="n">cycle_length</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># If 0 -&gt; X -&gt; Y -&gt; 0 forms a negative cycle, there is a contradiction and</span>
            <span class="c1"># we record its cause so we can retrieve it if an explanation is needed.</span>
            <span class="c1"># Here, we know that the update on the bound value of `literal`&#39;s variable</span>
            <span class="c1"># triggered the propagation. However, it is possible that a less constraint</span>
            <span class="c1"># bound would have triggered the propagation as well. We thus replace `literal`</span>
            <span class="c1"># with the smallest update that would have triggered the propagation.</span>
            <span class="c1"># The consequence is that the clauses inferred through explanation will be stronger.</span>
            <span class="n">relaxed_literal</span> <span class="o">=</span> <span class="n">Lit</span><span class="p">(</span><span class="n">literal</span><span class="o">.</span><span class="n">signed_var</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">(</span><span class="n">literal</span><span class="o">.</span><span class="n">bound_value</span> <span class="o">-</span> <span class="n">cycle_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1"># The relaxed literal would have triggered a proapgation with the cycle having exactly length -1</span>
            <span class="k">assert</span> <span class="n">dist_to_origin</span><span class="p">(</span><span class="n">relaxed_literal</span><span class="p">)</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">dist_y_o</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Bounds</span><span class="p">(</span><span class="n">relaxed_literal</span><span class="p">,</span> <span class="n">y_neg_lit</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Disable the edge</span>

            <span class="n">inference_info</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">TheoryProp</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_literal</span><span class="p">(</span><span class="n">out_presence</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span>
                                   <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">inference_info</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">theory_propagate_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">PropaGroupId</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform the theory propagation that follows</span>
<span class="sd">        from the addition of the given (new) edge.</span>

<span class="sd">        In essence, we find all shortest paths A -&gt; B that contain the new edge.</span>
<span class="sd">        Then we check if there exist an inactive edge BA where `weight(BA) + dist(AB) &lt; 0`.</span>
<span class="sd">        For each such edge, we set its enabler to false</span>
<span class="sd">        since its addition would result in a negative cycle.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">potential_out_edges</span><span class="p">(</span>
            <span class="n">src</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">Lit</span><span class="p">]]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">source</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">target</span>

        <span class="n">successors</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">()</span>
        <span class="n">predecessors</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">()</span>

        <span class="c1"># Find all nodes reachable from target(edge), including itself</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distances_from</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">successors</span><span class="p">)</span>

        <span class="c1"># Find all nodes that can reach source(edge), including itself</span>
        <span class="c1"># predecessors nodes and edge are in the inverse direction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distances_from</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">predecessors</span><span class="p">)</span>

        <span class="c1"># Iterate through all predecessors, they will constitute the source of our shortest paths</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">pred_dist</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span> <span class="ow">in</span> <span class="n">predecessors</span><span class="o">.</span><span class="n">reached_nodes</span><span class="p">():</span>

            <span class="c1"># Find all potential edges that target this predecessor.</span>
            <span class="c1"># Note that the predecessor is the inverse view (opposite signed variable),</span>
            <span class="c1"># hence the potential out_edge are all inverse edges.</span>
            <span class="k">for</span> <span class="n">potential_target</span><span class="p">,</span> <span class="n">potential_weight</span><span class="p">,</span> <span class="n">potential_presence</span> <span class="ow">in</span> <span class="n">potential_out_edges</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>

                <span class="c1"># potential is an edge W -&gt; pred. Do we have X in the succesors ?</span>
                <span class="n">forward_dist</span> <span class="o">=</span> <span class="n">successors</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">potential_target</span><span class="o">.</span><span class="n">opposite</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">forward_dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">back_dist</span> <span class="o">=</span> <span class="n">pred_dist</span> <span class="o">+</span> <span class="n">potential_weight</span>
                <span class="n">total_dist</span> <span class="o">=</span> <span class="n">back_dist</span> <span class="o">+</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">+</span> <span class="n">forward_dist</span>

                <span class="c1"># If this edge would be violated and is not inactive yet:</span>
                <span class="k">if</span> <span class="n">total_dist</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">potential_presence</span><span class="o">.</span><span class="n">negated</span><span class="p">):</span>

                    <span class="c1"># careful: we are doing batched eager updates involving optional variable</span>
                    <span class="c1"># When doing the shortest path computation, we followed any edge that was</span>
                    <span class="c1"># not proven inactive yet. The current theory propagation, might have been</span>
                    <span class="c1"># preceded by an other affecting the network. Here we thus check that </span>
                    <span class="c1"># path we initially computed is still active, i.e., that no other propagation</span>
                    <span class="c1"># made any of its edges inactive. This is necessary because we need to</span>
                    <span class="c1"># be able to explain any change and explanation would not follow</span>
                    <span class="c1"># any inactive edge when recreating the path.</span>
                    <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">will_get_theory_propagation_path_succeed</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span>
                                                                           <span class="n">potential_target</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span>
                                                                           <span class="n">propagator_group_id</span><span class="p">,</span>
                                                                           <span class="n">successors</span><span class="p">,</span>
                                                                           <span class="n">predecessors</span><span class="p">)</span>

                    <span class="c1"># If the shortest path would be made inactive, ignore this update</span>
                    <span class="c1"># Note that on a valid constraint network, making this change should be</span>
                    <span class="c1"># either a noop or redundant with another constraint.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Record the cause so we can explain the</span>
                    <span class="c1"># changes resulting from making the edge inactive.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span>
                                                                                             <span class="n">potential_target</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span>
                                                                                             <span class="n">propagator_group_id</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

                    <span class="c1"># Update to force this edge to be inactive</span>

                    <span class="n">inference_info</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">TheoryProp</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_literal</span><span class="p">(</span><span class="n">potential_presence</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span>
                                                 <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">inference_info</span><span class="p">))</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">InvalidBoundUpdateInfo</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">res</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1">#############################################################################</span>
    <span class="c1">#  EXPLANATION</span>
    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span>
        <span class="n">literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
        <span class="n">inference_cause</span><span class="p">:</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inference_cause</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">EdgeProp</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">explain_bound_propagation</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">,</span>
                                           <span class="n">literal</span><span class="p">,</span>
                                           <span class="n">inference_cause</span><span class="o">.</span><span class="n">propagator_group_id</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inference_cause</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">TheoryProp</span><span class="p">):</span>
            <span class="n">theory_propagation_cause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">[</span><span class="n">inference_cause</span><span class="o">.</span><span class="n">theory_propagation_cause_index</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">theory_propagation_cause</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
                <span class="c1"># We need to replace ourselves in exactly the context</span>
                <span class="c1"># in which this theory propagation occurred.</span>
                <span class="c1"># Undo all events until we are back in the state</span>
                <span class="c1"># where this theory propagation cause had not occurred yet.</span>
                <span class="c1"># FIXME: KNOWN PROBLEM: this prevents the explanation of arbitrary literals which is required by some heuristics (e.g. LRB)</span>
                <span class="k">while</span> <span class="n">inference_cause</span><span class="o">.</span><span class="n">theory_propagation_cause_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">):</span>
                    <span class="c1"># get an event to undo</span>
                    <span class="n">propagator_group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                    <span class="c1"># NOTE: this is copied from `on_solver_backtrack_one_level`</span>
                    <span class="k">if</span> <span class="n">propagator_group_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">[</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">explain_theory_propagation</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">,</span> <span class="n">theory_propagation_cause</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">explain_bound_propagation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span>
        <span class="n">literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
        <span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span>
        <span class="n">deep_explanation</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">literal</span><span class="o">.</span><span class="n">bound_value</span>

        <span class="n">enabler</span> <span class="o">=</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span>

        <span class="k">assert</span> <span class="n">enabler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
        <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">))</span>

        <span class="n">cause_lit</span> <span class="o">=</span> <span class="n">Lit</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">(</span><span class="n">val</span><span class="o">-</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">weight</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">deep_explanation</span><span class="p">:</span>
            <span class="k">pass</span>    <span class="c1"># TODO</span>

        <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cause_lit</span><span class="p">)</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">explain_theory_propagation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span>
        <span class="n">cause</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">AnyCause</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cause</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>

            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_theory_propagation_path</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                                                    <span class="n">cause</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                                    <span class="n">cause</span><span class="o">.</span><span class="n">triggering_propagator_group_id</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">enabler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">enabler</span>

                <span class="k">assert</span> <span class="n">enabler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
                <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cause</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Bounds</span><span class="p">):</span>

            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">source_lit</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">target_lit</span><span class="p">)</span>

            <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">source_lit</span><span class="p">)</span>
            <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">target_lit</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

    <span class="c1">#############################################################################</span>
    <span class="c1"># UTILITIES</span>
    <span class="c1">#############################################################################</span>

    <span class="k">def</span> <span class="nf">get_theory_propagation_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">through_propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a (shortest) path that triggered a theory propagation from `source`</span>
<span class="sd">        to `target`, through the edge corresponding to `through_propagator_group_id`.</span>

<span class="sd">        Getting this path is needed for explanations, to explain the contradiction</span>
<span class="sd">        encountered as a result of theory propagation triggered by the activation of </span>
<span class="sd">        the edge corresponding to `through_propagator_group_id`. The path resulting</span>
<span class="sd">        from propagation would be conflicting with an edge from `target` to `source`,</span>
<span class="sd">        as it would have formed a negative cycle if activated.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">shortest_path_from_to</span><span class="p">(</span>
            <span class="n">from_</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
            <span class="n">to</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
            <span class="n">dijkstra_state</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">,</span>
            <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">],</span>
        <span class="p">):</span>
            <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># Run Dijkstra until exhaustion to find all reachable nodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_dijkstra</span><span class="p">(</span><span class="n">dijkstra_state</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">curr</span><span class="p">:</span> <span class="n">curr</span> <span class="o">==</span> <span class="n">to</span><span class="p">)</span>

            <span class="c1"># Go up the predecessors chain to extract the shortest path and append the edge to `out`.</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">to</span>
            <span class="k">while</span> <span class="n">curr</span> <span class="o">!=</span> <span class="n">from_</span><span class="p">:</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">predecessor</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>

                <span class="k">assert</span> <span class="n">edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

                <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">curr</span>
                <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">source</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">through_propagator_group_id</span><span class="p">]</span>
        <span class="n">dijkstra_state</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">()</span>

        <span class="c1"># Add `e.source -&gt; e.target` edge to path</span>
        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">through_propagator_group_id</span><span class="p">)</span>

        <span class="c1"># Add `e.target -&gt; target` subpath to path</span>
        <span class="n">shortest_path_from_to</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">dijkstra_state</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

        <span class="c1"># Add `source -&gt; e.source` subpath to path, computed in th reverse direction.</span>
        <span class="n">shortest_path_from_to</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">dijkstra_state</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">will_get_theory_propagation_path_succeed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">through_propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span>
        <span class="n">successors</span><span class="p">:</span> <span class="n">DijkstraState</span><span class="p">,</span>
        <span class="n">predecessors</span><span class="p">:</span> <span class="n">DijkstraState</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method checks whether the `get_theory_propagation_path`</span>
<span class="sd">        method would be able to find a path for explaining a theory propagation.</span>

<span class="sd">        For efficiency reasons, we do not run the dijkstra algorithm.</span>
<span class="sd">        Instead we accept two prefilled Dijkstra state:</span>
<span class="sd">        - `successors`: one-to-all distances from `through_edge.target`</span>
<span class="sd">        - `predecessors`: one-to-all distances from `through_edge.source.opposite_signed_var`</span>
<span class="sd">        Complexity is linear in the length of the path to check.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="c1"># A path is active (i.e. findable by Dijkstra) if all nodes in it are not shown absent</span>
        <span class="c1"># We assume that the edges themselves are active (since it cannot be made inactive once activated).</span>
        <span class="k">def</span> <span class="nf">path_active</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">tgt</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">dij</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">):</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">tgt</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">negated</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="n">curr</span> <span class="o">!=</span> <span class="n">src</span><span class="p">:</span>
                <span class="n">pred_edge</span> <span class="o">=</span> <span class="n">dij</span><span class="o">.</span><span class="n">predecessor</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">pred_edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">ee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">pred_edge</span><span class="p">]</span>
                <span class="n">curr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">source</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">negated</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">through_propagator_group_id</span><span class="p">]</span>

        <span class="c1"># The path is active if both its prefix and its postfix are active</span>
        <span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">path_active</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">successors</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">path_active</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">predecessors</span><span class="p">))</span>

        <span class="c1"># REVIEW assert not active or self.get_theory_propagation_path(source, target, through_propagator_group_id, solver)</span>

        <span class="k">return</span> <span class="n">active</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">run_dijkstra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">dijkstra_state</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">,</span>
        <span class="n">stop_condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">SignedVar</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the Dijkstra algorithm from a pre-initialized queue.</span>
<span class="sd">        The queue should initially contain the origin of the shortest path problem.</span>
<span class="sd">        The algorithm will once the queue is exhausted or the predicate `stop_condition`</span>
<span class="sd">        returns true when given the next node to expand.</span>

<span class="sd">        At the end of the method, the `dijkstra_state` will contain the distances</span>
<span class="sd">        and predecessors of all nodes reached by the algorithm.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>

            <span class="n">curr</span> <span class="o">=</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">dequeue</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">curr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">curr_rdist</span><span class="p">,</span> <span class="n">curr_node</span> <span class="o">=</span> <span class="n">curr</span>

            <span class="k">if</span> <span class="n">stop_condition</span><span class="p">(</span><span class="n">curr_node</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">curr_node</span><span class="o">.</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">negated</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">curr_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">curr_node</span><span class="p">)</span>

            <span class="c1"># Process all outgoing edges</span>
            <span class="k">if</span> <span class="n">curr_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">prop_target</span><span class="p">,</span> <span class="n">prop_weight</span><span class="p">,</span> <span class="n">prop_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">[</span><span class="n">curr_node</span><span class="p">]:</span>

                <span class="c1"># TODO: here we check that the target is present and thus that all nodes in the path are present.</span>
                <span class="c1"># This is correct but overly pessimistic/</span>
                <span class="c1"># In theory, it would be sufficient to check that presence(...) is not entailed.</span>
                <span class="c1"># However this dijkstra is used in both forward and backward mode, starting from the negated node</span>
                <span class="c1"># for backward traversal.</span>
                <span class="c1"># The condition checking for the presence of prop_target.var to be entailed ensure</span>
                <span class="c1"># that if there is an edge `a -&gt; b` then there is an (-b) -&gt; (-a)` that can be used for backward traversal.</span>
                <span class="c1"># To properly fix this, we should index the active propagators backward and make this dijkstra pass</span>
                <span class="c1"># aware of whether it is traversing backward or forward.</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">is_final</span><span class="p">(</span><span class="n">prop_target</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">prop_target</span><span class="o">.</span><span class="n">var</span><span class="p">))</span>
                <span class="p">):</span>

                    <span class="c1"># We do not have a shortest path to this node yet, so compute a the reduced cost of the edge.</span>

                    <span class="n">target_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">prop_target</span><span class="p">)</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">prop_weight</span>

                    <span class="n">reduced_cost</span> <span class="o">=</span> <span class="n">cost</span> <span class="o">+</span> <span class="p">(</span><span class="n">curr_bound</span> <span class="o">-</span> <span class="n">target_bound</span><span class="p">)</span>   <span class="c1"># rcost(curr, tgt) = cost(curr, tgt) + val(curr) - val(tgt)</span>
                    <span class="k">assert</span> <span class="n">reduced_cost</span> <span class="o">&gt;=</span> <span class="mi">0</span>

                    <span class="n">reduced_dist</span> <span class="o">=</span> <span class="n">curr_rdist</span> <span class="o">+</span> <span class="n">reduced_cost</span>    <span class="c1"># rdist(orig, tgt) = dist(orig, tgt) + val(tgt) - val(orig)</span>
                                                                <span class="c1">#                  = dist(orig, curr) + cost(curr, tgt) + val(tgt) - val(orig)</span>
                                                                <span class="c1">#                  = [rdist(orig, curr) + val(orig) - val(curr)] + [rcost(curr, tgt) - val(tgt) + val(curr)] + val(tgt) - val(orig)</span>
                                                                <span class="c1">#                  = rdist(orig, curr) + rcost(curr, tgt)</span>
                    <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">prop_target</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">(</span><span class="n">reduced_dist</span><span class="p">),</span> <span class="n">prop_id</span><span class="p">)</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">distances_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">origin</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">dijkstra_state</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the one-to-all shortest paths in an STN.</span>
<span class="sd">        The shortest paths are:</span>
<span class="sd">        - in the forward graph if the origin is the upper bound of a variable</span>
<span class="sd">        - in the backward graph is the origin is the lower bound of a variable</span>

<span class="sd">        The functions expects a `dijkstra_state` parameter that will be</span>
<span class="sd">        cleared and contains datastructures that will be used to compute the result.</span>
<span class="sd">        The distances will be set in the `distances` field of this state.</span>

<span class="sd">        The distances returned are in the BoundVal format, which is agnostic of whether</span>
<span class="sd">        we are computing backward or forward distances. The computed distance to a</span>
<span class="sd">        node `A` is simply the sum of the edge weights over the shortest path.</span>

<span class="sd">        Assumptions:</span>

<span class="sd">        The STN is consistent and fully propagated.</span>

<span class="sd">        Internals:</span>

<span class="sd">        To use Dijkstra&#39;s algorithm, we need to ensure that all edges are positive.</span>
<span class="sd">        We do this by using the reduced costs of the edges.</span>
<span class="sd">        Given a function `value(SignedVar)` that returns the</span>
<span class="sd">        current value of a variable bound, we define the *reduced distance*</span>
<span class="sd">        `red_dist` of a path `source -- dist --&gt; target` as   </span>
<span class="sd">        - `red_dist = dist - value(target) + value(source)`</span>
<span class="sd">        - `dist = red_dist + value(target) - value(source)`</span>
<span class="sd">        If the STN is fully propagated and consistent, the</span>
<span class="sd">        reduced distance is guaranteed to always be positive.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">origin_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

        <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Run Dijkstra until exhaustion to find all reachable nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_dijkstra</span><span class="p">(</span><span class="n">dijkstra_state</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Convert all reduced distances to true distances.</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">reached_nodes</span><span class="p">():</span>
            <span class="n">curr_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">curr_node</span><span class="p">)</span>
            <span class="n">true_distance</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">+</span> <span class="p">(</span><span class="n">curr_bound</span> <span class="o">-</span> <span class="n">origin_bound</span><span class="p">)</span>
            <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">curr_node</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">BoundVal</span><span class="p">(</span><span class="n">true_distance</span><span class="p">),</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h5 id="src.solver.reasoners.diff_reasoner.DiffReasoner-attributes">Attributes</h5>

<div class="doc doc-object doc-attribute">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.propagators_database" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagators_database</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaDatabase</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaDatabase</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.propagators_active" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagators_active</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.propagators_pending_for_activation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagators_pending_for_activation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.pending_bounds_to_update" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pending_bounds_to_update</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.internal_pending_bounds_to_update_queue" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">internal_pending_bounds_to_update_queue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.propagation_metadata_trail" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagation_metadata_trail</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[[]]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">
  
      <p>Trail of propagation events metadata. Outer list index: decision level.
Inner list content corresponds to either:
    - Activation of a propagator group (DiffReasoner.PropagatorGroupId - ID
    of that propagator group).
    - Triggering of theory propagation and registration of its cause (None).
      The corresponding TheoryPropagationCauses.AnyCause is appended to a
      list (<code>theory_propagation_causes</code>).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.theory_propagation_causes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">theory_propagation_causes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">AnyCause</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">
  
      <p>List / history of theory propagation causes. A theory propagation cause is
added to this list when a None object is added to the trail of propagation 
events metadata (<code>propagation_metadata_trail</code>).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.next_unprocessed_solver_event_index" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">next_unprocessed_solver_event_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.state" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">state</span><span class="p">:</span> <span class="n">SolverState</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">
  </div>

</div>
<h5 id="src.solver.reasoners.diff_reasoner.DiffReasoner-classes">Classes</h5>

<div class="doc doc-object doc-class">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroup" class="doc doc-heading">
          <code>PropaGroup</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">

  
      <p>Represents a group of (elementary) propagators, that only differ by their
enabling conditions (i.e. <code>potential_enablers</code>).</p>
<p>A (elementary) propagator represents the fact that an update on its
<code>source</code> bound should be reflected on its <code>target</code> bound when some
conditions (the enabling conditions) hold.</p>
<p>FIXME: As such, by abuse of language/notation, a propagator can be seen as
an encoding for a (directed) edge of an STN / difference constraint between two variables.</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PropaGroup</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a group of (elementary) propagators, that only differ by their</span>
<span class="sd">    enabling conditions (i.e. `potential_enablers`).</span>

<span class="sd">    A (elementary) propagator represents the fact that an update on its</span>
<span class="sd">    `source` bound should be reflected on its `target` bound when some</span>
<span class="sd">    conditions (the enabling conditions) hold.</span>

<span class="sd">    FIXME: As such, by abuse of language/notation, a propagator can be seen as</span>
<span class="sd">    an encoding for a (directed) edge of an STN / difference constraint between two variables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Source signed variable of the propagator.&quot;&quot;&quot;</span>

    <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Target signed variable of the propagator.&quot;&quot;&quot;</span>

    <span class="n">weight</span><span class="p">:</span> <span class="n">BoundVal</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Weight of the propagator.&quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">enabler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]</span> <span class="c1">#FIXME rename to current_enabler ?</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The enabler of the propagators of the group.</span>

<span class="sd">    It is non-None when the group / its propagators are active</span>
<span class="sd">    (i.e. participate in propagation).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">potential_enablers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A set of potential enablers for (all) the propagators of the group.</span>

<span class="sd">    The group / all the propagators it represents become enabled once</span>
<span class="sd">    one of these enablers&#39; active and valid literals become True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h7 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroup-attributes">Attributes</h7>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroup.source" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Source signed variable of the propagator.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroup.target" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Target signed variable of the propagator.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroup.weight" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">weight</span><span class="p">:</span> <span class="n">BoundVal</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Weight of the propagator.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroup.enabler" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">enabler</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>The enabler of the propagators of the group.</p>
<p>It is non-None when the group / its propagators are active
(i.e. participate in propagation).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroup.potential_enablers" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">potential_enablers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>A set of potential enablers for (all) the propagators of the group.</p>
<p>The group / all the propagators it represents become enabled once
one of these enablers' active and valid literals become True.</p>
  </div>

</div>





  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroupId" class="doc doc-heading">
          <code>PropaGroupId</code>


</h6>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>


            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">PropaGroupId</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h7 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroupId-attributes">Attributes</h7>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaGroupId.id" class="doc doc-heading">
          <code class="highlight language-python"><span class="nb">id</span><span class="p">:</span> <span class="nb">int</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  </div>

</div>





  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.Enabler" class="doc doc-heading">
          <code>Enabler</code>


</h6>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>

  
      <p>Represents the conditions for a propagator to be enabled, which is for
literals <code>active</code> and <code>valid</code> to both be true.</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Enabler</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the conditions for a propagator to be enabled, which is for</span>
<span class="sd">    literals `active` and `valid` to both be true.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">active</span><span class="p">:</span> <span class="n">Lit</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When this literal is present (i.e. its variable is present), then it is</span>
<span class="sd">    true iff the propagators (enabled by this enabler) are active.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">valid</span><span class="p">:</span> <span class="n">Lit</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This literal is true iff the propagators (enabled by this enabler) are</span>
<span class="sd">    within its validity scope (i.e. when it is known to be sound to propagate</span>
<span class="sd">    a change from the propagator&#39;s source to the propagator&#39;s target)</span>

<span class="sd">    In the simplest cast, `valid = presence(active)` (since by construction</span>
<span class="sd">    `presence(active)` is true iff both the source and the target of the</span>
<span class="sd">    propagator are present).</span>

<span class="sd">    `valid` may be a more specific literal, but it always satisfies that</span>
<span class="sd">    `presence(active) =&gt; valid`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h7 id="src.solver.reasoners.diff_reasoner.DiffReasoner.Enabler-attributes">Attributes</h7>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.Enabler.active" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">active</span><span class="p">:</span> <span class="n">Lit</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>When this literal is present (i.e. its variable is present), then it is
true iff the propagators (enabled by this enabler) are active.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.Enabler.valid" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">valid</span><span class="p">:</span> <span class="n">Lit</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>This literal is true iff the propagators (enabled by this enabler) are
within its validity scope (i.e. when it is known to be sound to propagate
a change from the propagator's source to the propagator's target)</p>
<p>In the simplest cast, <code>valid = presence(active)</code> (since by construction
<code>presence(active)</code> is true iff both the source and the target of the
propagator are present).</p>
<p><code>valid</code> may be a more specific literal, but it always satisfies that
<code>presence(active) =&gt; valid</code>.</p>
  </div>

</div>





  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase" class="doc doc-heading">
          <code>PropaDatabase</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">

  
      <p>Holds all active and inactive difference constraints / edges.</p>
<p>This includes propagators corresponding to the negation of inserted difference constraints / edges</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code>    <span class="nd">@dataclass</span>
<span class="c1">#    class ConstraintsDatabase():</span>
    <span class="k">class</span> <span class="nc">PropaDatabase</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Holds all active and inactive difference constraints / edges.</span>

<span class="sd">        This includes propagators corresponding to the negation of inserted difference constraints / edges</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_propagator_group_id_counter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>
        <span class="n">propagators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroup</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stores all propagators (both active and inactive) as groups or &quot;bundles&quot; of</span>
<span class="sd">        propagators sharing their source, target, and weight.</span>

<span class="sd">        Each difference constraint / edge (i.e. v2-v1 &lt;= d, i.e. v1 --d-&gt; v2)</span>
<span class="sd">        in the STN) added is converted into 4 propagators, which correspond to:</span>
<span class="sd">        - the forward (source -&gt; target) view of the &quot;canonical&quot; (i.e. &quot;normal&quot;) edge</span>
<span class="sd">        - the backward (target -&gt; source) view of the &quot;canonical&quot; (i.e. &quot;normal&quot;) edge</span>
<span class="sd">        - the forward (source -&gt; target) view of the &quot;negated&quot; (i.e. negation of canonical) edge</span>
<span class="sd">        - the backward (target -&gt; source) view of the &quot;negated&quot; (i.e. negation of canonical) edge</span>

<span class="sd">        Make no mistake, at no point will those 4 propagators be part of the same group !</span>
<span class="sd">        None of them have the same source, target, and weight !</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">propagators_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ordered view of `propagators` (their IDs).&quot;&quot;&quot;</span>

        <span class="n">propagators_source_and_target</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Associates (source, target) signed variable pairs to (IDs of)</span>
<span class="sd">        propagators defined between them.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">intermittent_propagators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">Lit</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stores propagators whose activity depends on the current state</span>
<span class="sd">        (i.e. which may or may not be active, depending on the current state).</span>

<span class="sd">        Encoding as a dictionary:</span>
<span class="sd">        - The key corresponds to the source of a propagator</span>
<span class="sd">        - The value for that key / propagator source is a list of (target, weight, presence),</span>
<span class="sd">        for each encoded propagator.</span>

<span class="sd">        Here, &quot;presence&quot; corresponds to a literal that is true iff the</span>
<span class="sd">        edge / propagator must be present.</span>
<span class="sd">        REVIEW: same thing as &quot;valid&quot; or not ?</span>
<span class="sd">        Note that handling of optional variables might allow an edge to</span>
<span class="sd">        propagate even if it is not known to be present yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">watchlists</span><span class="p">:</span> <span class="n">SetGuardedByLiterals</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">SetGuardedByLiterals</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Associates literals to propagators (with an enabler) that should be activated</span>
<span class="sd">        when they become true.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="n">propagator_groups_events_trail</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:[[]])</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Holds the trail of &quot;propagator groups events&quot;, i.e. updates on propagator groups:</span>
<span class="sd">        - A None element designates the addition of a new propagator group.</span>
<span class="sd">        - A (PropagatorGroupId, Enabler) tuple designates the addition of</span>
<span class="sd">        the specified enabler to the set of potential enablers of the</span>
<span class="sd">        propagator group with the specified id.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">next_new_constraint_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h7 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase-attributes">Attributes</h7>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase.propagators" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroup</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Stores all propagators (both active and inactive) as groups or "bundles" of
propagators sharing their source, target, and weight.</p>
<p>Each difference constraint / edge (i.e. v2-v1 &lt;= d, i.e. v1 --d-&gt; v2)
in the STN) added is converted into 4 propagators, which correspond to:
- the forward (source -&gt; target) view of the "canonical" (i.e. "normal") edge
- the backward (target -&gt; source) view of the "canonical" (i.e. "normal") edge
- the forward (source -&gt; target) view of the "negated" (i.e. negation of canonical) edge
- the backward (target -&gt; source) view of the "negated" (i.e. negation of canonical) edge</p>
<p>Make no mistake, at no point will those 4 propagators be part of the same group !
None of them have the same source, target, and weight !</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase.propagators_list" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagators_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Ordered view of <code>propagators</code> (their IDs).</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase.propagators_source_and_target" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagators_source_and_target</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Associates (source, target) signed variable pairs to (IDs of)
propagators defined between them.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase.intermittent_propagators" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">intermittent_propagators</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">Lit</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Stores propagators whose activity depends on the current state
(i.e. which may or may not be active, depending on the current state).</p>
<p>Encoding as a dictionary:
- The key corresponds to the source of a propagator
- The value for that key / propagator source is a list of (target, weight, presence),
for each encoded propagator.</p>
<p>Here, "presence" corresponds to a literal that is true iff the
edge / propagator must be present.
REVIEW: same thing as "valid" or not ?
Note that handling of optional variables might allow an edge to
propagate even if it is not known to be present yet.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase.watchlists" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">watchlists</span><span class="p">:</span> <span class="n">SetGuardedByLiterals</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">SetGuardedByLiterals</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Associates literals to propagators (with an enabler) that should be activated
when they become true.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase.propagator_groups_events_trail" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagator_groups_events_trail</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span> <span class="p">:</span> <span class="p">[[]])</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Holds the trail of "propagator groups events", i.e. updates on propagator groups:
- A None element designates the addition of a new propagator group.
- A (PropagatorGroupId, Enabler) tuple designates the addition of
the specified enabler to the set of potential enablers of the
propagator group with the specified id.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.PropaDatabase.next_new_constraint_index" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">next_new_constraint_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  </div>

</div>





  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses" class="doc doc-heading">
          <code>TheoryPropCauses</code>


</h6>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="abc.ABC">ABC</span></code></p>

  
      <p>A container / "namespace" for structures describing the kinds of causes
for an active shortest path to trigger theory propagation.</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TheoryPropCauses</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A container / &quot;namespace&quot; for structures describing the kinds of causes</span>
<span class="sd">    for an active shortest path to trigger theory propagation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">class</span> <span class="nc">Path</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents a theory propagation cause corresponding to the activation</span>
<span class="sd">        of the propagators represented by `triggering_propagator_group_id`.</span>

<span class="sd">        (In other words, the activation/&quot;appearance&quot; of a new shortest path between</span>
<span class="sd">        `source` and `target`, going through the edge represented by the</span>
<span class="sd">        propagators corresponding to `triggering_propagator_group_id`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span>
        <span class="n">triggering_propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">class</span> <span class="nc">Bounds</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents a theory propagation cause corresponding to the incompability</span>
<span class="sd">        of the `source_lit` and `target_lit` literals with an &quot;edge&quot; (propagator group).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">source_lit</span><span class="p">:</span> <span class="n">Lit</span>
        <span class="n">target_lit</span><span class="p">:</span> <span class="n">Lit</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">AnyCause</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span>
                     <span class="n">Bounds</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Any theory propagation cause.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h7 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses-attributes">Attributes</h7>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses.AnyCause" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">AnyCause</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">Bounds</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Any theory propagation cause.</p>
  </div>

</div>
<h7 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses-classes">Classes</h7>

<div class="doc doc-object doc-class">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses.Path" class="doc doc-heading">
          <code>Path</code>


</h8>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>

  
      <p>Represents a theory propagation cause corresponding to the activation
of the propagators represented by <code>triggering_propagator_group_id</code>.</p>
<p>(In other words, the activation/"appearance" of a new shortest path between
<code>source</code> and <code>target</code>, going through the edge represented by the
propagators corresponding to <code>triggering_propagator_group_id</code>)</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Path</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a theory propagation cause corresponding to the activation</span>
<span class="sd">    of the propagators represented by `triggering_propagator_group_id`.</span>

<span class="sd">    (In other words, the activation/&quot;appearance&quot; of a new shortest path between</span>
<span class="sd">    `source` and `target`, going through the edge represented by the</span>
<span class="sd">    propagators corresponding to `triggering_propagator_group_id`)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span>
    <span class="n">triggering_propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h9 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses.Path-attributes">Attributes</h9>

<div class="doc doc-object doc-attribute">




<h10 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses.Path.source" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h10 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses.Path.target" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h10 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses.Path.triggering_propagator_group_id" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">triggering_propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


  <div class="doc doc-contents ">
  </div>

</div>





  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses.Bounds" class="doc doc-heading">
          <code>Bounds</code>


</h8>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>

  
      <p>Represents a theory propagation cause corresponding to the incompability
of the <code>source_lit</code> and <code>target_lit</code> literals with an "edge" (propagator group).</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Bounds</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a theory propagation cause corresponding to the incompability</span>
<span class="sd">    of the `source_lit` and `target_lit` literals with an &quot;edge&quot; (propagator group).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source_lit</span><span class="p">:</span> <span class="n">Lit</span>
    <span class="n">target_lit</span><span class="p">:</span> <span class="n">Lit</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h9 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses.Bounds-attributes">Attributes</h9>

<div class="doc doc-object doc-attribute">




<h10 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses.Bounds.source_lit" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">source_lit</span><span class="p">:</span> <span class="n">Lit</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h10 id="src.solver.reasoners.diff_reasoner.DiffReasoner.TheoryPropCauses.Bounds.target_lit" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">target_lit</span><span class="p">:</span> <span class="n">Lit</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


  <div class="doc doc-contents ">
  </div>

</div>





  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses" class="doc doc-heading">
          <code>InferenceCauses</code>


</h6>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="abc.ABC">ABC</span></code></p>

  
      <p>A container / "namespace" for structures describing the causes that can
trigger an inference (i.e. bound value update, calling <code>set_bound_value</code>
in the main solver) made during propagation in this reasoner.</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">InferenceCauses</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span> <span class="c1"># FIXME: rename to InferenceKinds ?</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A container / &quot;namespace&quot; for structures describing the causes that can</span>
<span class="sd">    trigger an inference (i.e. bound value update, calling `set_bound_value`</span>
<span class="sd">    in the main solver) made during propagation in this reasoner.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">class</span> <span class="nc">EdgeProp</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents a inference cause corresponding to an edge propagation</span>
<span class="sd">        (of the given edge / propagator group)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">class</span> <span class="nc">TheoryProp</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represents a inference cause corresponding to a theory propagation.</span>
<span class="sd">        That theory propagation&#39;s own cause was registered at the</span>
<span class="sd">        given index in `theory_propagation_causes`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theory_propagation_cause_index</span><span class="p">:</span> <span class="nb">int</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">AnyCause</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">EdgeProp</span><span class="p">,</span>
                     <span class="n">TheoryProp</span><span class="p">]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Any cause for an inference (made by this reasoner).&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h7 id="src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses-attributes">Attributes</h7>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses.AnyCause" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">AnyCause</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">EdgeProp</span><span class="p">,</span> <span class="n">TheoryProp</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Any cause for an inference (made by this reasoner).</p>
  </div>

</div>
<h7 id="src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses-classes">Classes</h7>

<div class="doc doc-object doc-class">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses.EdgeProp" class="doc doc-heading">
          <code>EdgeProp</code>


</h8>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>

  
      <p>Represents a inference cause corresponding to an edge propagation
(of the given edge / propagator group)</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">EdgeProp</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a inference cause corresponding to an edge propagation</span>
<span class="sd">    (of the given edge / propagator group)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h9 id="src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses.EdgeProp-attributes">Attributes</h9>

<div class="doc doc-object doc-attribute">




<h10 id="src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses.EdgeProp.propagator_group_id" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


  <div class="doc doc-contents ">
  </div>

</div>





  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses.TheoryProp" class="doc doc-heading">
          <code>TheoryProp</code>


</h8>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="typing.NamedTuple">NamedTuple</span></code></p>

  
      <p>Represents a inference cause corresponding to a theory propagation.
That theory propagation's own cause was registered at the
given index in <code>theory_propagation_causes</code>.</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">TheoryProp</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a inference cause corresponding to a theory propagation.</span>
<span class="sd">    That theory propagation&#39;s own cause was registered at the</span>
<span class="sd">    given index in `theory_propagation_causes`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">theory_propagation_cause_index</span><span class="p">:</span> <span class="nb">int</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h9 id="src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses.TheoryProp-attributes">Attributes</h9>

<div class="doc doc-object doc-attribute">




<h10 id="src.solver.reasoners.diff_reasoner.DiffReasoner.InferenceCauses.TheoryProp.theory_propagation_cause_index" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">theory_propagation_cause_index</span><span class="p">:</span> <span class="nb">int</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h10>


  <div class="doc doc-contents ">
  </div>

</div>





  </div>

  </div>

</div>




  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState" class="doc doc-heading">
          <code>DijkstraState</code>

  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h6>


  <div class="doc doc-contents ">

  
      <p>A data structure that contains the mutable data that is updated during
a Dijkstra algorithm. It is intended to be reusable across multiple runs.</p>

            <details class="quote">
              <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DijkstraState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A data structure that contains the mutable data that is updated during</span>
<span class="sd">    a Dijkstra algorithm. It is intended to be reusable across multiple runs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">latest</span><span class="p">:</span> <span class="n">BoundVal</span> <span class="o">=</span> <span class="n">BoundVal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The latest distance that was extract from the queue. As a property of the</span>
<span class="sd">    Dijkstra algorithm, if a distance in the `distances` table is less than or</span>
<span class="sd">    equal to this value, then it will not change for the rest of the process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">distances</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Associates each vertex to its distance. If the node is not an origin, it</span>
<span class="sd">    also indicates the latest edge on the shortest path to this node.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">queue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Elements of the queue that have not been extracted yet.</span>
<span class="sd">    Note that a single node might appear several times in the queue,</span>
<span class="sd">    in which case only the one with the smallest distance is relevant.</span>

<span class="sd">    Represented with Python&#39;s heapq, which is a min-heap.</span>

<span class="sd">    The SignedVar corresponds to a node and the BoundVal corresponds</span>
<span class="sd">    to the reduced distance from the origin to this node. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">=</span> <span class="n">BoundVal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">dist</span><span class="p">:</span> <span class="n">BoundVal</span><span class="p">,</span>
        <span class="n">incoming_edge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a node to the queue, indicating the distance from the origin and</span>
<span class="sd">        the latest edge on the path from the origin to this node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">previous_dist</span> <span class="o">=</span> <span class="n">MAX_INT</span>  <span class="c1"># FIXME: should be max int</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">previous_dist</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">previous_dist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">incoming_edge</span><span class="p">)</span>
            <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">dequeue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove the next element in the queue.</span>
<span class="sd">        Nodes are removed by increasing distance to the origin.</span>
<span class="sd">        Each node can only be extracted once.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">&lt;=</span> <span class="n">dist</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dist</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">=</span> <span class="n">dist</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">dist</span><span class="p">:</span>
            <span class="c1"># Node with the best distance from origin</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># A node with a better distance was previousl extracted,</span>
            <span class="c1"># ignore this one as it cannot contribute to a shortest path</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the distance from the origin to this node,</span>
<span class="sd">        or None if the node was not reached by Dijkstra&#39;s algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">reached_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an iterator over all nodes (and their distances</span>
<span class="sd">        from the origin) that were reached by the algorithm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="p">,(</span><span class="n">d</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">predecessor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the predecessor edge from the origin to this</span>
<span class="sd">        node or None if it is an origin.</span>

<span class="sd">        Will raise an error if the node has no associated distance</span>
<span class="sd">        (i.e. was not reached by the algorithm)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">is_final</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if the node has a distance that is guaranteed not to</span>
<span class="sd">        change in subsequent iterations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">





<h7 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState-attributes">Attributes</h7>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState.latest" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">latest</span><span class="p">:</span> <span class="n">BoundVal</span> <span class="o">=</span> <span class="n">BoundVal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>The latest distance that was extract from the queue. As a property of the
Dijkstra algorithm, if a distance in the <code>distances</code> table is less than or
equal to this value, then it will not change for the rest of the process.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState.distances" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">distances</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Associates each vertex to its distance. If the node is not an origin, it
also indicates the latest edge on the shortest path to this node.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState.queue" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">queue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h8>


  <div class="doc doc-contents ">
  
      <p>Elements of the queue that have not been extracted yet.
Note that a single node might appear several times in the queue,
in which case only the one with the smallest distance is relevant.</p>
<p>Represented with Python's heapq, which is a min-heap.</p>
<p>The SignedVar corresponds to a node and the BoundVal corresponds
to the reduced distance from the origin to this node.</p>
  </div>

</div>

<h7 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState-functions">Functions</h7>


<div class="doc doc-object doc-function">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState.clear" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">clear</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h8>


  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">=</span> <span class="n">BoundVal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState.enqueue" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">enqueue</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">dist</span><span class="p">:</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">incoming_edge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h8>


  <div class="doc doc-contents ">
  
      <p>Add a node to the queue, indicating the distance from the origin and
the latest edge on the path from the origin to this node.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">enqueue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="n">dist</span><span class="p">:</span> <span class="n">BoundVal</span><span class="p">,</span>
    <span class="n">incoming_edge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add a node to the queue, indicating the distance from the origin and</span>
<span class="sd">    the latest edge on the path from the origin to this node.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">previous_dist</span> <span class="o">=</span> <span class="n">MAX_INT</span>  <span class="c1"># FIXME: should be max int</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">previous_dist</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dist</span> <span class="o">&lt;</span> <span class="n">previous_dist</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">incoming_edge</span><span class="p">)</span>
        <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState.dequeue" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">dequeue</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]</span></code>

</h8>


  <div class="doc doc-contents ">
  
      <p>Remove the next element in the queue.
Nodes are removed by increasing distance to the origin.
Each node can only be extracted once.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">dequeue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove the next element in the queue.</span>
<span class="sd">    Nodes are removed by increasing distance to the origin.</span>
<span class="sd">    Each node can only be extracted once.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>

    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">&lt;=</span> <span class="n">dist</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">dist</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">latest</span> <span class="o">=</span> <span class="n">dist</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">dist</span><span class="p">:</span>
        <span class="c1"># Node with the best distance from origin</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># A node with a better distance was previousl extracted,</span>
        <span class="c1"># ignore this one as it cannot contribute to a shortest path</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState.distance" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">distance</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">]</span></code>

</h8>


  <div class="doc doc-contents ">
  
      <p>Returns the distance from the origin to this node,
or None if the node was not reached by Dijkstra's algorithm</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the distance from the origin to this node,</span>
<span class="sd">    or None if the node was not reached by Dijkstra&#39;s algorithm</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState.reached_nodes" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">reached_nodes</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]</span></code>

</h8>


  <div class="doc doc-contents ">
  
      <p>Returns an iterator over all nodes (and their distances
from the origin) that were reached by the algorithm.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">reached_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">BoundVal</span><span class="p">,</span> <span class="n">SignedVar</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an iterator over all nodes (and their distances</span>
<span class="sd">    from the origin) that were reached by the algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">n</span><span class="p">,(</span><span class="n">d</span><span class="p">,</span><span class="n">_</span><span class="p">))</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState.predecessor" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">predecessor</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]</span></code>

</h8>


  <div class="doc doc-contents ">
  
      <p>Returns the predecessor edge from the origin to this
node or None if it is an origin.</p>
<p>Will raise an error if the node has no associated distance
(i.e. was not reached by the algorithm)</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">predecessor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the predecessor edge from the origin to this</span>
<span class="sd">    node or None if it is an origin.</span>

<span class="sd">    Will raise an error if the node has no associated distance</span>
<span class="sd">    (i.e. was not reached by the algorithm)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h8 id="src.solver.reasoners.diff_reasoner.DiffReasoner.DijkstraState.is_final" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">is_final</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span></code>

</h8>


  <div class="doc doc-contents ">
  
      <p>Returns true if the node has a distance that is guaranteed not to
change in subsequent iterations.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">is_final</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns true if the node has a distance that is guaranteed not to</span>
<span class="sd">    change in subsequent iterations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>
<h5 id="src.solver.reasoners.diff_reasoner.DiffReasoner-functions">Functions</h5>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">SolverState</span><span class="p">)</span></code>

</h6>


  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">SolverState</span><span class="p">,</span>
<span class="p">):</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="p">:</span> <span class="n">SolverState</span> <span class="o">=</span> <span class="n">state</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaDatabase</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaDatabase</span><span class="p">()</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[[]]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trail of propagation events metadata. Outer list index: decision level.</span>
<span class="sd">    Inner list content corresponds to either:</span>
<span class="sd">        - Activation of a propagator group (DiffReasoner.PropagatorGroupId - ID</span>
<span class="sd">        of that propagator group).</span>
<span class="sd">        - Triggering of theory propagation and registration of its cause (None).</span>
<span class="sd">          The corresponding TheoryPropagationCauses.AnyCause is appended to a</span>
<span class="sd">          list (`theory_propagation_causes`).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">AnyCause</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List / history of theory propagation causes. A theory propagation cause is</span>
<span class="sd">    added to this list when a None object is added to the trail of propagation </span>
<span class="sd">    events metadata (`propagation_metadata_trail`).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">next_unprocessed_solver_event_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.add_reified_difference_constraint" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">add_reified_difference_constraint</span><span class="p">(</span><span class="n">reification_literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span> <span class="n">weight</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Adds a new difference constraint (<code>target - source &lt;= weight</code>), i.e. STN
edge (source --weight--&gt; target), which was already reified into <code>reification_literal</code>.</p>
<p>This is done by following these steps:</p>
<ol>
<li>Decompose the difference constraint into 4 propagators, which will be
"active" iff <code>reification_literal</code> is true, and "valid" iff the variable
of their target signed variable is present. (see <code>Enabler</code>).</li>
</ol>
<p>And then for each of these 4 propagators:</p>
<ol>
<li>
<p>Integrate the new propagator to the propagator database (recall that 
a propagator group "bundles" propagators which only differ by enabling conditions)).
For each new propagator, this is done by either:</p>
<ul>
<li>
<p>Merging / adding the new propagator into an existing group
of propagators, by adding its enabler to their <code>potential_enablers</code>.</p>
</li>
<li>
<p>Tightening an already active existing group of propagators
(superseded by the new propagator), by setting their weight to
the new propagator's weight.</p>
</li>
<li>
<p>Ignoring the new propagator, if it is redundant with an
existing one (i.e. if its weight is weaker than an existing
propagator's with the same enabling conditions).</p>
</li>
<li>
<p>Creating a new propagator group with the new propagator's enabler,
if there are no existing propagators with the same source and target.</p>
</li>
</ul>
</li>
</ol>
<p>NOTE that merging, tightening, or ignoring is only done when the solver
is at the top decision level. Beyond the top decision level, we always choose 
to create a new propagator group, because it would be too complicated to
undo/backtrack the reorganization of a propagator group.</p>
<ol>
<li>
<p>Postprocess the integration of the new propagator. The two possibilities are the following:</p>
<ul>
<li>
<p>Either set the propagators of the group (to which the new propagator was added)
as pending for activation, if the enabling conditions of the new propagator
are satisfied (<code>active</code> and <code>valid</code> literals of its enabler are true).</p>
</li>
<li>
<p>Or set watch on the enabling conditions of the new propagator (the <code>active</code>
and <code>valid</code> literals of its enabler), if they aren't known to be true yet, so
that we're notified when one of them becomes true. (If both of them are true,
the propagator group will be staged as pending for activation).</p>
</li>
</ul>
</li>
</ol>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">add_reified_difference_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">reification_literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">Var</span><span class="p">,</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a new difference constraint (`target - source &lt;= weight`), i.e. STN</span>
<span class="sd">    edge (source --weight--&gt; target), which was already reified into `reification_literal`.</span>

<span class="sd">    This is done by following these steps:</span>

<span class="sd">    1. Decompose the difference constraint into 4 propagators, which will be</span>
<span class="sd">    &quot;active&quot; iff `reification_literal` is true, and &quot;valid&quot; iff the variable</span>
<span class="sd">    of their target signed variable is present. (see `Enabler`).</span>

<span class="sd">    And then for each of these 4 propagators:</span>

<span class="sd">    2. Integrate the new propagator to the propagator database (recall that </span>
<span class="sd">    a propagator group &quot;bundles&quot; propagators which only differ by enabling conditions)).</span>
<span class="sd">    For each new propagator, this is done by either:</span>

<span class="sd">        - Merging / adding the new propagator into an existing group</span>
<span class="sd">        of propagators, by adding its enabler to their `potential_enablers`.</span>

<span class="sd">        - Tightening an already active existing group of propagators</span>
<span class="sd">        (superseded by the new propagator), by setting their weight to</span>
<span class="sd">        the new propagator&#39;s weight.</span>

<span class="sd">        - Ignoring the new propagator, if it is redundant with an</span>
<span class="sd">        existing one (i.e. if its weight is weaker than an existing</span>
<span class="sd">        propagator&#39;s with the same enabling conditions).</span>

<span class="sd">        - Creating a new propagator group with the new propagator&#39;s enabler,</span>
<span class="sd">        if there are no existing propagators with the same source and target.</span>

<span class="sd">    NOTE that merging, tightening, or ignoring is only done when the solver</span>
<span class="sd">    is at the top decision level. Beyond the top decision level, we always choose </span>
<span class="sd">    to create a new propagator group, because it would be too complicated to</span>
<span class="sd">    undo/backtrack the reorganization of a propagator group.</span>

<span class="sd">    3. Postprocess the integration of the new propagator. The two possibilities are the following:</span>

<span class="sd">        - Either set the propagators of the group (to which the new propagator was added)</span>
<span class="sd">        as pending for activation, if the enabling conditions of the new propagator</span>
<span class="sd">        are satisfied (`active` and `valid` literals of its enabler are true).</span>

<span class="sd">        - Or set watch on the enabling conditions of the new propagator (the `active`</span>
<span class="sd">        and `valid` literals of its enabler), if they aren&#39;t known to be true yet, so</span>
<span class="sd">        that we&#39;re notified when one of them becomes true. (If both of them are true,</span>
<span class="sd">        the propagator group will be staged as pending for activation).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">integrate_propagator_to_database</span><span class="p">(</span>
        <span class="n">src</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">tgt</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">wgt</span><span class="p">:</span> <span class="n">BoundVal</span><span class="p">,</span> 
        <span class="n">eblr</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Integrates a new propagator (defined by the arguments) to the propagator database.</span>
<span class="sd">        See step 2 (function documentation).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Only optimize organisation of propagator groups at the top decision level,</span>
        <span class="c1"># because if done at a decision level beyond, it would to complex to undo/backtrack</span>
        <span class="c1"># the changes made to the groups.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span><span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">),</span> <span class="p">[])</span>

            <span class="c1"># Search for a propagator group compatible with this propagator (same source and target)</span>
            <span class="k">for</span> <span class="n">existing_group_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span><span class="p">[(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)]:</span>
                <span class="n">existing_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">existing_group_id</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">existing_group</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">src</span>
                        <span class="ow">and</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c1"># If there is a compatible propagator group:</span>

                <span class="c1"># If the group has the same weight as the propagator, either merge the</span>
                <span class="c1"># propagator into the group by adding its enabler to it, if it isn&#39;t redundant,</span>
                <span class="c1"># or ignore it and do nothing if it is.</span>
                <span class="k">if</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">weight</span> <span class="o">==</span> <span class="n">wgt</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">eblr</span> <span class="ow">in</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">:</span>
                        <span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eblr</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">existing_group_id</span><span class="p">,</span> <span class="s2">&quot;merging&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">(</span><span class="n">existing_group_id</span><span class="p">,</span> <span class="s2">&quot;ignoring&quot;</span><span class="p">)</span>


                <span class="c1"># If the propagator&#39;s weight is strictly stronger than that of</span>
                <span class="c1"># the group and they have the same one enabler, then just tighten</span>
                <span class="c1"># the group by changing its weight to that of the propagator.</span>
                <span class="k">elif</span> <span class="n">wgt</span><span class="o">.</span><span class="n">is_stronger_than</span><span class="p">(</span><span class="n">existing_group</span><span class="o">.</span><span class="n">weight</span><span class="o">-</span><span class="n">BoundVal</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="ow">and</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">eblr</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">src</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="p">:</span>
                        <span class="c1"># note that since we consider the case where there&#39;s only one potential enabler,</span>
                        <span class="c1"># there can only be 1 intermittent propagator.</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="p">[</span><span class="n">src</span><span class="p">])):</span>

                            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                                <span class="o">==</span> <span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span> <span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
                            <span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="p">[</span><span class="n">src</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="n">wgt</span><span class="p">,</span> <span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
                                <span class="k">break</span>

                    <span class="n">existing_group</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">wgt</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">existing_group_id</span><span class="p">,</span> <span class="s2">&quot;tightening&quot;</span><span class="p">)</span>

                <span class="c1"># If the propagator&#39;s weight is weaker than that of the group and they have the same one enabler,</span>
                <span class="c1"># ignore the propagator and do nothing, because it is redundant.</span>
                <span class="k">elif</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">is_stronger_than</span><span class="p">(</span><span class="n">BoundVal</span><span class="p">(</span><span class="n">wgt</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
                        <span class="ow">and</span> <span class="n">existing_group</span><span class="o">.</span><span class="n">potential_enablers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">eblr</span>
                    <span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">existing_group_id</span><span class="p">,</span> <span class="s2">&quot;ignoring&quot;</span><span class="p">)</span>

        <span class="c1"># If the propagator couldn&#39;t be unified / integrated with an existing</span>
        <span class="c1"># propagator group, then just create a new propagator group for it.</span>

        <span class="n">created_group_id</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">_propagator_group_id_counter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">_propagator_group_id_counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">created_group_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroup</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">wgt</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">eblr</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">created_group_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span> \
            <span class="o">.</span><span class="n">setdefault</span><span class="p">((</span><span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">),</span> <span class="p">[])</span>                         \
            <span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">created_group_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">created_group_id</span><span class="p">,</span> <span class="s2">&quot;creating&quot;</span><span class="p">)</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">postprocess_propagator_integration_into_database</span><span class="p">(</span>
        <span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span>
        <span class="n">propagator_integrated_by</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">eblr</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Postprocesses the integration to the propagators database of a new propagator.</span>
<span class="sd">        See step 3 (function documentation).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># NOTE: The case of propagator_integrated_by == &quot;ignoring&quot; is dealt in the main function.</span>

        <span class="c1"># If propagator was created into a new group or was merged into an existing one,</span>
        <span class="c1"># there are different possibilities, depending on whether it is currently enabled</span>
        <span class="c1"># or not.FIXME: Note that we should make sure that when backtracking beyond the</span>
        <span class="c1"># current decision level, we should deactivate the edge</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">propagator_integrated_by</span> <span class="o">==</span> <span class="s2">&quot;creating&quot;</span> 
            <span class="ow">or</span> <span class="n">propagator_integrated_by</span> <span class="o">==</span> <span class="s2">&quot;merging&quot;</span>
        <span class="p">):</span>
            <span class="c1"># If the propagator can never be active/present, do nothing.</span>
            <span class="n">edge_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">edge_valid</span><span class="o">.</span><span class="n">negated</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="k">return</span>

            <span class="c1"># If the propagator is always active in the current (and following) decision</span>
            <span class="c1"># levels, enqueue it for activation.</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">eblr</span><span class="p">))</span>

            <span class="c1"># If the propagator isn&#39;t known to be active or inactive yet, </span>
            <span class="c1"># record the fact that:</span>
            <span class="c1"># - If the enabling conditions hold (`enabler.valid` and `enabler.active` are true),</span>
            <span class="c1">#   then the propagator should be enabled</span>
            <span class="c1"># - If the propagator is inconsistent, then the `enabler.active` should be made false</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Set a watch on both `enabler.active` and `enabler.valid` literals</span>
                <span class="c1"># (when one of them becomes true, we will still have to check that the</span>
                <span class="c1"># other one becomes true as well)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">watchlists</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">eblr</span><span class="p">),</span> <span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">watchlists</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">eblr</span><span class="p">),</span> <span class="n">eblr</span><span class="o">.</span><span class="n">valid</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">,</span>
                        <span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span> \
                    <span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">eblr</span><span class="p">))</span>

        <span class="c1"># If an existing group was tightened (as a result of</span>
        <span class="c1"># a new propagator&#39;s integration into the database), then:</span>
        <span class="c1"># - If the group wasn&#39;t already active, we don&#39;t need to do anything.</span>
        <span class="c1"># - If the group was already active, we need to force its propagation</span>
        <span class="c1">#   (which we do by &quot;pretending&quot; it was previously inactive and then</span>
        <span class="c1">#   enqueuing it for activation)</span>
        <span class="k">elif</span> <span class="n">propagator_integrated_by</span> <span class="o">==</span> <span class="s2">&quot;tightening&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">active</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">eblr</span><span class="o">.</span><span class="n">valid</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span><span class="o">.</span><span class="n">enabler</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">eblr</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="c1"># Step 1: (see function documentation)</span>

    <span class="c1"># The validity scope of the reification literal is known to be the</span>
    <span class="c1"># conjunctive scope of the source and target variables of the edge / constraint.</span>
    <span class="c1"># </span>
    <span class="c1"># As such, the edge is valid / well-defined iff its reification literal is</span>
    <span class="c1"># present (iff the source and target variables of the edge are both present)</span>
    <span class="n">edge_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">reification_literal</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">)</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_implication_true</span><span class="p">(</span><span class="n">edge_valid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_implication_true</span><span class="p">(</span><span class="n">edge_valid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

    <span class="c1"># The edge will be decomposed into 4 propagators:</span>
    <span class="c1"># 2 &quot;canonical&quot;, and 2 &quot;negated&quot; (or &quot;inverted&quot;: swapped source and target for them).</span>
    <span class="c1"># </span>
    <span class="c1"># A &quot;canonical&quot; (source-to-target) propagator is valid</span>
    <span class="c1"># when `presence(target) =&gt; edge_valid`. This is because modifying</span>
    <span class="c1"># the target&#39;s domain is only meaningful if the edge is present.</span>
    <span class="c1"># Analogously, a &quot;negated&quot; (target-to-source) propagator is valid</span>
    <span class="c1"># when `presence(source) =&gt; edge_valid`.</span>
    <span class="c1">#</span>
    <span class="c1"># As such, we need to determine a literal that is true iff a</span>
    <span class="c1"># &quot;canonical&quot; (source-to-target) propagator is valid, as well as</span>
    <span class="c1"># a literal that is true iff a &quot;negated&quot; (target-to-source) propagator is valid.</span>

    <span class="c1"># &quot;Canonical&quot; propagator case.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_implication_true</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="n">edge_valid</span><span class="p">):</span>
        <span class="c1"># If it is statically known that `presence(target) =&gt; edge_valid`,</span>
        <span class="c1"># the propagator is always valid</span>
        <span class="n">source_to_target_propagator_valid</span> <span class="o">=</span> <span class="n">TRUE_LIT</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Given that `presence(source) &amp; presence(target) &lt;=&gt; edge_valid`, we can infer</span>
        <span class="c1"># that the propagator becomes valid (i.e. `presence(target) =&gt; edge_valid` holds)</span>
        <span class="c1"># when `presence(source)` becomes true</span>
        <span class="n">source_to_target_propagator_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

    <span class="c1"># &quot;Negated&quot; propagator case (analogous).</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_implication_true</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="n">edge_valid</span><span class="p">):</span>
        <span class="n">target_to_source_propagator_valid</span> <span class="o">=</span> <span class="n">TRUE_LIT</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target_to_source_propagator_valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

    <span class="n">propagators</span> <span class="o">=</span> <span class="p">[</span>

        <span class="c1"># &quot;canonical&quot; (i.e. &quot;normal&quot;) edge: active &lt;=&gt; source ---(weight)---&gt; target</span>
        <span class="p">(</span><span class="n">SignedVar</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">SignedVar</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">BoundVal</span><span class="p">(</span><span class="n">weight</span><span class="p">),</span>
        <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">(</span><span class="n">reification_literal</span><span class="p">,</span> <span class="n">source_to_target_propagator_valid</span><span class="p">)),</span>

        <span class="p">(</span><span class="n">SignedVar</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">SignedVar</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">BoundVal</span><span class="p">(</span><span class="n">weight</span><span class="p">),</span>
        <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">(</span><span class="n">reification_literal</span><span class="p">,</span> <span class="n">target_to_source_propagator_valid</span><span class="p">)),</span>

        <span class="c1"># &quot;negated&quot; (i.e. &quot;inverted&quot;) edge: !active &lt;=&gt; source &lt;----(-weight-1)--- target</span>
        <span class="p">(</span><span class="n">SignedVar</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">SignedVar</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="n">BoundVal</span><span class="p">(</span><span class="o">-</span><span class="n">weight</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">(</span><span class="n">reification_literal</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span> <span class="n">target_to_source_propagator_valid</span><span class="p">)),</span>

        <span class="p">(</span><span class="n">SignedVar</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">SignedVar</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="n">BoundVal</span><span class="p">(</span><span class="o">-</span><span class="n">weight</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">Enabler</span><span class="p">(</span><span class="n">reification_literal</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span> <span class="n">source_to_target_propagator_valid</span><span class="p">)),</span>

    <span class="p">]</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">propagators</span><span class="p">:</span>

        <span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">integration_kind</span><span class="p">)</span> <span class="o">=</span> <span class="n">integrate_propagator_to_database</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">integration_kind</span> <span class="o">==</span> <span class="s2">&quot;ignoring&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">group_id</span><span class="p">]</span><span class="o">.</span><span class="n">enabler</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">continue</span>

        <span class="n">postprocess_propagator_integration_into_database</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">integration_kind</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.on_solver_increment_one_decision_level" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">on_solver_increment_one_decision_level</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h6>


  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">on_solver_increment_one_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">next_unprocessed_solver_event_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.on_solver_backtrack_one_decision_level" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">on_solver_backtrack_one_decision_level</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h6>


  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">on_solver_backtrack_one_decision_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_pending_for_activation</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_dec_lvl</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">ev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">ev</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">[</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">next_unprocessed_solver_event_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">num_events_at_current_decision_level</span>

    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>

        <span class="k">if</span> <span class="n">ev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">propagator_group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">propagator_group_id</span><span class="p">)</span>

            <span class="n">pg_src</span> <span class="o">=</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span>
            <span class="n">pg_tgt</span> <span class="o">=</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">target</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">pg_src</span><span class="p">,</span> <span class="n">pg_tgt</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span>
                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span><span class="p">[(</span><span class="n">pg_src</span><span class="p">,</span> <span class="n">pg_tgt</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators_source_and_target</span><span class="p">[(</span><span class="n">pg_src</span><span class="p">,</span> <span class="n">pg_tgt</span><span class="p">)]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="c1"># NOTE: no need to reset/update self.constraints_database.next_new_constraint_index !</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">enabler</span><span class="p">)</span> <span class="o">=</span> <span class="n">ev</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">watchlists</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">enabler</span><span class="p">),</span> <span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">watchlists</span><span class="o">.</span><span class="n">remove</span><span class="p">((</span><span class="n">propagator_group_id</span><span class="p">,</span> <span class="n">enabler</span><span class="p">),</span> <span class="n">enabler</span><span class="o">.</span><span class="n">valid</span><span class="p">)</span>
            <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="p">[</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagator_groups_events_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.propagate" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">propagate</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>TODO</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TODO</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_propagate</span><span class="p">((</span><span class="s2">&quot;bounds&quot;</span><span class="p">,))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.run_propagation_loop" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">run_propagation_loop</span><span class="p">(</span><span class="n">original</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">cycle_on_update</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>TODO: ...Incremental Bellman-Ford...</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span>
<span class="normal">1115</span>
<span class="normal">1116</span>
<span class="normal">1117</span>
<span class="normal">1118</span>
<span class="normal">1119</span>
<span class="normal">1120</span>
<span class="normal">1121</span></pre></div></td><td class="code"><div><pre><span></span><code>    <span class="k">def</span> <span class="nf">run_propagation_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">original</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">cycle_on_update</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: ...Incremental Bellman-Ford...</span>
<span class="sd">        &quot;&quot;&quot;</span>

<span class="c1">#        self.num_propagations += 1</span>

        <span class="k">for</span> <span class="n">vb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">vb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">def</span> <span class="nf">extract_cycle</span><span class="p">(</span>
            <span class="n">vb</span><span class="p">:</span> <span class="n">SignedVar</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Lit</span><span class="p">,</span><span class="o">...</span><span class="p">]:</span>

            <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">vb</span>
            <span class="n">cycle_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>

                <span class="n">ev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">first_event_entailing</span><span class="p">(</span><span class="n">Lit</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">ev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">assert</span> <span class="n">ev</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span>

<span class="c1">#                if not (isinstance(ev.cause, SolverCauses.ReasonerInference)</span>
<span class="c1">#                    and isinstance(ev.cause.inference_info, DiffReasoner.InferenceCauses.EdgePropagation)</span>
<span class="c1">#                ):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">cause</span><span class="p">,</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ev</span><span class="o">.</span><span class="n">cause</span><span class="o">.</span><span class="n">inference_info</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">EdgeProp</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">assert</span> <span class="kc">False</span>

                <span class="n">edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">ev</span><span class="o">.</span><span class="n">cause</span><span class="o">.</span><span class="n">inference_info</span><span class="o">.</span><span class="n">propagator_group_id</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">edge</span><span class="o">.</span><span class="n">enabler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="kc">False</span>
                <span class="n">curr</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">source</span>
                <span class="n">cycle_length</span> <span class="o">+=</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span>

                <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
                <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">edge</span><span class="o">.</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">curr</span> <span class="o">==</span> <span class="n">vb</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">)</span>

        <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">source_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

            <span class="c1"># If the bound was already updated, ignore and move on to next</span>
            <span class="k">if</span> <span class="n">source</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Remove immediately even if we are not done with the update yet.</span>
            <span class="c1"># This allows to keep the `internal_pending_bounds_to_update_queue`</span>
            <span class="c1"># and `pending_bounds_to_update` in sync: if an element is</span>
            <span class="c1"># in `pending_bounds_to_update`, then it is also in `internal_pending_bounds_to_update_queue`.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">weight</span><span class="p">,</span> <span class="n">group_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">[</span><span class="n">source</span><span class="p">]:</span>
                <span class="k">assert</span> <span class="n">source</span> <span class="o">!=</span> <span class="n">target</span>

                <span class="n">candidate</span> <span class="o">=</span> <span class="n">BoundVal</span><span class="p">(</span><span class="n">source_bound</span> <span class="o">+</span> <span class="n">weight</span><span class="p">)</span>
                <span class="n">inference_info</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">EdgeProp</span><span class="p">(</span><span class="n">group_id</span><span class="p">)</span>

                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_bound_value</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
                                                 <span class="n">candidate</span><span class="p">,</span>
                                                 <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">inference_info</span><span class="p">))</span>

                <span class="k">match</span> <span class="n">res</span><span class="p">:</span>

                    <span class="k">case</span> <span class="n">InvalidBoundUpdateInfo</span><span class="p">():</span>
                        <span class="k">return</span> <span class="n">res</span>

                    <span class="n">case</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1">#                    self.num_distance_updates += 1</span>
                        <span class="k">if</span> <span class="n">cycle_on_update</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">==</span> <span class="n">original</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">ReasonerBaseExplanation</span><span class="p">(</span><span class="n">extract_cycle</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">internal_pending_bounds_to_update_queue</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">pending_bounds_to_update</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.theory_propagate_bound" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">theory_propagate_bound</span><span class="p">(</span><span class="n">literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Perform the theory propagation that follows from the addition of a new bound on a variable.</p>
<p>A bound on X indicates a shortest path O -&gt; X in an STN (where 0 is a virtual timepoint that
represents the time origin in the STN). For any timepoint Y we also know the length of the
shortest path Y -&gt; 0 (value of the symmetric bound / bound of the opposite signed variable).
Thus, we check that for each potential edge X -&gt; Y that it would not create a negative
cycle 0 -&gt; X -&gt; Y -&gt; O. If that's the case, we disable this X -&gt; Y edge by setting its
enabler (or rather its <code>active</code> literal) to false.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span>
<span class="normal">1180</span>
<span class="normal">1181</span>
<span class="normal">1182</span>
<span class="normal">1183</span>
<span class="normal">1184</span>
<span class="normal">1185</span>
<span class="normal">1186</span>
<span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">theory_propagate_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform the theory propagation that follows from the addition of a new bound on a variable.</span>

<span class="sd">    A bound on X indicates a shortest path O -&gt; X in an STN (where 0 is a virtual timepoint that</span>
<span class="sd">    represents the time origin in the STN). For any timepoint Y we also know the length of the</span>
<span class="sd">    shortest path Y -&gt; 0 (value of the symmetric bound / bound of the opposite signed variable).</span>
<span class="sd">    Thus, we check that for each potential edge X -&gt; Y that it would not create a negative</span>
<span class="sd">    cycle 0 -&gt; X -&gt; Y -&gt; O. If that&#39;s the case, we disable this X -&gt; Y edge by setting its</span>
<span class="sd">    enabler (or rather its `active` literal) to false.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">potential_out_edges</span><span class="p">(</span>
        <span class="n">src</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">Lit</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">dist_to_origin</span><span class="p">(</span>
        <span class="n">lit</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BoundVal</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lit</span><span class="o">.</span><span class="n">bound_value</span> <span class="c1">#REVIEW</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">literal</span><span class="o">.</span><span class="n">signed_var</span>
    <span class="n">dist_o_x</span> <span class="o">=</span> <span class="n">dist_to_origin</span><span class="p">(</span><span class="n">literal</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">out_target</span><span class="p">,</span> <span class="n">out_weight</span><span class="p">,</span> <span class="n">out_presence</span> <span class="ow">in</span> <span class="n">potential_out_edges</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">out_presence</span><span class="o">.</span><span class="n">negated</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">y</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">out_target</span><span class="p">,</span> <span class="n">out_weight</span>
        <span class="n">y_neg_lit</span> <span class="o">=</span> <span class="n">Lit</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">opposite</span><span class="p">))</span>
        <span class="n">dist_y_o</span> <span class="o">=</span> <span class="n">dist_to_origin</span><span class="p">(</span><span class="n">y_neg_lit</span><span class="p">)</span>

        <span class="n">cycle_length</span> <span class="o">=</span> <span class="n">dist_o_x</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">dist_y_o</span>

        <span class="k">if</span> <span class="n">cycle_length</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># If 0 -&gt; X -&gt; Y -&gt; 0 forms a negative cycle, there is a contradiction and</span>
        <span class="c1"># we record its cause so we can retrieve it if an explanation is needed.</span>
        <span class="c1"># Here, we know that the update on the bound value of `literal`&#39;s variable</span>
        <span class="c1"># triggered the propagation. However, it is possible that a less constraint</span>
        <span class="c1"># bound would have triggered the propagation as well. We thus replace `literal`</span>
        <span class="c1"># with the smallest update that would have triggered the propagation.</span>
        <span class="c1"># The consequence is that the clauses inferred through explanation will be stronger.</span>
        <span class="n">relaxed_literal</span> <span class="o">=</span> <span class="n">Lit</span><span class="p">(</span><span class="n">literal</span><span class="o">.</span><span class="n">signed_var</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">(</span><span class="n">literal</span><span class="o">.</span><span class="n">bound_value</span> <span class="o">-</span> <span class="n">cycle_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># The relaxed literal would have triggered a proapgation with the cycle having exactly length -1</span>
        <span class="k">assert</span> <span class="n">dist_to_origin</span><span class="p">(</span><span class="n">relaxed_literal</span><span class="p">)</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="n">dist_y_o</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Bounds</span><span class="p">(</span><span class="n">relaxed_literal</span><span class="p">,</span> <span class="n">y_neg_lit</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Disable the edge</span>

        <span class="n">inference_info</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">TheoryProp</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_literal</span><span class="p">(</span><span class="n">out_presence</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span>
                               <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">inference_info</span><span class="p">))</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.theory_propagate_edge" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">theory_propagate_edge</span><span class="p">(</span><span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">PropaGroupId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Perform the theory propagation that follows
from the addition of the given (new) edge.</p>
<p>In essence, we find all shortest paths A -&gt; B that contain the new edge.
Then we check if there exist an inactive edge BA where <code>weight(BA) + dist(AB) &lt; 0</code>.
For each such edge, we set its enabler to false
since its addition would result in a negative cycle.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span>
<span class="normal">1238</span>
<span class="normal">1239</span>
<span class="normal">1240</span>
<span class="normal">1241</span>
<span class="normal">1242</span>
<span class="normal">1243</span>
<span class="normal">1244</span>
<span class="normal">1245</span>
<span class="normal">1246</span>
<span class="normal">1247</span>
<span class="normal">1248</span>
<span class="normal">1249</span>
<span class="normal">1250</span>
<span class="normal">1251</span>
<span class="normal">1252</span>
<span class="normal">1253</span>
<span class="normal">1254</span>
<span class="normal">1255</span>
<span class="normal">1256</span>
<span class="normal">1257</span>
<span class="normal">1258</span>
<span class="normal">1259</span>
<span class="normal">1260</span>
<span class="normal">1261</span>
<span class="normal">1262</span>
<span class="normal">1263</span>
<span class="normal">1264</span>
<span class="normal">1265</span>
<span class="normal">1266</span>
<span class="normal">1267</span>
<span class="normal">1268</span>
<span class="normal">1269</span>
<span class="normal">1270</span>
<span class="normal">1271</span>
<span class="normal">1272</span>
<span class="normal">1273</span>
<span class="normal">1274</span>
<span class="normal">1275</span>
<span class="normal">1276</span>
<span class="normal">1277</span>
<span class="normal">1278</span>
<span class="normal">1279</span>
<span class="normal">1280</span>
<span class="normal">1281</span>
<span class="normal">1282</span>
<span class="normal">1283</span>
<span class="normal">1284</span>
<span class="normal">1285</span>
<span class="normal">1286</span>
<span class="normal">1287</span>
<span class="normal">1288</span>
<span class="normal">1289</span>
<span class="normal">1290</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">theory_propagate_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">PropaGroupId</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">InvalidBoundUpdateInfo</span> <span class="o">|</span> <span class="n">ReasonerBaseExplanation</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform the theory propagation that follows</span>
<span class="sd">    from the addition of the given (new) edge.</span>

<span class="sd">    In essence, we find all shortest paths A -&gt; B that contain the new edge.</span>
<span class="sd">    Then we check if there exist an inactive edge BA where `weight(BA) + dist(AB) &lt; 0`.</span>
<span class="sd">    For each such edge, we set its enabler to false</span>
<span class="sd">    since its addition would result in a negative cycle.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">potential_out_edges</span><span class="p">(</span>
        <span class="n">src</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">SignedVar</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">,</span> <span class="n">Lit</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">intermittent_propagators</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">source</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">edge</span><span class="o">.</span><span class="n">target</span>

    <span class="n">successors</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">()</span>
    <span class="n">predecessors</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">()</span>

    <span class="c1"># Find all nodes reachable from target(edge), including itself</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">distances_from</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">successors</span><span class="p">)</span>

    <span class="c1"># Find all nodes that can reach source(edge), including itself</span>
    <span class="c1"># predecessors nodes and edge are in the inverse direction.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">distances_from</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">predecessors</span><span class="p">)</span>

    <span class="c1"># Iterate through all predecessors, they will constitute the source of our shortest paths</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">pred_dist</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span> <span class="ow">in</span> <span class="n">predecessors</span><span class="o">.</span><span class="n">reached_nodes</span><span class="p">():</span>

        <span class="c1"># Find all potential edges that target this predecessor.</span>
        <span class="c1"># Note that the predecessor is the inverse view (opposite signed variable),</span>
        <span class="c1"># hence the potential out_edge are all inverse edges.</span>
        <span class="k">for</span> <span class="n">potential_target</span><span class="p">,</span> <span class="n">potential_weight</span><span class="p">,</span> <span class="n">potential_presence</span> <span class="ow">in</span> <span class="n">potential_out_edges</span><span class="p">(</span><span class="n">pred</span><span class="p">):</span>

            <span class="c1"># potential is an edge W -&gt; pred. Do we have X in the succesors ?</span>
            <span class="n">forward_dist</span> <span class="o">=</span> <span class="n">successors</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">potential_target</span><span class="o">.</span><span class="n">opposite</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">forward_dist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">back_dist</span> <span class="o">=</span> <span class="n">pred_dist</span> <span class="o">+</span> <span class="n">potential_weight</span>
            <span class="n">total_dist</span> <span class="o">=</span> <span class="n">back_dist</span> <span class="o">+</span> <span class="n">edge</span><span class="o">.</span><span class="n">weight</span> <span class="o">+</span> <span class="n">forward_dist</span>

            <span class="c1"># If this edge would be violated and is not inactive yet:</span>
            <span class="k">if</span> <span class="n">total_dist</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">potential_presence</span><span class="o">.</span><span class="n">negated</span><span class="p">):</span>

                <span class="c1"># careful: we are doing batched eager updates involving optional variable</span>
                <span class="c1"># When doing the shortest path computation, we followed any edge that was</span>
                <span class="c1"># not proven inactive yet. The current theory propagation, might have been</span>
                <span class="c1"># preceded by an other affecting the network. Here we thus check that </span>
                <span class="c1"># path we initially computed is still active, i.e., that no other propagation</span>
                <span class="c1"># made any of its edges inactive. This is necessary because we need to</span>
                <span class="c1"># be able to explain any change and explanation would not follow</span>
                <span class="c1"># any inactive edge when recreating the path.</span>
                <span class="n">active</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">will_get_theory_propagation_path_succeed</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span>
                                                                       <span class="n">potential_target</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span>
                                                                       <span class="n">propagator_group_id</span><span class="p">,</span>
                                                                       <span class="n">successors</span><span class="p">,</span>
                                                                       <span class="n">predecessors</span><span class="p">)</span>

                <span class="c1"># If the shortest path would be made inactive, ignore this update</span>
                <span class="c1"># Note that on a valid constraint network, making this change should be</span>
                <span class="c1"># either a noop or redundant with another constraint.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Record the cause so we can explain the</span>
                <span class="c1"># changes resulting from making the edge inactive.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span>
                                                                                         <span class="n">potential_target</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span>
                                                                                         <span class="n">propagator_group_id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

                <span class="c1"># Update to force this edge to be inactive</span>

                <span class="n">inference_info</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">TheoryProp</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">set_literal</span><span class="p">(</span><span class="n">potential_presence</span><span class="o">.</span><span class="n">negated</span><span class="p">,</span>
                                             <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">inference_info</span><span class="p">))</span>

                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">InvalidBoundUpdateInfo</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">res</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.explain" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">explain</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">inference_cause</span><span class="p">:</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h6>


  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1296</span>
<span class="normal">1297</span>
<span class="normal">1298</span>
<span class="normal">1299</span>
<span class="normal">1300</span>
<span class="normal">1301</span>
<span class="normal">1302</span>
<span class="normal">1303</span>
<span class="normal">1304</span>
<span class="normal">1305</span>
<span class="normal">1306</span>
<span class="normal">1307</span>
<span class="normal">1308</span>
<span class="normal">1309</span>
<span class="normal">1310</span>
<span class="normal">1311</span>
<span class="normal">1312</span>
<span class="normal">1313</span>
<span class="normal">1314</span>
<span class="normal">1315</span>
<span class="normal">1316</span>
<span class="normal">1317</span>
<span class="normal">1318</span>
<span class="normal">1319</span>
<span class="normal">1320</span>
<span class="normal">1321</span>
<span class="normal">1322</span>
<span class="normal">1323</span>
<span class="normal">1324</span>
<span class="normal">1325</span>
<span class="normal">1326</span>
<span class="normal">1327</span>
<span class="normal">1328</span>
<span class="normal">1329</span>
<span class="normal">1330</span>
<span class="normal">1331</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">explain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span>
    <span class="n">literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
    <span class="n">inference_cause</span><span class="p">:</span> <span class="n">Causes</span><span class="o">.</span><span class="n">ReasonerInference</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inference_cause</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">EdgeProp</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explain_bound_propagation</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">,</span>
                                       <span class="n">literal</span><span class="p">,</span>
                                       <span class="n">inference_cause</span><span class="o">.</span><span class="n">propagator_group_id</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inference_cause</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">InferenceCauses</span><span class="o">.</span><span class="n">TheoryProp</span><span class="p">):</span>
        <span class="n">theory_propagation_cause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">[</span><span class="n">inference_cause</span><span class="o">.</span><span class="n">theory_propagation_cause_index</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">theory_propagation_cause</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>
            <span class="c1"># We need to replace ourselves in exactly the context</span>
            <span class="c1"># in which this theory propagation occurred.</span>
            <span class="c1"># Undo all events until we are back in the state</span>
            <span class="c1"># where this theory propagation cause had not occurred yet.</span>
            <span class="c1"># FIXME: KNOWN PROBLEM: this prevents the explanation of arbitrary literals which is required by some heuristics (e.g. LRB)</span>
            <span class="k">while</span> <span class="n">inference_cause</span><span class="o">.</span><span class="n">theory_propagation_cause_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="p">):</span>
                <span class="c1"># get an event to undo</span>
                <span class="n">propagator_group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagation_metadata_trail</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">decision_level</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

                <span class="c1"># NOTE: this is copied from `on_solver_backtrack_one_level`</span>
                <span class="k">if</span> <span class="n">propagator_group_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">theory_propagation_causes</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">[</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">explain_theory_propagation</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">,</span> <span class="n">theory_propagation_cause</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.explain_bound_propagation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">explain_bound_propagation</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span> <span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">deep_explanation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h6>


  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1335</span>
<span class="normal">1336</span>
<span class="normal">1337</span>
<span class="normal">1338</span>
<span class="normal">1339</span>
<span class="normal">1340</span>
<span class="normal">1341</span>
<span class="normal">1342</span>
<span class="normal">1343</span>
<span class="normal">1344</span>
<span class="normal">1345</span>
<span class="normal">1346</span>
<span class="normal">1347</span>
<span class="normal">1348</span>
<span class="normal">1349</span>
<span class="normal">1350</span>
<span class="normal">1351</span>
<span class="normal">1352</span>
<span class="normal">1353</span>
<span class="normal">1354</span>
<span class="normal">1355</span>
<span class="normal">1356</span>
<span class="normal">1357</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">explain_bound_propagation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span>
    <span class="n">literal</span><span class="p">:</span> <span class="n">Lit</span><span class="p">,</span>
    <span class="n">propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span>
    <span class="n">deep_explanation</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="n">propagator_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">propagator_group_id</span><span class="p">]</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">literal</span><span class="o">.</span><span class="n">bound_value</span>

    <span class="n">enabler</span> <span class="o">=</span> <span class="n">propagator_group</span><span class="o">.</span><span class="n">enabler</span>

    <span class="k">assert</span> <span class="n">enabler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
    <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">))</span>

    <span class="n">cause_lit</span> <span class="o">=</span> <span class="n">Lit</span><span class="p">(</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">(</span><span class="n">val</span><span class="o">-</span><span class="n">propagator_group</span><span class="o">.</span><span class="n">weight</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">deep_explanation</span><span class="p">:</span>
        <span class="k">pass</span>    <span class="c1"># TODO</span>

    <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cause_lit</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.explain_theory_propagation" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">explain_theory_propagation</span><span class="p">(</span><span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span> <span class="n">cause</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">AnyCause</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h6>


  <div class="doc doc-contents ">

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1361</span>
<span class="normal">1362</span>
<span class="normal">1363</span>
<span class="normal">1364</span>
<span class="normal">1365</span>
<span class="normal">1366</span>
<span class="normal">1367</span>
<span class="normal">1368</span>
<span class="normal">1369</span>
<span class="normal">1370</span>
<span class="normal">1371</span>
<span class="normal">1372</span>
<span class="normal">1373</span>
<span class="normal">1374</span>
<span class="normal">1375</span>
<span class="normal">1376</span>
<span class="normal">1377</span>
<span class="normal">1378</span>
<span class="normal">1379</span>
<span class="normal">1380</span>
<span class="normal">1381</span>
<span class="normal">1382</span>
<span class="normal">1383</span>
<span class="normal">1384</span>
<span class="normal">1385</span>
<span class="normal">1386</span>
<span class="normal">1387</span>
<span class="normal">1388</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">explain_theory_propagation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">explanation_literals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Lit</span><span class="p">],</span>
    <span class="n">cause</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">AnyCause</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cause</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Path</span><span class="p">):</span>

        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_theory_propagation_path</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                                                <span class="n">cause</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                                <span class="n">cause</span><span class="o">.</span><span class="n">triggering_propagator_group_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">enabler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">enabler</span>

            <span class="k">assert</span> <span class="n">enabler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="p">)</span>
            <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">enabler</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">signed_var</span><span class="o">.</span><span class="n">var</span><span class="p">))</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cause</span><span class="p">,</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">TheoryPropCauses</span><span class="o">.</span><span class="n">Bounds</span><span class="p">):</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">source_lit</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">target_lit</span><span class="p">)</span>

        <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">source_lit</span><span class="p">)</span>
        <span class="n">explanation_literals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cause</span><span class="o">.</span><span class="n">target_lit</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.get_theory_propagation_path" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_theory_propagation_path</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">through_propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Returns a (shortest) path that triggered a theory propagation from <code>source</code>
to <code>target</code>, through the edge corresponding to <code>through_propagator_group_id</code>.</p>
<p>Getting this path is needed for explanations, to explain the contradiction
encountered as a result of theory propagation triggered by the activation of 
the edge corresponding to <code>through_propagator_group_id</code>. The path resulting
from propagation would be conflicting with an edge from <code>target</code> to <code>source</code>,
as it would have formed a negative cycle if activated.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1394</span>
<span class="normal">1395</span>
<span class="normal">1396</span>
<span class="normal">1397</span>
<span class="normal">1398</span>
<span class="normal">1399</span>
<span class="normal">1400</span>
<span class="normal">1401</span>
<span class="normal">1402</span>
<span class="normal">1403</span>
<span class="normal">1404</span>
<span class="normal">1405</span>
<span class="normal">1406</span>
<span class="normal">1407</span>
<span class="normal">1408</span>
<span class="normal">1409</span>
<span class="normal">1410</span>
<span class="normal">1411</span>
<span class="normal">1412</span>
<span class="normal">1413</span>
<span class="normal">1414</span>
<span class="normal">1415</span>
<span class="normal">1416</span>
<span class="normal">1417</span>
<span class="normal">1418</span>
<span class="normal">1419</span>
<span class="normal">1420</span>
<span class="normal">1421</span>
<span class="normal">1422</span>
<span class="normal">1423</span>
<span class="normal">1424</span>
<span class="normal">1425</span>
<span class="normal">1426</span>
<span class="normal">1427</span>
<span class="normal">1428</span>
<span class="normal">1429</span>
<span class="normal">1430</span>
<span class="normal">1431</span>
<span class="normal">1432</span>
<span class="normal">1433</span>
<span class="normal">1434</span>
<span class="normal">1435</span>
<span class="normal">1436</span>
<span class="normal">1437</span>
<span class="normal">1438</span>
<span class="normal">1439</span>
<span class="normal">1440</span>
<span class="normal">1441</span>
<span class="normal">1442</span>
<span class="normal">1443</span>
<span class="normal">1444</span>
<span class="normal">1445</span>
<span class="normal">1446</span>
<span class="normal">1447</span>
<span class="normal">1448</span>
<span class="normal">1449</span>
<span class="normal">1450</span>
<span class="normal">1451</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_theory_propagation_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="n">through_propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a (shortest) path that triggered a theory propagation from `source`</span>
<span class="sd">    to `target`, through the edge corresponding to `through_propagator_group_id`.</span>

<span class="sd">    Getting this path is needed for explanations, to explain the contradiction</span>
<span class="sd">    encountered as a result of theory propagation triggered by the activation of </span>
<span class="sd">    the edge corresponding to `through_propagator_group_id`. The path resulting</span>
<span class="sd">    from propagation would be conflicting with an edge from `target` to `source`,</span>
<span class="sd">    as it would have formed a negative cycle if activated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="k">def</span> <span class="nf">shortest_path_from_to</span><span class="p">(</span>
        <span class="n">from_</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">to</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
        <span class="n">dijkstra_state</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">,</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">from_</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Run Dijkstra until exhaustion to find all reachable nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_dijkstra</span><span class="p">(</span><span class="n">dijkstra_state</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">curr</span><span class="p">:</span> <span class="n">curr</span> <span class="o">==</span> <span class="n">to</span><span class="p">)</span>

        <span class="c1"># Go up the predecessors chain to extract the shortest path and append the edge to `out`.</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">to</span>
        <span class="k">while</span> <span class="n">curr</span> <span class="o">!=</span> <span class="n">from_</span><span class="p">:</span>
            <span class="n">edge</span> <span class="o">=</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">predecessor</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>

            <span class="k">assert</span> <span class="n">edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">target</span> <span class="o">==</span> <span class="n">curr</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span><span class="o">.</span><span class="n">source</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">through_propagator_group_id</span><span class="p">]</span>
    <span class="n">dijkstra_state</span> <span class="o">=</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">()</span>

    <span class="c1"># Add `e.source -&gt; e.target` edge to path</span>
    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">through_propagator_group_id</span><span class="p">)</span>

    <span class="c1"># Add `e.target -&gt; target` subpath to path</span>
    <span class="n">shortest_path_from_to</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">dijkstra_state</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="c1"># Add `source -&gt; e.source` subpath to path, computed in th reverse direction.</span>
    <span class="n">shortest_path_from_to</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">dijkstra_state</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">res</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.will_get_theory_propagation_path_succeed" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">will_get_theory_propagation_path_succeed</span><span class="p">(</span><span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">through_propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span> <span class="n">successors</span><span class="p">:</span> <span class="n">DijkstraState</span><span class="p">,</span> <span class="n">predecessors</span><span class="p">:</span> <span class="n">DijkstraState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>This method checks whether the <code>get_theory_propagation_path</code>
method would be able to find a path for explaining a theory propagation.</p>
<p>For efficiency reasons, we do not run the dijkstra algorithm.
Instead we accept two prefilled Dijkstra state:
- <code>successors</code>: one-to-all distances from <code>through_edge.target</code>
- <code>predecessors</code>: one-to-all distances from <code>through_edge.source.opposite_signed_var</code>
Complexity is linear in the length of the path to check.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1455</span>
<span class="normal">1456</span>
<span class="normal">1457</span>
<span class="normal">1458</span>
<span class="normal">1459</span>
<span class="normal">1460</span>
<span class="normal">1461</span>
<span class="normal">1462</span>
<span class="normal">1463</span>
<span class="normal">1464</span>
<span class="normal">1465</span>
<span class="normal">1466</span>
<span class="normal">1467</span>
<span class="normal">1468</span>
<span class="normal">1469</span>
<span class="normal">1470</span>
<span class="normal">1471</span>
<span class="normal">1472</span>
<span class="normal">1473</span>
<span class="normal">1474</span>
<span class="normal">1475</span>
<span class="normal">1476</span>
<span class="normal">1477</span>
<span class="normal">1478</span>
<span class="normal">1479</span>
<span class="normal">1480</span>
<span class="normal">1481</span>
<span class="normal">1482</span>
<span class="normal">1483</span>
<span class="normal">1484</span>
<span class="normal">1485</span>
<span class="normal">1486</span>
<span class="normal">1487</span>
<span class="normal">1488</span>
<span class="normal">1489</span>
<span class="normal">1490</span>
<span class="normal">1491</span>
<span class="normal">1492</span>
<span class="normal">1493</span>
<span class="normal">1494</span>
<span class="normal">1495</span>
<span class="normal">1496</span>
<span class="normal">1497</span>
<span class="normal">1498</span>
<span class="normal">1499</span>
<span class="normal">1500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">will_get_theory_propagation_path_succeed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">source</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="n">target</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="n">through_propagator_group_id</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">PropaGroupId</span><span class="p">,</span>
    <span class="n">successors</span><span class="p">:</span> <span class="n">DijkstraState</span><span class="p">,</span>
    <span class="n">predecessors</span><span class="p">:</span> <span class="n">DijkstraState</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method checks whether the `get_theory_propagation_path`</span>
<span class="sd">    method would be able to find a path for explaining a theory propagation.</span>

<span class="sd">    For efficiency reasons, we do not run the dijkstra algorithm.</span>
<span class="sd">    Instead we accept two prefilled Dijkstra state:</span>
<span class="sd">    - `successors`: one-to-all distances from `through_edge.target`</span>
<span class="sd">    - `predecessors`: one-to-all distances from `through_edge.source.opposite_signed_var`</span>
<span class="sd">    Complexity is linear in the length of the path to check.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="c1"># A path is active (i.e. findable by Dijkstra) if all nodes in it are not shown absent</span>
    <span class="c1"># We assume that the edges themselves are active (since it cannot be made inactive once activated).</span>
    <span class="k">def</span> <span class="nf">path_active</span><span class="p">(</span><span class="n">src</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">tgt</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">dij</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">):</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">tgt</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">negated</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="n">curr</span> <span class="o">!=</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">pred_edge</span> <span class="o">=</span> <span class="n">dij</span><span class="o">.</span><span class="n">predecessor</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">pred_edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">ee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">pred_edge</span><span class="p">]</span>
            <span class="n">curr</span> <span class="o">=</span> <span class="n">ee</span><span class="o">.</span><span class="n">source</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">curr</span><span class="o">.</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">negated</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #</span>

    <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_database</span><span class="o">.</span><span class="n">propagators</span><span class="p">[</span><span class="n">through_propagator_group_id</span><span class="p">]</span>

    <span class="c1"># The path is active if both its prefix and its postfix are active</span>
    <span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">path_active</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">successors</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">path_active</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">opposite</span><span class="p">,</span> <span class="n">predecessors</span><span class="p">))</span>

    <span class="c1"># REVIEW assert not active or self.get_theory_propagation_path(source, target, through_propagator_group_id, solver)</span>

    <span class="k">return</span> <span class="n">active</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.run_dijkstra" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">run_dijkstra</span><span class="p">(</span><span class="n">dijkstra_state</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">,</span> <span class="n">stop_condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">SignedVar</span><span class="p">],</span> <span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Run the Dijkstra algorithm from a pre-initialized queue.
The queue should initially contain the origin of the shortest path problem.
The algorithm will once the queue is exhausted or the predicate <code>stop_condition</code>
returns true when given the next node to expand.</p>
<p>At the end of the method, the <code>dijkstra_state</code> will contain the distances
and predecessors of all nodes reached by the algorithm.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1504</span>
<span class="normal">1505</span>
<span class="normal">1506</span>
<span class="normal">1507</span>
<span class="normal">1508</span>
<span class="normal">1509</span>
<span class="normal">1510</span>
<span class="normal">1511</span>
<span class="normal">1512</span>
<span class="normal">1513</span>
<span class="normal">1514</span>
<span class="normal">1515</span>
<span class="normal">1516</span>
<span class="normal">1517</span>
<span class="normal">1518</span>
<span class="normal">1519</span>
<span class="normal">1520</span>
<span class="normal">1521</span>
<span class="normal">1522</span>
<span class="normal">1523</span>
<span class="normal">1524</span>
<span class="normal">1525</span>
<span class="normal">1526</span>
<span class="normal">1527</span>
<span class="normal">1528</span>
<span class="normal">1529</span>
<span class="normal">1530</span>
<span class="normal">1531</span>
<span class="normal">1532</span>
<span class="normal">1533</span>
<span class="normal">1534</span>
<span class="normal">1535</span>
<span class="normal">1536</span>
<span class="normal">1537</span>
<span class="normal">1538</span>
<span class="normal">1539</span>
<span class="normal">1540</span>
<span class="normal">1541</span>
<span class="normal">1542</span>
<span class="normal">1543</span>
<span class="normal">1544</span>
<span class="normal">1545</span>
<span class="normal">1546</span>
<span class="normal">1547</span>
<span class="normal">1548</span>
<span class="normal">1549</span>
<span class="normal">1550</span>
<span class="normal">1551</span>
<span class="normal">1552</span>
<span class="normal">1553</span>
<span class="normal">1554</span>
<span class="normal">1555</span>
<span class="normal">1556</span>
<span class="normal">1557</span>
<span class="normal">1558</span>
<span class="normal">1559</span>
<span class="normal">1560</span>
<span class="normal">1561</span>
<span class="normal">1562</span>
<span class="normal">1563</span>
<span class="normal">1564</span>
<span class="normal">1565</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">run_dijkstra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">dijkstra_state</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">,</span>
    <span class="n">stop_condition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">SignedVar</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the Dijkstra algorithm from a pre-initialized queue.</span>
<span class="sd">    The queue should initially contain the origin of the shortest path problem.</span>
<span class="sd">    The algorithm will once the queue is exhausted or the predicate `stop_condition`</span>
<span class="sd">    returns true when given the next node to expand.</span>

<span class="sd">    At the end of the method, the `dijkstra_state` will contain the distances</span>
<span class="sd">    and predecessors of all nodes reached by the algorithm.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">while</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>

        <span class="n">curr</span> <span class="o">=</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">dequeue</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">curr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">curr_rdist</span><span class="p">,</span> <span class="n">curr_node</span> <span class="o">=</span> <span class="n">curr</span>

        <span class="k">if</span> <span class="n">stop_condition</span><span class="p">(</span><span class="n">curr_node</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">curr_node</span><span class="o">.</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">negated</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">curr_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">curr_node</span><span class="p">)</span>

        <span class="c1"># Process all outgoing edges</span>
        <span class="k">if</span> <span class="n">curr_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">prop_target</span><span class="p">,</span> <span class="n">prop_weight</span><span class="p">,</span> <span class="n">prop_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagators_active</span><span class="p">[</span><span class="n">curr_node</span><span class="p">]:</span>

            <span class="c1"># TODO: here we check that the target is present and thus that all nodes in the path are present.</span>
            <span class="c1"># This is correct but overly pessimistic/</span>
            <span class="c1"># In theory, it would be sufficient to check that presence(...) is not entailed.</span>
            <span class="c1"># However this dijkstra is used in both forward and backward mode, starting from the negated node</span>
            <span class="c1"># for backward traversal.</span>
            <span class="c1"># The condition checking for the presence of prop_target.var to be entailed ensure</span>
            <span class="c1"># that if there is an edge `a -&gt; b` then there is an (-b) -&gt; (-a)` that can be used for backward traversal.</span>
            <span class="c1"># To properly fix this, we should index the active propagators backward and make this dijkstra pass</span>
            <span class="c1"># aware of whether it is traversing backward or forward.</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">is_final</span><span class="p">(</span><span class="n">prop_target</span><span class="p">)</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_entailed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">presence_literal_of</span><span class="p">(</span><span class="n">prop_target</span><span class="o">.</span><span class="n">var</span><span class="p">))</span>
            <span class="p">):</span>

                <span class="c1"># We do not have a shortest path to this node yet, so compute a the reduced cost of the edge.</span>

                <span class="n">target_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">prop_target</span><span class="p">)</span>
                <span class="n">cost</span> <span class="o">=</span> <span class="n">prop_weight</span>

                <span class="n">reduced_cost</span> <span class="o">=</span> <span class="n">cost</span> <span class="o">+</span> <span class="p">(</span><span class="n">curr_bound</span> <span class="o">-</span> <span class="n">target_bound</span><span class="p">)</span>   <span class="c1"># rcost(curr, tgt) = cost(curr, tgt) + val(curr) - val(tgt)</span>
                <span class="k">assert</span> <span class="n">reduced_cost</span> <span class="o">&gt;=</span> <span class="mi">0</span>

                <span class="n">reduced_dist</span> <span class="o">=</span> <span class="n">curr_rdist</span> <span class="o">+</span> <span class="n">reduced_cost</span>    <span class="c1"># rdist(orig, tgt) = dist(orig, tgt) + val(tgt) - val(orig)</span>
                                                            <span class="c1">#                  = dist(orig, curr) + cost(curr, tgt) + val(tgt) - val(orig)</span>
                                                            <span class="c1">#                  = [rdist(orig, curr) + val(orig) - val(curr)] + [rcost(curr, tgt) - val(tgt) + val(curr)] + val(tgt) - val(orig)</span>
                                                            <span class="c1">#                  = rdist(orig, curr) + rcost(curr, tgt)</span>
                <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">prop_target</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">(</span><span class="n">reduced_dist</span><span class="p">),</span> <span class="n">prop_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h6 id="src.solver.reasoners.diff_reasoner.DiffReasoner.distances_from" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">distances_from</span><span class="p">(</span><span class="n">origin</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span> <span class="n">dijkstra_state</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span></code>

</h6>


  <div class="doc doc-contents ">
  
      <p>Computes the one-to-all shortest paths in an STN.
The shortest paths are:
- in the forward graph if the origin is the upper bound of a variable
- in the backward graph is the origin is the lower bound of a variable</p>
<p>The functions expects a <code>dijkstra_state</code> parameter that will be
cleared and contains datastructures that will be used to compute the result.
The distances will be set in the <code>distances</code> field of this state.</p>
<p>The distances returned are in the BoundVal format, which is agnostic of whether
we are computing backward or forward distances. The computed distance to a
node <code>A</code> is simply the sum of the edge weights over the shortest path.</p>
<p>Assumptions:</p>
<p>The STN is consistent and fully propagated.</p>
<p>Internals:</p>
<p>To use Dijkstra's algorithm, we need to ensure that all edges are positive.
We do this by using the reduced costs of the edges.
Given a function <code>value(SignedVar)</code> that returns the
current value of a variable bound, we define the <em>reduced distance</em>
<code>red_dist</code> of a path <code>source -- dist --&gt; target</code> as <br />
- <code>red_dist = dist - value(target) + value(source)</code>
- <code>dist = red_dist + value(target) - value(source)</code>
If the STN is fully propagated and consistent, the
reduced distance is guaranteed to always be positive.</p>

          <details class="quote">
            <summary>Source code in <code>src/solver/reasoners/diff_reasoner.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1569</span>
<span class="normal">1570</span>
<span class="normal">1571</span>
<span class="normal">1572</span>
<span class="normal">1573</span>
<span class="normal">1574</span>
<span class="normal">1575</span>
<span class="normal">1576</span>
<span class="normal">1577</span>
<span class="normal">1578</span>
<span class="normal">1579</span>
<span class="normal">1580</span>
<span class="normal">1581</span>
<span class="normal">1582</span>
<span class="normal">1583</span>
<span class="normal">1584</span>
<span class="normal">1585</span>
<span class="normal">1586</span>
<span class="normal">1587</span>
<span class="normal">1588</span>
<span class="normal">1589</span>
<span class="normal">1590</span>
<span class="normal">1591</span>
<span class="normal">1592</span>
<span class="normal">1593</span>
<span class="normal">1594</span>
<span class="normal">1595</span>
<span class="normal">1596</span>
<span class="normal">1597</span>
<span class="normal">1598</span>
<span class="normal">1599</span>
<span class="normal">1600</span>
<span class="normal">1601</span>
<span class="normal">1602</span>
<span class="normal">1603</span>
<span class="normal">1604</span>
<span class="normal">1605</span>
<span class="normal">1606</span>
<span class="normal">1607</span>
<span class="normal">1608</span>
<span class="normal">1609</span>
<span class="normal">1610</span>
<span class="normal">1611</span>
<span class="normal">1612</span>
<span class="normal">1613</span>
<span class="normal">1614</span>
<span class="normal">1615</span>
<span class="normal">1616</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">distances_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
    <span class="n">origin</span><span class="p">:</span> <span class="n">SignedVar</span><span class="p">,</span>
    <span class="n">dijkstra_state</span><span class="p">:</span> <span class="n">DiffReasoner</span><span class="o">.</span><span class="n">DijkstraState</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the one-to-all shortest paths in an STN.</span>
<span class="sd">    The shortest paths are:</span>
<span class="sd">    - in the forward graph if the origin is the upper bound of a variable</span>
<span class="sd">    - in the backward graph is the origin is the lower bound of a variable</span>

<span class="sd">    The functions expects a `dijkstra_state` parameter that will be</span>
<span class="sd">    cleared and contains datastructures that will be used to compute the result.</span>
<span class="sd">    The distances will be set in the `distances` field of this state.</span>

<span class="sd">    The distances returned are in the BoundVal format, which is agnostic of whether</span>
<span class="sd">    we are computing backward or forward distances. The computed distance to a</span>
<span class="sd">    node `A` is simply the sum of the edge weights over the shortest path.</span>

<span class="sd">    Assumptions:</span>

<span class="sd">    The STN is consistent and fully propagated.</span>

<span class="sd">    Internals:</span>

<span class="sd">    To use Dijkstra&#39;s algorithm, we need to ensure that all edges are positive.</span>
<span class="sd">    We do this by using the reduced costs of the edges.</span>
<span class="sd">    Given a function `value(SignedVar)` that returns the</span>
<span class="sd">    current value of a variable bound, we define the *reduced distance*</span>
<span class="sd">    `red_dist` of a path `source -- dist --&gt; target` as   </span>
<span class="sd">    - `red_dist = dist - value(target) + value(source)`</span>
<span class="sd">    - `dist = red_dist + value(target) - value(source)`</span>
<span class="sd">    If the STN is fully propagated and consistent, the</span>
<span class="sd">    reduced distance is guaranteed to always be positive.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">origin_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">BoundVal</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Run Dijkstra until exhaustion to find all reachable nodes</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run_dijkstra</span><span class="p">(</span><span class="n">dijkstra_state</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Convert all reduced distances to true distances.</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">curr_node</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">reached_nodes</span><span class="p">():</span>
        <span class="n">curr_bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">bound_value_of</span><span class="p">(</span><span class="n">curr_node</span><span class="p">)</span>
        <span class="n">true_distance</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">+</span> <span class="p">(</span><span class="n">curr_bound</span> <span class="o">-</span> <span class="n">origin_bound</span><span class="p">)</span>
        <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">curr_node</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">BoundVal</span><span class="p">(</span><span class="n">true_distance</span><span class="p">),</span> <span class="n">dijkstra_state</span><span class="o">.</span><span class="n">distances</span><span class="p">[</span><span class="n">curr_node</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
    
  </body>
</html>